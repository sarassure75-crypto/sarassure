var d=(r,t,c)=>new Promise((n,a)=>{var u=i=>{try{m(c.next(i))}catch(l){a(l)}},o=i=>{try{m(c.throw(i))}catch(l){a(l)}},m=i=>i.done?n(i.value):Promise.resolve(i.value).then(u,o);m((c=c.apply(r,t)).next())});import{j as e}from"./radix-ui-2f58371e.js";import{r as h}from"./react-vendor-6cf6ded9.js";import{s as x,i as P,C as w,k as y,l as E,j as N,w as q,X as T,e as L}from"./index-426aa6f1.js";import{t as b,ba as _}from"./ui-icons-e73ce4f7.js";const F=()=>d(void 0,null,function*(){try{const{data:r,error:t}=yield x.from("license_packages").select("*").order("quantity",{ascending:!0});if(t)throw t;return r||[]}catch(r){throw console.error("Erreur lors de la récupération des forfaits:",r),r}}),I=c=>d(void 0,[c],function*({packageId:r,trainerId:t}){try{const{data:n,error:a}=yield x.from("license_packages").select("*").eq("id",r).single();if(a)throw new Error("Forfait non trouvé");const{data:u,error:o}=yield x.from("license_purchases").insert({trainer_id:t,package_id:r,quantity:n.quantity,amount_cents:n.price_cents,status:"pending"}).select().single();if(o)throw o;return u}catch(n){throw console.error("Erreur lors de la création de l'achat:",n),n}}),A=r=>d(void 0,null,function*(){try{const{data:t,error:c}=yield x.from("license_purchases").select(`
        *,
        license_packages (
          name,
          quantity,
          price_cents
        )
      `).eq("trainer_id",r).order("created_at",{ascending:!1});if(c)throw c;return t||[]}catch(t){throw console.error("Erreur lors de la récupération des achats:",t),t}});function O({trainerId:r,onSuccess:t}){const[c,n]=h.useState([]),[a,u]=h.useState(null),[o,m]=h.useState(!0),[i,l]=h.useState(!1),{toast:f}=P();h.useEffect(()=>{v()},[]);const v=()=>d(this,null,function*(){try{const s=yield F();n(s)}catch(s){f({title:"Erreur",description:"Impossible de charger les forfaits",variant:"destructive"})}finally{m(!1)}}),S=s=>d(this,null,function*(){if(!r){f({title:"Erreur",description:"ID formateur manquant",variant:"destructive"});return}l(!0);try{const p=yield I({packageId:s,trainerId:r}),g=yield fetch("/api/create-checkout-session",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({purchaseId:p.id,packageId:s,trainerId:r,successUrl:`${window.location.origin}/compte-formateur?tab=licenses&success=true`,cancelUrl:window.location.href})});if(!g.ok)throw new Error("Erreur lors de la création de la session Stripe");const{sessionId:C}=yield g.json(),j=yield window.Stripe({}.VITE_STRIPE_PUBLIC_KEY).redirectToCheckout({sessionId:C});if(j.error)throw new Error(j.error.message)}catch(p){console.error("Erreur lors de l'achat:",p),f({title:"Erreur",description:p.message||"Erreur lors du traitement du paiement",variant:"destructive"})}finally{l(!1)}});return o?e.jsxs(w,{children:[e.jsx(y,{children:e.jsx(E,{children:"Acheter des licences"})}),e.jsx(N,{className:"flex justify-center py-8",children:e.jsx(b,{className:"h-8 w-8 animate-spin text-primary"})})]}):e.jsx("div",{className:"space-y-6",children:e.jsxs(w,{children:[e.jsxs(y,{children:[e.jsxs(E,{className:"flex items-center gap-2",children:[e.jsx(_,{className:"h-5 w-5"}),"Acheter des licences"]}),e.jsx(q,{children:"Sélectionnez un forfait pour attribuer des licences à vos apprenants"})]}),e.jsxs(N,{children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:c.map(s=>e.jsxs("div",{className:`relative border-2 rounded-lg p-4 cursor-pointer transition-all ${(a==null?void 0:a.id)===s.id?"border-primary bg-primary/5":"border-gray-200 hover:border-primary/50"}`,onClick:()=>u(s),children:[(a==null?void 0:a.id)===s.id&&e.jsx("div",{className:"absolute top-2 right-2",children:e.jsx(T,{className:"bg-green-500",children:"Sélectionné"})}),e.jsx("h3",{className:"font-semibold text-lg",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:s.description}),e.jsxs("div",{className:"mt-4 flex items-baseline gap-2",children:[e.jsx("span",{className:"text-3xl font-bold",children:(s.price_cents/100).toFixed(2)}),e.jsx("span",{className:"text-gray-600",children:"€"})]}),e.jsxs("p",{className:"text-sm text-gray-500 mt-2",children:[(s.price_cents/s.quantity/100).toFixed(2),"€ par licence"]})]},s.id))}),e.jsx(L,{className:"w-full mt-6",size:"lg",disabled:!a||i,onClick:()=>S(a.id),children:i?e.jsxs(e.Fragment,{children:[e.jsx(b,{className:"h-4 w-4 mr-2 animate-spin"}),"Redirection vers le paiement..."]}):e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"h-4 w-4 mr-2"}),"Procéder au paiement"]})})]})]})})}export{O as P,A as g};
