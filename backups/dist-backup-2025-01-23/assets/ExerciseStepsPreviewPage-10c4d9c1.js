var S=(a,o,i)=>new Promise((t,l)=>{var c=n=>{try{p(i.next(n))}catch(x){l(x)}},g=n=>{try{p(i.throw(n))}catch(x){l(x)}},p=n=>n.done?t(n.value):Promise.resolve(n.value).then(c,g);p((i=i.apply(a,o)).next())});import{j as e}from"./radix-ui-2f58371e.js";import{h as G,f as J,r as h,L as A}from"./react-vendor-6cf6ded9.js";import{i as Q,e as v,S as W,C as P,k as L,l as T,w as $,c as D,A as X,m as Y,j as Z,V as ee,s as N,F as M,B as se,M as ae,b as te,H as re,d as ie}from"./index-426aa6f1.js";import{t as ne,w as oe,aa as le,A as q,a3 as y,K as _,N as w,E as B}from"./ui-icons-e73ce4f7.js";import{I as F}from"./ImageFromSupabase-e93ddddf.js";import"./supabase-4b7d20da.js";const ce=a=>a?a.split(/[\s-]+/).map(o=>o.charAt(0).toUpperCase()+o.slice(1).toLowerCase()).join(""):null,H=a=>{if(!a)return w;if(a.includes(":")){const[o,i]=a.split(":"),l={lucide:B,fa6:M,fa:M,bs:se,md:ae,fi:te,hi2:re,ai:ie}[o];return l&&l[i]?l[i]:w}return B[ce(a)]||w},ge=()=>{var V,E;const{taskId:a}=G(),o=J(),{toast:i}=Q(),[t,l]=h.useState(null),[c,g]=h.useState([]),[p,n]=h.useState(!0),[x,k]=h.useState(!1),[O,R]=h.useState(""),[u,C]=h.useState(null),[j,I]=h.useState(!1);h.useEffect(()=>{(()=>S(void 0,null,function*(){n(!0);try{const{data:r,error:d}=yield N.from("tasks").select("id, title, description, icon_name, video_url, pictogram_app_image_id, task_type").eq("id",a).single();if(d)throw d;if(r.task_type==="questionnaire"){const{data:b,error:K}=yield N.from("versions").select("id").eq("task_id",a).order("name",{ascending:!0}).limit(1);if(!K&&b&&b.length>0){o(`/tache/${a}/version/${b[0].id}`);return}}const{data:m,error:f}=yield N.from("versions").select("id, name, version, has_variant_note, steps(id, step_order, instruction, icon_name, pictogram_app_image_id)").eq("task_id",a).order("name",{ascending:!0});if(f)throw f;l(r),g(m),m&&m.length>0&&C(m[0].id)}catch(r){console.error("Error fetching task or versions:",r),i({title:"Erreur",description:"Impossible de charger les détails de la tâche.",variant:"destructive"})}finally{n(!1)}}))()},[a,i]);const U=s=>{R(s),k(!0)};if(p)return e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx(ne,{className:"h-8 w-8 animate-spin text-primary"})});if(!t)return e.jsx("div",{className:"text-center py-10",children:"Tâche non trouvée."});const z=H(t.icon_name);return e.jsxs("div",{className:"max-w-2xl mx-auto p-2 sm:p-4 md:p-6",children:[e.jsxs(v,{variant:"outline",onClick:()=>o("/taches"),className:"mb-4",children:[e.jsx(oe,{className:"mr-2 h-4 w-4"}),"Retour à la liste des tâches"]}),e.jsx(W,{className:"mb-6"}),e.jsx(P,{className:"mb-6 shadow-lg border-border/50 overflow-hidden",children:e.jsxs(L,{className:"flex flex-row items-center gap-4 p-4 bg-card/80",children:[e.jsx("div",{className:"flex-shrink-0 bg-primary/10 text-primary rounded-lg flex items-center justify-center h-16 w-16 p-2",children:t.pictogram_app_image_id?e.jsx(F,{imageId:t.pictogram_app_image_id,alt:"Pictogramme de la tâche",className:"h-full w-full object-contain"}):e.jsx(z,{className:"h-10 w-10"})}),e.jsxs("div",{className:"flex-grow",children:[e.jsx(T,{className:"text-xl font-bold text-primary",children:t.title}),t.description&&e.jsx($,{className:"mt-1 text-sm",children:t.description})]}),t.video_url&&e.jsx(v,{variant:"ghost",size:"icon",onClick:()=>U(t.video_url),className:"text-primary hover:text-primary/80 flex-shrink-0",children:e.jsx(le,{className:"h-8 w-8"})})]})}),c.length>0?e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"rounded-lg border-2 border-primary bg-primary/5 mb-4",children:[e.jsxs("button",{onClick:()=>I(!j),className:"w-full p-3 flex items-center justify-between focus:outline-none text-base",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold text-primary",children:((V=c.find(s=>s.id===u))==null?void 0:V.name)||"Version"}),((E=c.find(s=>s.id===u))==null?void 0:E.has_variant_note)&&e.jsx(q,{className:"h-3 w-3 text-amber-500"})]}),e.jsx(y,{className:D("h-5 w-5 text-primary transition-transform duration-200",j&&"rotate-90")})]}),e.jsx(X,{children:j&&c.length>1&&e.jsx(Y.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.2},className:"overflow-hidden",children:e.jsx("div",{className:"space-y-2 p-2 bg-background rounded-b-lg border-t border-muted",children:c.map(s=>e.jsx("button",{onClick:()=>{C(s.id),I(!1)},className:D("w-full text-left p-2 rounded transition-colors duration-150",s.id===u?"bg-primary/20 border-l-4 border-primary font-semibold text-primary":"bg-background/50 hover:bg-background text-foreground"),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm",children:s.name}),s.has_variant_note&&e.jsx(q,{className:"h-3 w-3 text-amber-500"})]})},s.id))})})})]}),c.filter(s=>s.id===u).map(s=>e.jsxs(P,{children:[e.jsxs(L,{children:[e.jsxs(T,{children:["Étapes pour : ",s.name]}),e.jsxs($,{children:["Version ",s.version]})]}),e.jsxs(Z,{children:[e.jsx("div",{className:"space-y-3",children:s.steps&&[...s.steps].sort((r,d)=>(r.step_order||0)-(d.step_order||0)).map((r,d)=>{let m=_;try{m=r.icon_name?H(r.icon_name):_}catch(f){console.warn("Icon resolution error:",f),m=_}return e.jsxs(A,{to:`/tache/${a}/version/${s.id}?step=${d+1}`,className:"flex items-center p-3 bg-background rounded-lg border hover:bg-accent hover:border-primary/50 transition-all duration-200 group",children:[e.jsx("div",{className:"flex-shrink-0 h-8 w-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center font-bold text-sm mr-4",children:d+1}),e.jsx("div",{className:"flex-grow text-sm font-medium",children:r.instruction}),e.jsx("div",{className:"flex-shrink-0 h-10 w-10 rounded-md bg-primary/10 flex items-center justify-center text-primary ml-4",children:r.pictogram_app_image_id?e.jsx(F,{imageId:r.pictogram_app_image_id,alt:"Pictogramme",className:"h-7 w-7 object-contain"}):e.jsx(m,{className:"h-6 w-6"})}),e.jsx(y,{className:"h-5 w-5 text-muted-foreground ml-2 group-hover:translate-x-1 transition-transform"})]},r.id||d)})}),e.jsx("div",{className:"mt-6 text-center",children:e.jsx(v,{asChild:!0,size:"lg",children:e.jsxs(A,{to:`/tache/${a}/version/${s.id}`,children:["Commencer",e.jsx(y,{className:"ml-2 h-4 w-4"})]})})})]})]},s.id))]}):e.jsx("p",{className:"text-center text-muted-foreground",children:"Aucune version disponible pour cette tâche."}),e.jsx(ee,{isOpen:x,onClose:()=>k(!1),videoUrl:O,title:`Vidéo pour: ${t.title}`})]})};export{ge as default};
