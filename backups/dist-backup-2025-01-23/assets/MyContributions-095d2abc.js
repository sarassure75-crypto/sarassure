var ee=Object.defineProperty,se=Object.defineProperties;var te=Object.getOwnPropertyDescriptors;var Q=Object.getOwnPropertySymbols;var ae=Object.prototype.hasOwnProperty,re=Object.prototype.propertyIsEnumerable;var X=(d,t,l)=>t in d?ee(d,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):d[t]=l,_=(d,t)=>{for(var l in t||(t={}))ae.call(t,l)&&X(d,l,t[l]);if(Q)for(var l of Q(t))re.call(t,l)&&X(d,l,t[l]);return d},C=(d,t)=>se(d,te(t));var T=(d,t,l)=>new Promise((a,y)=>{var b=x=>{try{h(l.next(x))}catch(v){y(v)}},w=x=>{try{h(l.throw(x))}catch(v){y(v)}},h=x=>x.done?a(x.value):Promise.resolve(x.value).then(b,w);h((l=l.apply(d,t)).next())});import{j as e}from"./radix-ui-2f58371e.js";import{f as le,r as u}from"./react-vendor-6cf6ded9.js";import{a as de,u as ie}from"./useContributions-fb136813.js";import{u as ne,s as Z}from"./index-426aa6f1.js";import{u as oe}from"./useContributorRevenue-60ff8884.js";import{a9 as ce,Q as me,a6 as H,I as xe,b1 as pe,ac as A,v as ue,k as J,a$ as ge,y as he}from"./ui-icons-e73ce4f7.js";import"./supabase-4b7d20da.js";import"./imagesMetadata-470e1c8a.js";import"./contributorRevenue-c96552d7.js";function Ee(){var P,B,L,z,D,q,M,S,k,G;const d=le(),{currentUser:t}=ne(),{deleteContribution:l}=de();oe(t==null?void 0:t.id);const{stats:a,loading:y}=ie(t==null?void 0:t.id),[b,w]=u.useState([]),[h,x]=u.useState([]),[v,E]=u.useState(!0),[f,K]=u.useState(""),[p,O]=u.useState("all"),[I,ve]=u.useState("all"),[R,W]=u.useState("recent");u.useEffect(()=>{$()},[t==null?void 0:t.id]);const $=()=>T(this,null,function*(){try{E(!0);const{data:s,error:r}=yield Z.from("tasks").select(`
          id,
          title,
          description,
          owner_id,
          creation_status,
          created_at,
          updated_at,
          versions (
            id,
            creation_status,
            name,
            created_at,
            updated_at,
            admin_comments,
            reviewer_id,
            reviewed_at,
            modification_count
          )
        `).eq("owner_id",t==null?void 0:t.id).order("created_at",{ascending:!1});if(r)throw r;const i=[];s&&s.forEach(o=>{o.versions&&o.versions.length>0?o.versions.forEach(m=>{i.push({id:m.id,taskId:o.id,title:o.title,versionName:m.name,description:o.description,status:m.creation_status,created_at:m.created_at,updated_at:m.updated_at||m.created_at,admin_comments:m.admin_comments,reviewer_id:m.reviewer_id,reviewed_at:m.reviewed_at,modification_count:m.modification_count,type:"version"})}):i.push({id:o.id,taskId:o.id,title:o.title,versionName:null,description:o.description,status:"draft",created_at:o.created_at,updated_at:o.updated_at||o.created_at,type:"draft"})});const{data:n,error:N}=yield Z.from("images_metadata").select("id,title,moderation_status,uploaded_by,created_at,updated_at").eq("uploaded_by",t==null?void 0:t.id).order("created_at",{ascending:!1});if(N)throw N;w(i||[]),x(n||[]),console.log("Tasks loaded:",(s==null?void 0:s.length)||0),console.log("All versions:",(i==null?void 0:i.length)||0),console.log("Images loaded:",(n==null?void 0:n.length)||0),console.log("Sample version:",i==null?void 0:i[0]),console.log("Sample image:",n==null?void 0:n[0])}catch(s){console.error("Error loading contributions:",s)}finally{E(!1)}}),j=[...(b||[]).map(s=>C(_({},s),{type:s.type,status:s.status||"draft",displayTitle:s.versionName?`${s.title} - ${s.versionName}`:s.title,date:s.updated_at||s.created_at})),...(h||[]).map(s=>{var r;return C(_({},s),{type:"image",status:s.moderation_status||"pending",displayTitle:s.title||`Image ${(r=s.id)==null?void 0:r.slice(0,8)}`,date:s.updated_at||s.created_at})})];console.log("All contributions combined:",j.length),console.log("Sample contribution:",j[0]);const c={exercisesTotal:((P=a==null?void 0:a.exercises)==null?void 0:P.total)||0,exercisesApproved:((B=a==null?void 0:a.exercises)==null?void 0:B.approved)||0,exercisesPending:((L=a==null?void 0:a.exercises)==null?void 0:L.pending)||0,exercisesRejected:((z=a==null?void 0:a.exercises)==null?void 0:z.rejected)||0,imagesTotal:((D=a==null?void 0:a.images)==null?void 0:D.total)||0,imagesApproved:((q=a==null?void 0:a.images)==null?void 0:q.approved)||0,imagesPending:((M=a==null?void 0:a.images)==null?void 0:M.pending)||0,imagesRejected:((S=a==null?void 0:a.images)==null?void 0:S.rejected)||0,totalContributions:(((k=a==null?void 0:a.exercises)==null?void 0:k.total)||0)+(((G=a==null?void 0:a.images)==null?void 0:G.total)||0)},g=j==null?void 0:j.filter(s=>{var r;if(f&&!((r=s.displayTitle)!=null&&r.toLowerCase().includes(f.toLowerCase())))return!1;if(p!=="all"){if(p==="approved"&&s.status!=="validated"&&s.status!=="approved")return!1;if(p==="draft"&&s.status!=="draft")return!1;if(p==="pending"&&s.status!=="pending")return!1;if(p==="rejected"&&s.status!=="rejected")return!1;if(p==="needs_changes"&&s.status!=="needs_changes")return!1}return!(I!=="all"&&s.type!==I)}).sort((s,r)=>{switch(R){case"recent":return new Date(r.date)-new Date(s.date);case"oldest":return new Date(s.date)-new Date(r.date);case"title":return(s.displayTitle||"").localeCompare(r.displayTitle||"");default:return 0}});console.log("Filtered contributions:",(g==null?void 0:g.length)||0),console.log("Status filter:",p),console.log("Search term:",f);const Y=s=>T(this,null,function*(){if(window.confirm("Êtes-vous sûr de vouloir supprimer cette contribution ?"))try{let r=s.id,i=s.type;const n=yield l(r,i,i==="image"?t==null?void 0:t.id:null);n.success?$():alert("Erreur lors de la suppression: "+n.error)}catch(r){console.error("Error deleting contribution:",r),alert("Erreur lors de la suppression: "+r.message)}}),V=s=>{if(s.status==="needs_changes")d(`/contributeur/nouvelle-contribution?correction=${s.id}`);else{const r=s.taskId||s.id;d(`/contributeur/nouvelle-contribution?edit=${r}`)}},U=(s,r)=>{let i={validated:{color:"bg-green-100 text-green-700",icon:J,label:"Approuvée"},approved:{color:"bg-green-100 text-green-700",icon:J,label:"Approuvée"},pending:{color:"bg-yellow-100 text-yellow-700",icon:ge,label:"En attente"},needs_changes:{color:"bg-orange-100 text-orange-700",icon:A,label:"À corriger"},rejected:{color:"bg-red-100 text-red-700",icon:he,label:"Rejetée"},draft:{color:"bg-gray-100 text-gray-700",icon:A,label:"Brouillon"}};const n=i[s]||i.draft,N=n.icon;return e.jsxs("span",{className:`inline-flex items-center space-x-1 px-3 py-1 rounded-full text-sm font-medium ${n.color}`,children:[e.jsx(N,{className:"w-4 h-4"}),e.jsx("span",{children:n.label})]})},F=s=>new Date(s).toLocaleDateString("fr-FR",{year:"numeric",month:"short",day:"numeric"});return v?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600",children:"Chargement..."})]})}):e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Mes Contributions"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Gérez et suivez l'état de vos contributions"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-8",children:[e.jsxs("div",{className:"bg-white rounded-lg p-4 shadow-sm border border-gray-200",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:c.exercisesTotal}),e.jsx("div",{className:"text-sm text-gray-600",children:"Exercices: nombre de versions"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-2",children:["✓ ",c.exercisesApproved," | ⏱ ",c.exercisesPending]})]}),e.jsxs("div",{className:"bg-purple-50 rounded-lg p-4 shadow-sm border border-purple-200",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-700",children:c.imagesTotal}),e.jsx("div",{className:"text-sm text-purple-600",children:"Images"}),e.jsxs("div",{className:"text-xs text-purple-500 mt-2",children:["✓ ",c.imagesApproved," | ⏱ ",c.imagesPending]})]}),e.jsxs("div",{className:"bg-blue-50 rounded-lg p-4 shadow-sm border border-blue-200",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-700",children:c.totalContributions}),e.jsx("div",{className:"text-sm text-blue-600",children:"Total contributions"}),e.jsxs("div",{className:"text-xs text-blue-500 mt-2",children:["✓ ",c.exercisesApproved+c.imagesApproved]})]}),e.jsx("div",{className:"bg-emerald-50 rounded-lg p-4 shadow-sm border border-emerald-200",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-emerald-700",children:c.exercisesRejected+c.imagesRejected}),e.jsx("div",{className:"text-sm text-emerald-600",children:"Rejetées"})]}),e.jsx(ce,{className:"w-8 h-8 text-emerald-300"})]})})]}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(me,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Rechercher par titre...",value:f,onChange:s=>K(s.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})}),e.jsx("div",{children:e.jsxs("select",{value:p,onChange:s=>O(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"all",children:"Tous les statuts"}),e.jsx("option",{value:"draft",children:"Brouillons"}),e.jsx("option",{value:"pending",children:"En attente"}),e.jsx("option",{value:"needs_changes",children:"À corriger"}),e.jsx("option",{value:"approved",children:"Approuvées"}),e.jsx("option",{value:"rejected",children:"Rejetées"})]})}),e.jsx("div",{children:e.jsxs("select",{value:R,onChange:s=>W(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"recent",children:"Plus récent"}),e.jsx("option",{value:"oldest",children:"Plus ancien"}),e.jsx("option",{value:"title",children:"Titre A-Z"})]})})]})}),(g==null?void 0:g.length)===0?e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center",children:[e.jsx(H,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Aucune contribution"}),e.jsx("p",{className:"text-gray-600 mb-6",children:f||p!=="all"?"Aucun résultat ne correspond à vos critères.":"Vous n'avez pas encore créé de contribution."}),e.jsx("button",{onClick:()=>d("/contributeur/nouvelle-contribution"),className:"px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors",children:"Créer ma première contribution"})]}):e.jsx("div",{className:"space-y-4",children:g.map(s=>e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[s.type==="image"?e.jsx(xe,{className:"w-5 h-5 text-purple-600"}):e.jsx(H,{className:"w-5 h-5 text-blue-600"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:s.displayTitle||"Sans titre"})]}),U(s.status,s.type)]}),s.description&&e.jsx("p",{className:"text-gray-600 mb-3 line-clamp-2",children:s.description}),s.status==="needs_changes"&&s.admin_comments&&e.jsx("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-3 mb-3",children:e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-2 h-2 bg-orange-500 rounded-full mt-2"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-orange-800 mb-1",children:"Commentaires de l'admin :"}),e.jsx("p",{className:"text-sm text-orange-700 whitespace-pre-wrap",children:s.admin_comments}),s.reviewed_at&&e.jsxs("p",{className:"text-xs text-orange-600 mt-2",children:["Révisé le ",F(s.reviewed_at)]})]})]})}),e.jsxs("div",{className:"flex items-center space-x-4 text-sm text-gray-500 flex-wrap",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsx("span",{children:F(s.date)})]}),e.jsx("div",{className:"flex items-center space-x-1",children:e.jsx("span",{className:"capitalize px-2 py-1 bg-gray-100 rounded text-xs font-medium",children:s.type==="image"?"Image":s.type==="draft"?"Brouillon":"Version"})})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 ml-4",children:[(s.type==="version"||s.type==="draft")&&e.jsx("button",{onClick:()=>V(s),className:`p-2 rounded-lg transition-colors ${s.status==="needs_changes"?"text-orange-600 hover:bg-orange-50":"text-blue-600 hover:bg-blue-50"}`,title:s.status==="needs_changes"?"Corriger":"Modifier",children:e.jsx(A,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>Y(s),className:"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors",title:"Supprimer",children:e.jsx(ue,{className:"w-5 h-5"})})]})]})},s.id))})]})}export{Ee as default};
