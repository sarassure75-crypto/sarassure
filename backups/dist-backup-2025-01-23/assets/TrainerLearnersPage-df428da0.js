var h=(c,d,m)=>new Promise((C,p)=>{var x=t=>{try{o(m.next(t))}catch(l){p(l)}},u=t=>{try{o(m.throw(t))}catch(l){p(l)}},o=t=>t.done?C(t.value):Promise.resolve(t.value).then(x,u);o((m=m.apply(c,d)).next())});import{j as e}from"./radix-ui-2f58371e.js";import{r as n}from"./react-vendor-6cf6ded9.js";import{u as R,s as g,e as i,C as f,k,l as E,w as A,j,I,ag as V}from"./index-426aa6f1.js";import{A as B,a as G}from"./alert-9353e410.js";import{f as P,aU as S,bb as z,a7 as H,b7 as J,m as K,b1 as O,v as Q}from"./ui-icons-e73ce4f7.js";import"./supabase-4b7d20da.js";function ae(){const{currentUser:c}=R(),[d,m]=n.useState([]),[C,p]=n.useState(!0),[x,u]=n.useState(""),[o,t]=n.useState(!1),[l,a]=n.useState({type:"",text:""}),[q,b]=n.useState(!1),[D,N]=n.useState(!1),[w,U]=n.useState(!1),[L,_]=n.useState("");n.useEffect(()=>{c&&y()},[c]);const y=()=>h(this,null,function*(){try{p(!0);const{data:s,error:r}=yield g.from("profiles").select("*").eq("assigned_trainer_id",c.id).eq("role","apprenant").order("created_at",{ascending:!1});if(r)throw r;m(s||[])}catch(s){console.error("Erreur:",s),a({type:"error",text:"Erreur lors du chargement des apprenants"})}finally{p(!1)}}),T=s=>h(this,null,function*(){if(s.preventDefault(),!x.trim()){a({type:"error",text:"Veuillez entrer un code apprenant"});return}try{t(!0);const{data:r,error:v}=yield g.from("profiles").select("id, email, full_name").eq("learner_code",x.toUpperCase()).single();if(v||!r){a({type:"error",text:"Code apprenant non trouvé"});return}if(r.assigned_trainer_id&&r.assigned_trainer_id!==c.id){a({type:"error",text:"Cet apprenant est déjà lié à un autre formateur"});return}const{error:F}=yield g.from("profiles").update({assigned_trainer_id:c.id}).eq("id",r.id);if(F)throw F;a({type:"success",text:`Apprenant ${r.full_name} lié avec succès!`}),u(""),b(!1),y()}catch(r){console.error("Erreur:",r),a({type:"error",text:"Erreur lors de la liaison"})}finally{t(!1)}}),M=s=>h(this,null,function*(){if(s.preventDefault(),!L.trim()){a({type:"error",text:"Veuillez entrer un prénom"});return}try{U(!0);const r=yield V(L),{error:v}=yield g.from("profiles").update({assigned_trainer_id:c.id}).eq("id",r.id);if(v)throw v;a({type:"success",text:`Apprenant "${r.first_name}" créé avec succès! Code: ${r.learner_code}`}),_(""),N(!1),y(),setTimeout(()=>a({type:"",text:""}),5e3)}catch(r){console.error("Erreur:",r),a({type:"error",text:r.message||"Erreur lors de la création du compte"})}finally{U(!1)}}),$=s=>h(this,null,function*(){if(confirm("Êtes-vous sûr de vouloir délier cet apprenant?"))try{const{error:r}=yield g.from("profiles").update({assigned_trainer_id:null}).eq("id",s);if(r)throw r;a({type:"success",text:"Apprenant déié avec succès!"}),y()}catch(r){console.error("Erreur:",r),a({type:"error",text:"Erreur lors de la suppression de la liaison"})}});return e.jsx("div",{className:"min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"mb-8 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-gray-900 flex items-center gap-2",children:[e.jsx(P,{className:"text-primary"}),"Mes Apprenants"]}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Gérez et créez les comptes de vos apprenants"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(i,{onClick:()=>N(!D),className:"gap-2 bg-green-600 hover:bg-green-700",children:[e.jsx(S,{className:"h-4 w-4"}),"Créer un apprenant"]}),e.jsxs(i,{onClick:()=>b(!q),className:"gap-2 bg-primary hover:bg-primary/90",children:[e.jsx(z,{className:"h-4 w-4"}),"Lier un apprenant"]})]})]}),l.text&&e.jsxs(B,{className:l.type==="error"?"bg-red-50 border-red-200 mb-8":"bg-green-50 border-green-200 mb-8",children:[l.type==="error"?e.jsx(H,{className:"text-red-600"}):e.jsx(J,{className:"text-green-600"}),e.jsx(G,{className:l.type==="error"?"text-red-800":"text-green-800",children:l.text})]}),D&&e.jsxs(f,{className:"mb-8 border-green-300 bg-green-50",children:[e.jsxs(k,{className:"border-b border-green-200",children:[e.jsxs(E,{className:"flex items-center gap-2 text-green-900",children:[e.jsx(S,{className:"text-green-600"}),"Créer un apprenant (sans email)"]}),e.jsx(A,{className:"text-green-800",children:"Créez un compte pour un apprenant qui n'a pas d'adresse email. Un code unique sera généré."})]}),e.jsx(j,{className:"pt-6",children:e.jsxs("form",{onSubmit:M,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Prénom de l'apprenant"}),e.jsx(I,{type:"text",placeholder:"Ex: Jean",value:L,onChange:s=>_(s.target.value),disabled:w})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(i,{type:"submit",disabled:w,className:"flex-1 bg-green-600 hover:bg-green-700",children:w?"Création en cours...":"Créer le compte"}),e.jsx(i,{type:"button",variant:"outline",onClick:()=>{N(!1),_("")},className:"flex-1",children:"Annuler"})]})]})})]}),q&&e.jsxs(f,{className:"mb-8 border-primary",children:[e.jsxs(k,{className:"bg-primary/5",children:[e.jsxs(E,{className:"flex items-center gap-2",children:[e.jsx(z,{className:"text-primary"}),"Lier un apprenant"]}),e.jsx(A,{children:"Entrez le code de l'apprenant pour établir la liaison"})]}),e.jsx(j,{className:"pt-6",children:e.jsxs("form",{onSubmit:T,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Code apprenant"}),e.jsx(I,{type:"text",placeholder:"Ex: AP12345",value:x,onChange:s=>u(s.target.value.toUpperCase()),disabled:o}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:'Le code apprenant se trouve dans son profil "Espace Apprenant"'})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(i,{type:"submit",disabled:o,className:"flex-1 bg-primary hover:bg-primary/90",children:o?"Liaison en cours...":"Lier l'apprenant"}),e.jsx(i,{type:"button",variant:"outline",onClick:()=>{b(!1),u("")},className:"flex-1",children:"Annuler"})]})]})})]}),d.length>0&&e.jsx(f,{className:"mb-8 bg-blue-50 border-blue-200",children:e.jsx(j,{className:"pt-6",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-3xl font-bold text-blue-700",children:d.length}),e.jsx("p",{className:"text-blue-600 text-sm",children:"apprenant(s) lié(s)"})]})})}),C?e.jsx("div",{className:"text-center py-12",children:"Chargement..."}):d.length===0?e.jsx(f,{children:e.jsxs(j,{className:"pt-12 pb-12 text-center",children:[e.jsx(P,{className:"h-16 w-16 text-gray-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Aucun apprenant lié"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Créez ou liez des apprenants à votre compte formateur"}),e.jsxs("div",{className:"flex gap-3 justify-center",children:[e.jsxs(i,{onClick:()=>N(!0),className:"gap-2 bg-green-600 hover:bg-green-700",children:[e.jsx(S,{className:"h-4 w-4"}),"Créer un apprenant"]}),e.jsxs(i,{onClick:()=>b(!0),className:"gap-2 bg-primary hover:bg-primary/90",children:[e.jsx(z,{className:"h-4 w-4"}),"Lier un apprenant"]})]})]})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:d.map(s=>{var r;return e.jsxs(f,{className:"hover:shadow-lg transition-shadow",children:[e.jsxs(k,{children:[e.jsx(E,{className:"text-lg",children:s.first_name||"Apprenant"}),e.jsxs(A,{className:"flex items-center gap-1 mt-2",children:[e.jsx(K,{className:"h-4 w-4"}),(r=s.email)!=null&&r.includes("@example.com")?"Aucun":s.email]})]}),e.jsx(j,{children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-3 bg-gray-100 rounded font-mono text-sm text-center",children:["Code: ",e.jsx("span",{className:"font-bold text-primary",children:s.learner_code||"N/A"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-600",children:[e.jsx(O,{className:"h-4 w-4"}),e.jsxs("span",{children:["Inscrit le ",new Date(s.created_at).toLocaleDateString("fr-FR")]})]}),e.jsxs(i,{variant:"outline",size:"sm",onClick:()=>$(s.id),className:"w-full text-red-600 hover:text-red-700 border-red-200 hover:bg-red-50",children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Délier"]})]})})]},s.id)})})]})})}export{ae as default};
