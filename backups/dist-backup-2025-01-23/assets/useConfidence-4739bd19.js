var g=(a,e,r)=>new Promise((o,u)=>{var m=f=>{try{l(r.next(f))}catch(i){u(i)}},_=f=>{try{l(r.throw(f))}catch(i){u(i)}},l=f=>f.done?o(f.value):Promise.resolve(f.value).then(m,_);l((r=r.apply(a,e)).next())});import{s as h,aX as C}from"./index-426aa6f1.js";import{r as p}from"./react-vendor-6cf6ded9.js";const E=(a,e)=>g(void 0,null,function*(){if(!a||!e)return null;try{const{data:r,error:o}=yield h.from("user_version_progress").select("*").eq("user_id",a).eq("version_id",e).single();if(o&&o.code!=="PGRST116")throw o;return r}catch(r){return console.error("Error fetching progress for version:",r),null}}),k=a=>g(void 0,null,function*(){if(!a)return[];try{const{data:e,error:r}=yield h.rpc("get_user_progress_details",{p_user_id:a});if(r)throw console.error("Error fetching user progress details:",r),r;return e}catch(e){return[]}}),S=(a,e,r)=>g(void 0,null,function*(){if(!a||!e)return{error:"Missing userId or versionId"};const o=yield E(a,e);let u={};const m={time:new Date().toISOString(),duration:r};o?u={user_id:a,version_id:e,attempts:(o.attempts||0)+1,last_time_seconds:Math.round(r),best_time_seconds:Math.round(Math.min(o.best_time_seconds||1/0,r)),completed_steps_history:[...o.completed_steps_history||[],m]}:u={user_id:a,version_id:e,attempts:1,first_time_seconds:Math.round(r),last_time_seconds:Math.round(r),best_time_seconds:Math.round(r),completed_steps_history:[m]};try{const{data:_,error:l}=yield h.from("user_version_progress").upsert(u,{onConflict:"user_id,version_id"}).select().single();return l?(console.error("recordCompletion - upsert error:",l),{error:l}):{data:_}}catch(_){return console.error("Error recording completion:",_),{error:_}}});function q(){const[a,e]=p.useState(!1),[r,o]=p.useState(null),u=p.useCallback((i,c)=>g(this,null,function*(){try{e(!0),o(null);const{data:d,error:s}=yield h.from("user_exercise_confidence").select("confidence_before, confidence_after, created_at, updated_at").eq("user_id",i).eq("version_id",c).maybeSingle();if(s)throw s;return d}catch(d){return C.error("Error fetching confidence:",d),o(d.message),null}finally{e(!1)}}),[]),m=p.useCallback((i,c,d)=>g(this,null,function*(){try{e(!0),o(null);const{data:s,error:t}=yield h.from("user_exercise_confidence").upsert({user_id:i,version_id:c,confidence_before:d,updated_at:new Date().toISOString()},{onConflict:"user_id, version_id"}).select().single();if(t)throw t;return C.log("✅ Confidence before recorded:",s),s}catch(s){return C.error("Error recording confidence before:",s),o(s.message),null}finally{e(!1)}}),[]),_=p.useCallback((i,c,d)=>g(this,null,function*(){try{e(!0),o(null);const{data:s,error:t}=yield h.from("user_exercise_confidence").upsert({user_id:i,version_id:c,confidence_after:d,updated_at:new Date().toISOString()},{onConflict:"user_id, version_id"}).select().single();if(t)throw t;return C.log("✅ Confidence after recorded:",s),s}catch(s){return C.error("Error recording confidence after:",s),o(s.message),null}finally{e(!1)}}),[]),l=p.useCallback(i=>g(this,null,function*(){try{e(!0),o(null);const{data:c,error:d}=yield h.from("user_exercise_confidence").select(`
          id,
          version_id,
          confidence_before,
          confidence_after,
          created_at,
          updated_at,
          versions(id, name, task_id, tasks(id, title))
        `).eq("user_id",i).order("created_at",{ascending:!1});if(d)throw d;return c.map(t=>{var v,y,b,n,w;return{id:t.id,versionId:t.version_id,versionName:(v=t.versions)==null?void 0:v.name,taskId:(b=(y=t.versions)==null?void 0:y.tasks)==null?void 0:b.id,taskTitle:(w=(n=t.versions)==null?void 0:n.tasks)==null?void 0:w.title,confidenceBefore:t.confidence_before,confidenceAfter:t.confidence_after,progress:t.confidence_after&&t.confidence_before?t.confidence_after-t.confidence_before:null,createdAt:t.created_at,updatedAt:t.updated_at}})}catch(c){return C.error("Error fetching confidence history:",c),o(c.message),[]}finally{e(!1)}}),[]),f=p.useCallback(i=>{if(!i||i.length===0)return{totalExercises:0,averageProgression:0,improvementCount:0,stableCount:0,declineCount:0};const c=i.filter(n=>n.confidenceBefore&&n.confidenceAfter),d=c.length;if(d===0)return{totalExercises:0,averageProgression:0,improvementCount:0,stableCount:0,declineCount:0};const s=c.map(n=>n.progress).filter(n=>n!==null),t=s.length>0?(s.reduce((n,w)=>n+w,0)/s.length).toFixed(2):0,v=c.filter(n=>n.progress>0).length,y=c.filter(n=>n.progress===0).length,b=c.filter(n=>n.progress<0).length;return{totalExercises:d,averageProgression:parseFloat(t),improvementCount:v,stableCount:y,declineCount:b}},[]);return{loading:a,error:r,fetchConfidence:u,recordConfidenceBefore:m,recordConfidenceAfter:_,fetchConfidenceHistory:l,calculateConfidenceStats:f}}export{k as f,S as r,q as u};
