var f=Object.defineProperty,w=Object.defineProperties;var b=Object.getOwnPropertyDescriptors;var _=Object.getOwnPropertySymbols;var E=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable;var h=(r,a,e)=>a in r?f(r,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[a]=e,l=(r,a)=>{for(var e in a||(a={}))E.call(a,e)&&h(r,e,a[e]);if(_)for(var e of _(a))I.call(a,e)&&h(r,e,a[e]);return r},p=(r,a)=>w(r,b(a));var c=(r,a,e)=>new Promise((t,o)=>{var s=d=>{try{i(e.next(d))}catch(g){o(g)}},m=d=>{try{i(e.throw(d))}catch(g){o(g)}},i=d=>d.done?t(d.value):Promise.resolve(d.value).then(s,m);i((e=e.apply(r,a)).next())});import{s as n,a5 as x,aX as u}from"./index-426aa6f1.js";const y=1*1024*1024;function v(r,a,e,t="images"){return c(this,null,function*(){try{if(r.size>y)throw new Error(`L'image dépasse la taille maximale de ${y/1024/1024} Mo. Veuillez la redimensionner.`);const o=r.name.split(".").pop(),s=`${e}/${Date.now()}_${Math.random().toString(36).substring(7)}.${o}`,{error:m}=yield n.storage.from(t).upload(s,r);if(m)throw m;const{data:i}=n.storage.from(t).getPublicUrl(s),{data:d,error:g}=yield n.from("images_metadata").insert([{storage_path:s,storage_bucket:t,public_url:i.publicUrl,title:a.title||r.name,description:a.description||"",tags:a.tags||[],category:a.category||"Autre",uploaded_by:e,width:a.width||null,height:a.height||null,file_size:r.size,mime_type:r.type,moderation_status:"pending"}]).select().single();if(g)throw g;return{success:!0,data:d}}catch(o){return u.error("Error uploading image with metadata:",o),{success:!1,error:o.message}}})}function $(r,a){return c(this,null,function*(){try{const{data:e,error:t}=yield n.from("images_metadata").update(a).eq("id",r).select().single();if(t)throw t;return{success:!0,data:e}}catch(e){return u.error("Error updating image metadata:",e),{success:!1,error:e.message}}})}function j(){return c(this,arguments,function*(r={}){try{let a=[];try{let e=n.from("app_images").select("*");r.category&&(e=e.eq("category",r.category)),r.searchText&&(e=e.or(`name.ilike.%${r.searchText}%,description.ilike.%${r.searchText}%`)),e=e.order("created_at",{ascending:!1}),r.limit&&(e=e.limit(Math.floor(r.limit/2)));const{data:t,error:o}=yield e;!o&&t&&(a=a.concat(t.map(s=>p(l({},s),{id:s.id,title:s.name||s.file_path,description:s.description||"",public_url:x(s.file_path),source:"admin",category:s.category||"Autre",uploaded_by:{id:"admin",first_name:"Admin",last_name:"",email:"admin"},moderation_status:s.moderation_status||"approved"}))))}catch(e){console.warn("Erreur chargement images admin:",e)}try{let e=n.from("images_metadata").select(`
          *,
          uploader:uploaded_by (
            id,
            first_name,
            last_name,
            email
          )
        `);r.moderationStatus?e=e.eq("moderation_status",r.moderationStatus):e=e.eq("moderation_status","approved"),r.category&&(e=e.eq("category",r.category)),r.tags&&r.tags.length>0&&(e=e.overlaps("tags",r.tags)),r.searchText&&(e=e.or(`title.ilike.%${r.searchText}%,description.ilike.%${r.searchText}%`)),r.uploadedBy&&(e=e.eq("uploaded_by",r.uploadedBy)),r.dateFrom&&(e=e.gte("uploaded_at",r.dateFrom)),r.dateTo&&(e=e.lte("uploaded_at",r.dateTo)),r.minUsage!==void 0&&(e=e.gte("usage_count",r.minUsage)),r.maxUsage!==void 0&&(e=e.lte("usage_count",r.maxUsage));const t=r.orderBy||"uploaded_at",o=r.ascending!==void 0?r.ascending:!1;e=e.order(t,{ascending:o}),r.limit&&(e=e.limit(Math.floor(r.limit/2))),r.offset&&(e=e.range(r.offset,r.offset+(r.limit||20)-1));const{data:s,error:m}=yield e;!m&&s&&(a=a.concat(s.map(i=>p(l({},i),{source:"contributor",public_url:i.public_url||i.file_path}))))}catch(e){console.warn("Erreur requête images_metadata:",e)}return{success:!0,data:a}}catch(a){return u.error("Error searching images:",a),{success:!1,error:a.message}}})}function k(r,a){return c(this,null,function*(){try{const{data:e,error:t}=yield n.from("images_metadata").update({moderation_status:"approved",moderated_by:a,moderated_at:new Date().toISOString()}).eq("id",r).select().single();if(t)throw t;return{success:!0,data:e}}catch(e){return u.error("Error approving image:",e),{success:!1,error:e.message}}})}function M(r,a,e=""){return c(this,null,function*(){try{const{data:t,error:o}=yield n.from("images_metadata").update({moderation_status:"rejected",moderated_by:a,moderated_at:new Date().toISOString(),rejection_reason:e}).eq("id",r).select().single();if(o)throw o;return{success:!0,data:t}}catch(t){return u.error("Error rejecting image:",t),{success:!1,error:t.message}}})}function T(r,a){return c(this,null,function*(){try{const{data:e,error:t}=yield n.from("images_metadata").update({moderation_status:"approved",moderated_by:a,moderated_at:new Date().toISOString()}).in("id",r).select();if(t)throw t;return{success:!0,data:e}}catch(e){return u.error("Error bulk approving images:",e),{success:!1,error:e.message}}})}function D(r,a,e=""){return c(this,null,function*(){try{const{data:t,error:o}=yield n.from("images_metadata").update({moderation_status:"rejected",moderated_by:a,moderated_at:new Date().toISOString(),rejection_reason:e}).in("id",r).select();if(o)throw o;return{success:!0,data:t}}catch(t){return u.error("Error bulk rejecting images:",t),{success:!1,error:t.message}}})}function U(r,a){return c(this,null,function*(){try{const{data:e,error:t}=yield n.from("images_metadata").select("*").eq("id",r).single();if(t)throw t;if(e.usage_count>0)throw new Error("Cette image est utilisée dans des exercices et ne peut pas être supprimée.");const{error:o}=yield n.storage.from(e.storage_bucket).remove([e.storage_path]);if(o)throw o;const{error:s}=yield n.from("images_metadata").delete().eq("id",r);if(s)throw s;return{success:!0}}catch(e){return u.error("Error deleting image:",e),{success:!1,error:e.message}}})}function A(){return c(this,null,function*(){try{const{count:r,error:a}=yield n.from("images_metadata").select("*",{count:"exact",head:!0}).eq("moderation_status","pending");if(a)throw a;return{success:!0,count:r}}catch(r){return console.error("Error counting pending images:",r),{success:!1,error:r.message,count:0}}})}export{$ as a,k as b,T as c,D as d,U as e,A as f,M as r,j as s,v as u};
