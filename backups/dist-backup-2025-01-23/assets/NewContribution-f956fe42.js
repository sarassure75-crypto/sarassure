var Fe=Object.defineProperty,Te=Object.defineProperties;var Oe=Object.getOwnPropertyDescriptors;var me=Object.getOwnPropertySymbols;var Re=Object.prototype.hasOwnProperty,Pe=Object.prototype.propertyIsEnumerable;var pe=(x,o,c)=>o in x?Fe(x,o,{enumerable:!0,configurable:!0,writable:!0,value:c}):x[o]=c,F=(x,o)=>{for(var c in o||(o={}))Re.call(o,c)&&pe(x,c,o[c]);if(me)for(var c of me(o))Pe.call(o,c)&&pe(x,c,o[c]);return x},O=(x,o)=>Te(x,Oe(o));var R=(x,o,c)=>new Promise((V,w)=>{var s=b=>{try{h(c.next(b))}catch(S){w(S)}},v=b=>{try{h(c.throw(b))}catch(S){w(S)}},h=b=>b.done?V(b.value):Promise.resolve(b.value).then(s,v);h((c=c.apply(x,o)).next())});import{j as e}from"./radix-ui-2f58371e.js";import{f as Be,r as a}from"./react-vendor-6cf6ded9.js";import{u as Ue,s as E,a3 as We,a4 as Je}from"./index-426aa6f1.js";import{s as Ke}from"./imagesMetadata-470e1c8a.js";import{l as Me}from"./exerciseRequests-4362563c.js";import{C as $e}from"./CGUWarningBanner-349c5a68.js";import{S as Ge}from"./StepAreaEditor-aceba418.js";import{v as K}from"./v4-7fe747c7.js";import{k as Ze,ac as ne,A as xe,ah as he,v as Y,t as ge,u as ie,r as He}from"./ui-icons-e73ce4f7.js";import"./supabase-4b7d20da.js";import"./select-6c123d42.js";import"./index-d203b311.js";import"./index-cc17d877.js";import"./IconSelector-7450d470.js";function gt(){const x=Be(),{currentUser:o}=Ue(),[c,V]=a.useState(""),[w,s]=a.useState(""),[v,h]=a.useState(""),[b,S]=a.useState(""),[P,T]=a.useState("facile"),[L,n]=a.useState(""),[j,_]=a.useState(!1),[l,D]=a.useState([]),[U,B]=a.useState(null),[J,M]=a.useState(null),[G,Z]=a.useState(!1),[H,oe]=a.useState([]),[ee,r]=a.useState([]),[m,A]=a.useState({isOpen:!1,versionId:null}),[X,te]=a.useState(!1),[Q,$]=a.useState(!1),[W,se]=a.useState(null),[Ye,be]=a.useState(!1),[fe,ve]=a.useState(!0),[le,ye]=a.useState(!1),[re,je]=a.useState(null),[ce,_e]=a.useState(""),[ae,Ne]=a.useState(0);a.useEffect(()=>{we(),Se()},[]),a.useEffect(()=>{if(!c.trim()&&l.length===0)return;const t=setInterval(()=>{de()},3e4);return()=>clearInterval(t)},[c,w,v,b,P,l]);const we=()=>R(this,null,function*(){try{const t=yield Ke({moderationStatus:"approved"});t.success&&r(t.data||[])}catch(t){console.error("Erreur chargement images:",t)}}),de=()=>R(this,null,function*(){try{const t={id:W||K(),title:c,description:w,category:v,subcategory:b,difficulty:P,versions:l,savedAt:new Date().toISOString(),userId:o==null?void 0:o.id},u=JSON.parse(localStorage.getItem("contributionDrafts")||"[]"),f=u.findIndex(q=>q.id===t.id);f>=0?u[f]=t:u.push(t),localStorage.setItem("contributionDrafts",JSON.stringify(u)),W||se(t.id),$(!0),setTimeout(()=>$(!1),3e3)}catch(t){console.error("Erreur sauvegarde brouillon:",t)}}),Se=()=>R(this,null,function*(){var t,u,f,q;try{const C=new URLSearchParams(window.location.search),y=C.get("draft"),k=C.get("edit"),z=C.get("correction");if(y){const g=JSON.parse(localStorage.getItem("contributionDrafts")||"[]").find(d=>d.id===y);g&&(V(g.title),s(g.description),h(g.category),S(g.subcategory),T(g.difficulty),D(g.versions||[]),se(g.id))}else if(z){const{data:i,error:g}=yield E.from("versions").select(`
            *,
            task:task_id (
              id,
              title,
              description,
              category
            ),
            steps (
              id,
              step_order,
              instruction,
              action_type,
              target_area,
              text_input_area,
              start_area,
              expected_input,
              app_image_id,
              app_images:app_image_id (
                id,
                file_path,
                name
              )
            )
          `).eq("id",z).eq("creation_status","needs_changes").single();if(g){console.error("Erreur chargement version:",g),alert("Impossible de charger cette version."),x("/contributeur/mes-contributions");return}if(i){V(((t=i.task)==null?void 0:t.title)||""),s(((u=i.task)==null?void 0:u.description)||""),h(((f=i.task)==null?void 0:f.category)||""),ye(!0),je(i.original_submission_id||i.id),_e(i.admin_comments||""),Ne(i.modification_count||0);const d={id:i.id,task_id:i.task_id,name:i.name,icon_name:i.icon_name,pictogram_app_image_id:i.pictogram_app_image_id,video_url:i.video_url,steps:((q=i.steps)==null?void 0:q.map(p=>{var N,I;return{id:p.id,instruction:p.instruction,action_type:p.action_type,target_area:p.target_area,text_input_area:p.text_input_area,start_area:p.start_area,expected_input:p.expected_input,app_image_id:p.app_image_id,image_url:(N=p.app_images)!=null&&N.file_path?(I=E.storage.from("images").getPublicUrl(p.app_images.file_path).data)==null?void 0:I.publicUrl:null}}).sort((p,N)=>(p.step_order||0)-(N.step_order||0)))||[]};D([d])}}}catch(C){console.error("Erreur chargement:",C)}}),Ce=()=>R(this,null,function*(){te(!0),yield de(),te(!1),be(!1)}),ke=()=>{if(window.confirm("√ätes-vous s√ªr ? Le brouillon sera supprim√© d√©finitivement.")){if(W){const u=JSON.parse(localStorage.getItem("contributionDrafts")||"[]").filter(f=>f.id!==W);localStorage.setItem("contributionDrafts",JSON.stringify(u))}V(""),s(""),h(""),S(""),T("facile"),D([]),se(null),x("/contributeur/nouvelle-contribution")}},Ie=()=>{const t=[];return c.trim()||t.push("Le titre est requis"),w.trim()||t.push("La description est requise"),v||t.push("La cat√©gorie est requise"),l.length===0&&t.push("Au moins une version est requise"),oe(t),t.length===0},Ee=()=>{const t={id:K(),name:`Version ${l.length+1}`,icon_name:"ListChecks",pictogram_app_image_id:null,video_url:"",creation_status:"to_create",steps:[],isNew:!0};B(t.id),M(t)},De=t=>{if(J&&U){const u=l.findIndex(f=>f.id===U);if(u>=0){const f=[...l];f[u]=t,D(f)}else D([...l,t])}else D([...l,t]);B(null),M(null)},Ae=()=>{m.versionId&&D(l.filter(t=>t.id!==m.versionId)),A({isOpen:!1,versionId:null})},qe=t=>{const u=l.find(f=>f.id===t);u&&(B(t),M(F({},u)))},ze=()=>R(this,null,function*(){if(!Ie()){window.scrollTo({top:0,behavior:"smooth"});return}Z(!0);try{return le&&l.length>0?yield Le():yield Ve()}catch(t){console.error("Erreur soumission:",t),alert("‚ùå Erreur: "+t.message)}finally{Z(!1)}}),Ve=()=>R(this,null,function*(){var f;const{data:t,error:u}=yield E.from("tasks").insert([{title:c,description:w,category:v,icon_name:"help-circle",owner_id:o.id,is_public:!1,task_type:"normal",creation_status:{status:"pending",difficulty:P,created_at:new Date().toISOString()}}]).select().single();if(u)throw u;if(j&&L.trim())try{yield Me(L.trim(),t.id),console.log(`‚úì Exercice li√© √† la demande ${L}`)}catch(q){console.warn("Impossible de lier √† la demande:",q)}if(l.length>0){const q=l.map((y,k)=>({id:K(),task_id:t.id,name:y.name,icon_name:y.icon_name,pictogram_app_image_id:y.pictogram_app_image_id,creation_status:"pending",version_int:k+1}));let C=[];for(const y of q)try{const{data:k,error:z}=yield E.rpc("create_version",{p_task_id:y.task_id,p_description:y.name||null,p_video_url:null});if(!z&&k&&k.length>0)C.push(k[0]);else{const{data:i,error:g}=yield E.from("versions").insert(y).select().single();if(g)throw g;C.push(i)}}catch(k){console.warn("Erreur cr√©ation version, fallback:",k);const{data:z,error:i}=yield E.from("versions").insert(y).select().single();if(i)throw i;C.push(z)}for(let y=0;y<l.length;y++){const k=C[y],z=l[y].steps||[];if(z.length>0){const i=z.map((d,p)=>{var I;const N=["text_input","number_input"].includes(d.action_type)?"text_input_area":(I=d.action_type)!=null&&I.startsWith("swipe")||d.action_type==="scroll"?"start_area":"target_area";return{id:K(),version_id:k.id,instruction:d.instruction,action_type:d.action_type||"tap",app_image_id:d.image_id,[N]:d[N]||d.area||null,step_order:p,created_at:new Date().toISOString()}});let g=[];for(const d of i)try{const{data:p,error:N}=yield E.rpc("create_step",{p_version_id:d.version_id,p_step_order:d.step_order,p_step_type:d.action_type,p_content_text:d.instruction||null,p_areas:{app_image_id:d.app_image_id,[(f=d.action_type)!=null&&f.startsWith("swipe")||d.action_type==="scroll"?"start_area":"target_area"]:d.target_area||d.start_area||d.text_input_area||null}});if(!N&&p&&p.length>0)g.push(p[0]);else{const{data:I,error:ue}=yield E.from("steps").insert(d).select();if(ue)throw ue;g=g.concat(I)}}catch(p){console.warn("Erreur cr√©ation √©tape, fallback:",p);const{data:N,error:I}=yield E.from("steps").insert(d).select();if(I)throw I;g=g.concat(N)}}}}alert("‚úÖ Contribution soumise avec succ√®s ! Elle sera valid√©e par un administrateur."),x("/contributeur/mes-contributions")}),Le=()=>R(this,null,function*(){const t=l[0];if(!t||!t.id)throw new Error("Version introuvable pour la correction");const u={name:t.name||"Version corrig√©e",icon_name:t.icon_name||null,creation_status:"pending",modification_count:(ae||0)+1,updated_at:new Date().toISOString()};t.pictogram_app_image_id&&t.pictogram_app_image_id!=="undefined"&&(u.pictogram_app_image_id=t.pictogram_app_image_id),re&&re!=="undefined"&&(u.original_submission_id=re);const{error:f}=yield E.from("versions").update(u).eq("id",t.id);if(f)throw f;const q=t.task_id||t.taskId;if(!q||q==="undefined")throw new Error("ID de la t√¢che introuvable");const{error:C}=yield E.from("tasks").update({title:c,description:w,category:v,updated_at:new Date().toISOString()}).eq("id",q);if(C)throw C;const{error:y}=yield E.from("steps").delete().eq("version_id",t.id);if(y)throw y;if(t.steps&&t.steps.length>0){const k=t.steps.map((i,g)=>{var I;const d=["text_input","number_input"].includes(i.action_type)?"text_input_area":(I=i.action_type)!=null&&I.startsWith("swipe")||i.action_type==="scroll"?"start_area":"target_area",p={id:K(),version_id:t.id,instruction:i.instruction||"",action_type:i.action_type||"tap",step_order:g,created_at:new Date().toISOString()};i.app_image_id&&i.app_image_id!=="undefined"&&(p.app_image_id=i.app_image_id);const N=i[d]||i.area;return N&&(p[d]=N),p}),{error:z}=yield E.from("steps").insert(k);if(z)throw z}alert("‚úÖ Exercice corrig√© et resoumis avec succ√®s ! Il sera re-valid√© par un administrateur."),x("/contributeur/mes-contributions")});return U&&J?e.jsx(Xe,{version:J,images:ee,onSave:De,onCancel:()=>B(null),onDelete:()=>{A({isOpen:!0,versionId:U}),B(null)}}):e.jsxs("div",{className:"max-w-6xl mx-auto p-4 py-8",children:[fe&&e.jsx($e,{onClose:()=>ve(!1),onReadMore:()=>x("/contributeur/cgu")}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Nouvelle Contribution"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Cr√©ez un exercice pour enrichir la plateforme"}),Q&&e.jsxs("div",{className:"mt-3 flex items-center gap-2 text-sm text-green-700 bg-green-50 p-2 rounded-lg w-fit",children:[e.jsx(Ze,{className:"w-4 h-4"}),e.jsx("span",{children:"Brouillon sauvegard√© automatiquement"})]}),W&&e.jsx("div",{className:"mt-3 text-sm text-gray-600 flex items-center gap-2",children:e.jsxs("span",{children:["üíæ Brouillon #",W.slice(0,8),".."]})})]}),le&&e.jsx("div",{className:"mb-6 bg-orange-50 border border-orange-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(ne,{className:"h-5 w-5 text-orange-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-orange-900 mb-2",children:"üîß Mode correction - Exercice √† r√©viser"}),e.jsx("p",{className:"text-sm text-orange-800 mb-3",children:"Cet exercice a √©t√© renvoy√© par l'administrateur avec des commentaires. Apportez les corrections demand√©es puis resoumettez."}),ce&&e.jsxs("div",{className:"bg-orange-100 border border-orange-300 rounded p-3 mt-3",children:[e.jsx("p",{className:"text-sm font-medium text-orange-900 mb-1",children:"Commentaires de l'administrateur :"}),e.jsx("p",{className:"text-sm text-orange-800 whitespace-pre-wrap",children:ce})]}),ae>0&&e.jsxs("p",{className:"text-xs text-orange-600 mt-2",children:["Nombre de modifications : ",ae]})]})]})}),H.length>0&&e.jsx("div",{className:"mb-6 bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(xe,{className:"h-5 w-5 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-red-900 mb-2",children:"Erreurs de validation"}),e.jsx("ul",{className:"space-y-1 text-sm text-red-700",children:H.map((t,u)=>e.jsx("li",{children:t},u))})]})]})}),e.jsx("div",{className:"mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(xe,{className:"h-5 w-5 text-yellow-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-semibold mb-1",children:"‚ö†Ô∏è Interdiction stricte de donn√©es personnelles"}),e.jsx("p",{children:"Utilisez uniquement les contacts fictifs fournis et les fonds d'√©cran recommand√©s."})]})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 mb-6",children:e.jsx("div",{className:"p-6 space-y-6",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Informations g√©n√©rales"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Titre de l'exercice *"}),e.jsx("input",{type:"text",value:c,onChange:t=>V(t.target.value),placeholder:"Ex: Envoyer un message WhatsApp",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("input",{type:"checkbox",id:"hasRequestLink",checked:j,onChange:t=>_(t.target.checked),className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"}),e.jsx("label",{htmlFor:"hasRequestLink",className:"text-sm font-medium text-gray-900 cursor-pointer",children:"Cet exercice correspond √† une demande de la liste"})]}),j&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Code de la demande"}),e.jsx("input",{type:"text",value:L,onChange:t=>n(t.target.value.toUpperCase()),placeholder:"Ex: EX-2025-001",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono"}),e.jsx("p",{className:"text-xs text-blue-700 mt-1",children:"üí° Consultez la liste des exercices √† cr√©er pour trouver le code"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Description *"}),e.jsx("textarea",{value:w,onChange:t=>s(t.target.value),placeholder:"D√©crivez l'objectif p√©dagogique...",rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Cat√©gorie *"}),e.jsxs("select",{value:v,onChange:t=>h(t.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:"S√©lectionner..."}),e.jsx("option",{value:"Communication",children:"Communication"}),e.jsx("option",{value:"R√©seaux sociaux",children:"R√©seaux sociaux"}),e.jsx("option",{value:"Param√®tres",children:"Param√®tres"}),e.jsx("option",{value:"Applications",children:"Applications"}),e.jsx("option",{value:"S√©curit√©",children:"S√©curit√©"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Sous-cat√©gorie"}),e.jsx("input",{type:"text",value:b,onChange:t=>S(t.target.value),placeholder:"Ex: WhatsApp",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Difficult√©"}),e.jsxs("select",{value:P,onChange:t=>T(t.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"facile",children:"Facile"}),e.jsx("option",{value:"moyen",children:"Moyen"}),e.jsx("option",{value:"difficile",children:"Difficile"})]})]})]})]})]})})}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 mb-6",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["Versions (",l.length,")"]}),e.jsx("p",{className:"text-sm text-gray-600",children:"Cr√©ez des variantes de votre exercice"})]}),e.jsxs("button",{onClick:Ee,className:"flex items-center space-x-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsx("span",{children:"Ajouter une version"})]})]}),l.length===0?e.jsx("p",{className:"text-gray-500 text-center py-8",children:'Aucune version. Cliquez sur "Ajouter une version" pour commencer.'}):e.jsx("div",{className:"space-y-3",children:l.map(t=>{var u;return e.jsx("div",{className:"p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold",children:t.name}),e.jsxs("div",{className:"flex items-center gap-3 mt-2 text-sm text-gray-600",children:[e.jsx("span",{className:"inline-block px-2 py-1 bg-gray-200 rounded text-xs",children:t.creation_status||"to_create"}),e.jsxs("span",{children:[((u=t.steps)==null?void 0:u.length)||0," √©tape(s)"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>qe(t.id),className:"p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",children:e.jsx(ne,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>A({isOpen:!0,versionId:t.id}),className:"p-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors",children:e.jsx(Y,{className:"w-4 h-4"})})]})]})},t.id)})})]})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>x("/contributeur"),className:"px-6 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",children:"Annuler"}),W&&e.jsx("button",{onClick:ke,className:"px-6 py-2 text-red-700 hover:bg-red-50 rounded-lg transition-colors text-sm",children:"Supprimer brouillon"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:Ce,disabled:X||!c.trim()&&l.length===0,className:"flex items-center space-x-2 px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:X?e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"Sauvegarde..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"w-4 h-4"}),e.jsx("span",{children:"Sauvegarder en brouillon"})]})}),e.jsx("button",{onClick:ze,disabled:G||l.length===0,className:"flex items-center space-x-2 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:G?e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"Soumission..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(He,{className:"w-4 h-4"}),e.jsx("span",{children:"Soumettre pour validation"})]})})]})]}),m.isOpen&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 max-w-sm w-full mx-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"√ätes-vous s√ªr ?"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Cette action est irr√©versible. La version sera supprim√©e d√©finitivement."}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{onClick:()=>A({isOpen:!1,versionId:null}),className:"px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",children:"Annuler"}),e.jsx("button",{onClick:Ae,className:"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors",children:"Supprimer"})]})]})})]})}function Xe({version:x,images:o,onSave:c,onCancel:V,onDelete:w}){const[s,v]=a.useState(x),[h,b]=a.useState(null),S=(n,j)=>{v(O(F({},s),{[n]:j}))},P=()=>{const n={id:K(),instruction:"",action_type:"tap",image_id:null,step_order:(s.steps||[]).length,isNew:!0};b(n)},T=n=>{const j=s.steps||[],_=j.findIndex(D=>D.id===n.id);let l;_>=0?(l=[...j],l[_]=n):l=[...j,n],v(O(F({},s),{steps:l})),b(null)},L=n=>{v(O(F({},s),{steps:(s.steps||[]).filter(j=>j.id!==n)}))};return h?e.jsx("div",{className:"max-w-4xl mx-auto p-4",children:e.jsx(Qe,{step:h,images:o,onSave:T,onCancel:()=>b(null),onDelete:()=>{L(h.id),b(null)}})}):e.jsxs("div",{className:"max-w-4xl mx-auto p-4",children:[e.jsx("button",{onClick:V,className:"mb-6 px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",children:"‚Üê Retour"}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 mb-6",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"√âditer la Version"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Nom de la version"}),e.jsx("input",{type:"text",value:s.name,onChange:n=>S("name",n.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Ic√¥ne (Lucide Icon)"}),e.jsx("input",{type:"text",value:s.icon_name,onChange:n=>S("icon_name",n.target.value),placeholder:"Ex: ListChecks",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Pictogramme"}),e.jsxs("select",{value:s.pictogram_app_image_id||"",onChange:n=>S("pictogram_app_image_id",n||null),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:"Aucun"}),o.filter(n=>n.source==="admin").map(n=>e.jsx("option",{value:n.id,children:n.name||n.title},n.id))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"URL Vid√©o"}),e.jsx("input",{type:"text",value:s.video_url||"",onChange:n=>S("video_url",n.target.value),placeholder:"https://www.youtube.com/watch?v=...",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})]})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 mb-6",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h2",{className:"text-xl font-semibold",children:["√âtapes (",(s.steps||[]).length,")"]}),e.jsxs("button",{onClick:P,className:"flex items-center space-x-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors",children:[e.jsx(he,{className:"w-4 h-4"}),e.jsx("span",{children:"Ajouter une √©tape"})]})]}),(s.steps||[]).length===0?e.jsx("p",{className:"text-gray-500 text-center py-8",children:"Aucune √©tape"}):e.jsx("div",{className:"space-y-2",children:(s.steps||[]).map((n,j)=>e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg flex items-center justify-between border border-gray-200",children:[e.jsxs("span",{className:"font-medium text-sm",children:["√âtape ",j+1,": ",n.instruction.substring(0,50),n.instruction.length>50?"...":""]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>b(n),className:"p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",children:e.jsx(ne,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>L(n.id),className:"p-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors",children:e.jsx(Y,{className:"w-4 h-4"})})]})]},n.id))})]})}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("button",{onClick:V,className:"px-6 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",children:"Annuler"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:w,className:"px-6 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors flex items-center gap-2",children:[e.jsx(Y,{className:"w-4 h-4"}),e.jsx("span",{children:"Supprimer"})]}),e.jsxs("button",{onClick:()=>c(s),className:"px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2",children:[e.jsx(ie,{className:"w-4 h-4"}),e.jsx("span",{children:"Sauvegarder"})]})]})]})]})}function Qe({step:x,images:o,onSave:c,onCancel:V,onDelete:w}){const[s,v]=a.useState(x),[h,b]=a.useState(null),[S,P]=a.useState({width:0,height:0}),[T,L]=a.useState("all"),[n,j]=a.useState("all"),[_,l]=a.useState("Capture d'√©cran"),[D,U]=a.useState([]);a.useEffect(()=>{(()=>R(this,null,function*(){if(_&&_!=="all"){const m=yield Je(_,!0);m&&m.length>0?U(m):U([])}}))(),L("all")},[_]);const B=o.filter(r=>!(_!=="all"&&r.category!==_||T!=="all"&&r.subcategory!==T||n!=="all"&&r.android_version!==n)),J=a.useMemo(()=>{const r=o.filter(m=>_==="all"||m.category===_).map(m=>m.android_version).filter(m=>m&&m!==null&&m!=="");return["all",...new Set(r)].sort((m,A)=>{var Q,$;if(m==="all")return-1;if(A==="all")return 1;const X=parseInt(((Q=m.match(/\d+/))==null?void 0:Q[0])||"0");return parseInt((($=A.match(/\d+/))==null?void 0:$[0])||"0")-X})},[o,_]);a.useEffect(()=>{if(s.image_id){const r=o.find(m=>m.id===s.image_id);b(r)}},[s.image_id,o]);const M=r=>{v(O(F({},s),{action_type:r}))},G=r=>{if(v(O(F({},s),{image_id:r||null})),r){const m=o.find(A=>A.id===r);b(m)}else b(null)},Z=r=>{var A;const m=["text_input","number_input"].includes(s.action_type)?"text_input_area":(A=s.action_type)!=null&&A.startsWith("swipe")||s.action_type==="scroll"?"start_area":"target_area";v(O(F({},s),{[m]:r}))},H=r=>{P(r)},ee=s[(()=>{var r;return["text_input","number_input"].includes(s.action_type)?"text_input_area":(r=s.action_type)!=null&&r.startsWith("swipe")||s.action_type==="scroll"?"start_area":"target_area"})()];return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 min-h-screen flex flex-col",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsx("h2",{className:"text-xl font-semibold",children:"√âditer l'√©tape"})}),e.jsxs("div",{className:"flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 p-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Instruction *"}),e.jsx("textarea",{value:s.instruction,onChange:r=>v(O(F({},s),{instruction:r.target.value})),placeholder:"Ex: Appuyez sur l'ic√¥ne WhatsApp",rows:2,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Type d'action *"}),e.jsxs("select",{value:s.action_type||"",onChange:r=>M(r.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",children:[e.jsx("option",{value:"",children:"S√©lectionner un type"}),We.map(r=>e.jsx("option",{value:r.id,children:r.label},r.id))]})]}),s.action_type==="text_input"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Texte √† saisir"}),e.jsx("input",{type:"text",value:s.text_value||"",onChange:r=>v(O(F({},s),{text_value:r.target.value})),placeholder:"Ex: Bonjour",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Le texte exact √† saisir dans le clavier"})]}),s.action_type==="number_input"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Num√©ro √† saisir"}),e.jsx("input",{type:"text",value:s.number_value||"",onChange:r=>v(O(F({},s),{number_value:r.target.value})),placeholder:"Ex: 123456789",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Le num√©ro exact √† saisir sur le clavier num√©rique"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Filtres pour les images"}),e.jsx("div",{className:"mb-2",children:e.jsxs("select",{value:_,onChange:r=>l(r.target.value),className:"w-full px-3 py-1.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",children:[e.jsx("option",{value:"all",children:"Toutes cat√©gories"}),e.jsx("option",{value:"Capture d'√©cran",children:"Capture d'√©cran"}),e.jsx("option",{value:"Fond d'√©cran",children:"Fond d'√©cran"}),e.jsx("option",{value:"Ic√¥ne",children:"Ic√¥ne"}),e.jsx("option",{value:"Autre",children:"Autre"})]})}),D.length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Sous-cat:"}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[e.jsx("button",{type:"button",onClick:()=>L("all"),className:`px-2 py-1 rounded text-xs ${T==="all"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Toutes"}),D.map(r=>e.jsx("button",{type:"button",onClick:()=>L(r),className:`px-2 py-1 rounded text-xs ${T===r?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:r},r))]})]}),J.length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Android:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:J.map(r=>e.jsx("button",{type:"button",onClick:()=>j(r),className:`px-2 py-1 rounded text-xs ${n===r?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:r==="all"?"Toutes":r},r))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Image de capture *"}),e.jsxs("select",{value:s.image_id||"",onChange:r=>G(r.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm",children:[e.jsx("option",{value:"",children:"S√©lectionner une image"}),B.map(r=>e.jsx("option",{value:r.id,children:r.title||r.name},r.id))]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[B.length," image(s) disponible(s)"]})]}),s.action_type&&s.action_type!=="bravo"&&h&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"üí° Zone d'action"}),e.jsxs("p",{className:"text-xs",children:[["tap","double_tap","long_press"].includes(s.action_type)&&"Tracez le bouton √† cliquer",["swipe_left","swipe_right","swipe_up","swipe_down","scroll"].includes(s.action_type)&&"Tracez la direction",s.action_type==="drag_and_drop"&&"Tracez le glisser",["text_input","number_input"].includes(s.action_type)&&"Tracez le champ"]})]}),s.action_type==="bravo"&&h&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3 text-sm text-green-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"üéâ Bravo"}),e.jsx("p",{className:"text-xs",children:"Cette √©tape affichera uniquement la capture d'√©cran de f√©licitations sans zone d'action √† cliquer."})]})]}),e.jsx("div",{className:"lg:col-span-2",children:h&&s.action_type&&s.action_type!=="bravo"?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border border-gray-300 rounded-lg bg-gray-100 overflow-auto",style:{maxHeight:"600px"},children:e.jsx(Ge,{imageUrl:h.public_url,area:ee,onAreaChange:Z,onImageLoad:H})}),e.jsx("p",{className:"text-xs text-gray-500 text-center",children:"Cliquez et glissez sur l'image pour dessiner la zone d'action"})]}):h&&s.action_type==="bravo"?e.jsxs("div",{className:"border border-gray-300 rounded-lg bg-gray-50 overflow-hidden",children:[e.jsx("img",{src:h.public_url,alt:"Capture finale",className:"w-full h-auto"}),e.jsx("div",{className:"p-4 text-center bg-green-50",children:e.jsx("p",{className:"text-sm text-green-800",children:"üéâ Capture d'√©cran de f√©licitations (aucune zone d'action requise)"})})]}):e.jsx("div",{className:"border border-dashed border-gray-300 rounded-lg p-8 bg-gray-50 flex items-center justify-center min-h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-gray-500 text-sm mb-2",children:h?"‚öôÔ∏è S√©lectionnez un type d'action":"üëÜ S√©lectionnez une image"}),e.jsx("p",{className:"text-xs text-gray-400",children:h?"pour pouvoir √©diter la zone":"pour voir l'aper√ßu"})]})})})]}),e.jsxs("div",{className:"px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-between items-center rounded-b-lg",children:[e.jsx("button",{onClick:V,className:"px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors",children:"Annuler"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:w,className:"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors flex items-center gap-2",children:[e.jsx(Y,{className:"w-4 h-4"}),e.jsx("span",{children:"Supprimer"})]}),e.jsxs("button",{onClick:()=>c(s),disabled:!s.instruction.trim()||!s.action_type||!s.image_id,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(ie,{className:"w-4 h-4"}),e.jsx("span",{children:"Sauvegarder"})]})]})]})]})}export{gt as default};
