var F=(m,B,i)=>new Promise((S,r)=>{var u=f=>{try{h(i.next(f))}catch(y){r(y)}},z=f=>{try{h(i.throw(f))}catch(y){r(y)}},h=f=>f.done?S(f.value):Promise.resolve(f.value).then(u,z);h((i=i.apply(m,B)).next())});import{j as s}from"./radix-ui-2f58371e.js";import{r as d}from"./react-vendor-6cf6ded9.js";import{D as Z,n as _,o as ee,p as te,q as se,e as C,a6 as ne}from"./index-426aa6f1.js";import{aj as ae,bf as P,b3 as oe,bg as re,D as ce}from"./ui-icons-e73ce4f7.js";function me({open:m,onOpenChange:B,imageUrl:i,onSave:S}){const r=d.useRef(null),[u,z]=d.useState(null),[h,f]=d.useState("blur"),[y,N]=d.useState(!1),[j,A]=d.useState({x:0,y:0}),[b,M]=d.useState([]),[x,D]=d.useState(-1),[ie,q]=d.useState(null),[I,k]=d.useState(!1),[R,T]=d.useState(!1),[E,X]=d.useState(!1);d.useEffect(()=>{console.log("üì¶ ImageEditor mont√© - Props:",{open:m,imageUrl:(i==null?void 0:i.substring(0,50))+"..."})},[m,i]),d.useEffect(()=>{m||X(!1)},[m]),d.useEffect(()=>{if(!m){T(!1);return}if(r.current&&!R){console.log("‚úÖ Canvas d√©tect√© et pr√™t!"),T(!0);return}console.log("üîç V√©rification canvas, tentative programm√©e...");const e=setTimeout(()=>{r.current&&!R&&(console.log("‚úÖ Canvas d√©tect√© et pr√™t (apr√®s d√©lai)!"),T(!0))},50);return()=>clearTimeout(e)},[m,R]),d.useEffect(()=>{if(console.log("üîÑ useEffect image loading - Conditions:",{open:m,hasImageUrl:!!i,hasCanvasRef:!!r.current,canvasReady:R,imageUrl:i==null?void 0:i.substring(0,60)}),!m||!i){console.log("‚ùå Chargement annul√© - open ou imageUrl manquant");return}if(!r.current||!R){console.log("‚è≥ Attente du canvas...");return}const e=r.current,t=e.getContext("2d",{willReadFrequently:!0});z(t),console.log("‚úÖ Chargement de l'image:",i);const n=()=>F(this,null,function*(){try{console.log("Tentative de chargement via fetch...");const a=yield fetch(i,{mode:"cors",credentials:"omit"});if(!a.ok)throw new Error(`HTTP ${a.status}`);const c=yield a.blob();console.log("Blob re√ßu:",c.size,"bytes");const o=new Image,g=URL.createObjectURL(c);o.onload=()=>{console.log("Image charg√©e:",o.width,"x",o.height);const p=1920;let w=o.width,v=o.height;w>p&&(v=v*p/w,w=p),e.width=w,e.height=v,t.clearRect(0,0,w,v),t.drawImage(o,0,0,w,v),console.log("Image dessin√©e sur le canvas"),q(o),k(!0),setTimeout(()=>Y(),100),URL.revokeObjectURL(g)},o.onerror=p=>{console.error("Erreur img.onload:",p),URL.revokeObjectURL(g),l()},o.src=g}catch(a){console.error("Erreur fetch:",a),l()}}),l=()=>{console.log("Tentative de chargement direct...");const a=new Image;a.crossOrigin="anonymous",a.onload=()=>{console.log("Image charg√©e (direct):",a.width,"x",a.height);const c=1920;let o=a.width,g=a.height;o>c&&(g=g*c/o,o=c),e.width=o,e.height=g,t.clearRect(0,0,o,g),t.drawImage(a,0,0,o,g),q(a),k(!0),setTimeout(()=>Y(),100)},a.onerror=c=>{console.error("Erreur chargement direct:",c),alert("Impossible de charger l'image. L'URL peut √™tre invalide ou inaccessible.")},a.src=i};return n(),()=>{k(!1),M([]),D(-1)}},[m,i,R]);const Y=()=>{if(!r.current)return;const t=r.current.toDataURL(),n=b.slice(0,x+1);n.push(t),M(n),D(n.length-1)},U=()=>{if(x>0){const e=x-1;D(e),L(b[e])}},W=()=>{if(x<b.length-1){const e=x+1;D(e),L(b[e])}},L=e=>{const t=r.current,n=t.getContext("2d"),l=new Image;l.onload=()=>{n.clearRect(0,0,t.width,t.height),n.drawImage(l,0,0)},l.src=e},$=(e,t,n,l)=>{if(!u||!r.current)return;r.current;const a=u.getImageData(e,t,n,l);a.data;const c=document.createElement("canvas");c.width=n,c.height=l,c.getContext("2d").putImageData(a,0,0),u.filter="blur(15px)",u.drawImage(c,e,t),u.filter="none"},H=(e,t,n,l,a)=>{u&&(u.fillStyle=a,u.fillRect(e,t,n,l))},V=e=>{if(!I)return;const t=r.current,n=t.getBoundingClientRect(),l=t.width/n.width,a=t.height/n.height,c=(e.clientX-n.left)*l,o=(e.clientY-n.top)*a;A({x:c,y:o}),N(!0)},G=e=>{if(!y||!u||!r.current)return;const t=r.current,n=t.getBoundingClientRect(),l=t.width/n.width,a=t.height/n.height,c=(e.clientX-n.left)*l,o=(e.clientY-n.top)*a;b[x]&&L(b[x]),u.strokeStyle=h==="blur"?"#3b82f6":h==="whiteBox"?"#fff":"#000",u.lineWidth=2,u.setLineDash([5,5]),u.strokeRect(j.x,j.y,c-j.x,o-j.y),u.setLineDash([])},J=e=>{if(!y)return;const t=r.current,n=t.getBoundingClientRect(),l=t.width/n.width,a=t.height/n.height,c=(e.clientX-n.left)*l,o=(e.clientY-n.top)*a,g=Math.min(j.x,c),p=Math.min(j.y,o),w=Math.abs(c-j.x),v=Math.abs(o-j.y);w>5&&v>5&&(b[x]&&L(b[x]),setTimeout(()=>{h==="blur"?$(g,p,w,v):h==="whiteBox"?H(g,p,w,v,"#ffffff"):h==="blackBox"&&H(g,p,w,v,"#000000"),Y()},10)),N(!1)},K=()=>{!r.current||E||(X(!0),r.current.toBlob(e=>{e&&S?S(e):X(!1)},"image/png"))},Q=()=>{if(!r.current)return;const e=r.current.toDataURL("image/png"),t=document.createElement("a");t.download=`edited-image-${Date.now()}.png`,t.href=e,t.click()},O=()=>{M([]),D(-1),k(!1),N(!1),B(!1)};return s.jsx(Z,{open:m,onOpenChange:O,children:s.jsxs(_,{className:"max-w-6xl max-h-[90vh] overflow-hidden flex flex-col",children:[s.jsxs(ee,{children:[s.jsx(te,{children:"√âditeur d'image - Prot√©ger les informations personnelles"}),s.jsx(se,{children:"Utilisez les outils pour flouter ou masquer les informations sensibles sur vos captures d'√©cran."})]}),s.jsxs("div",{className:"flex items-center gap-2 py-3 border-b",children:[s.jsxs(C,{variant:h==="blur"?"default":"outline",size:"sm",onClick:()=>f("blur"),className:"flex items-center gap-2",children:[s.jsx(ae,{className:"w-4 h-4"}),"Flou"]}),s.jsxs(C,{variant:h==="whiteBox"?"default":"outline",size:"sm",onClick:()=>f("whiteBox"),className:"flex items-center gap-2",children:[s.jsx(P,{className:"w-4 h-4"}),"Cadre blanc"]}),s.jsxs(C,{variant:h==="blackBox"?"default":"outline",size:"sm",onClick:()=>f("blackBox"),className:"flex items-center gap-2",children:[s.jsx(P,{className:"w-4 h-4 fill-current"}),"Cadre noir"]}),s.jsx("div",{className:"border-l h-6 mx-2"}),s.jsxs(C,{variant:"outline",size:"sm",onClick:U,disabled:x<=0,className:"flex items-center gap-2",children:[s.jsx(oe,{className:"w-4 h-4"}),"Annuler"]}),s.jsxs(C,{variant:"outline",size:"sm",onClick:W,disabled:x>=b.length-1,className:"flex items-center gap-2",children:[s.jsx(re,{className:"w-4 h-4"}),"Refaire"]}),s.jsx("div",{className:"border-l h-6 mx-2"}),s.jsxs(C,{variant:"outline",size:"sm",onClick:Q,disabled:!I,className:"flex items-center gap-2",children:[s.jsx(ce,{className:"w-4 h-4"}),"T√©l√©charger"]})]}),s.jsxs("div",{className:"flex-1 overflow-auto bg-gray-100 p-4",children:[!I&&s.jsx("div",{className:"text-center text-gray-500 flex items-center justify-center h-full",children:s.jsxs("div",{children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),s.jsx("p",{children:"Chargement de l'image..."}),s.jsx("p",{className:"text-sm mt-2",children:"Si le chargement √©choue, v√©rifiez la console (F12)"})]})}),s.jsx("canvas",{ref:r,onMouseDown:V,onMouseMove:G,onMouseUp:J,onMouseLeave:()=>N(!1),className:"cursor-crosshair bg-white shadow-lg mx-auto",style:{imageRendering:"crisp-edges",cursor:"crosshair",display:I?"block":"none"}})]}),s.jsxs("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded",children:[s.jsx("strong",{children:"Instructions :"})," S√©lectionnez un outil, puis cliquez et glissez sur l'image pour cr√©er une zone ",h==="blur"?"flout√©e":"masqu√©e","."]}),s.jsxs(ne,{children:[s.jsx(C,{variant:"outline",onClick:O,disabled:E,children:"Annuler"}),s.jsx(C,{onClick:K,disabled:!I||E,children:E?"Sauvegarde...":"Enregistrer les modifications"})]})]})})}export{me as I};
