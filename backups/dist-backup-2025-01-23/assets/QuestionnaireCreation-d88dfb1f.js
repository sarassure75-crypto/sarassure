var xe=Object.defineProperty,he=Object.defineProperties;var ge=Object.getOwnPropertyDescriptors;var V=Object.getOwnPropertySymbols;var pe=Object.prototype.hasOwnProperty,be=Object.prototype.propertyIsEnumerable;var G=(d,c,l)=>c in d?xe(d,c,{enumerable:!0,configurable:!0,writable:!0,value:l}):d[c]=l,h=(d,c)=>{for(var l in c||(c={}))pe.call(c,l)&&G(d,l,c[l]);if(V)for(var l of V(c))be.call(c,l)&&G(d,l,c[l]);return d},g=(d,c)=>he(d,ge(c));var E=(d,c,l)=>new Promise((y,S)=>{var I=x=>{try{f(l.next(x))}catch(m){S(m)}},A=x=>{try{f(l.throw(x))}catch(m){S(m)}},f=x=>x.done?y(x.value):Promise.resolve(x.value).then(I,A);f((l=l.apply(d,c)).next())});import{j as e}from"./radix-ui-2f58371e.js";import{f as fe,r as p}from"./react-vendor-6cf6ded9.js";import{u as je,i as Ne,s as w,C as _,k as H,l as K,j as $,e as b}from"./index-426aa6f1.js";import{I as P}from"./IconSelector-7450d470.js";import{ah as X,K as ve,v as Y,I as Z,X as ye}from"./ui-icons-e73ce4f7.js";import{v as T}from"./v4-7fe747c7.js";import"./supabase-4b7d20da.js";const Ae=()=>{const d=fe(),{currentUser:c}=je(),{toast:l}=Ne(),[y,S]=p.useState(""),[I,A]=p.useState(""),[f,x]=p.useState(""),[m,N]=p.useState([]),[z,q]=p.useState([]),[ee,se]=p.useState([]),[O,J]=p.useState(!1),[re,R]=p.useState(!1);p.useEffect(()=>{te(),ae()},[]);const te=()=>E(void 0,null,function*(){try{const{data:s,error:t}=yield w.from("app_images").select("id, name, file_path, description, category").eq("category","QCM").order("name");if(t)throw t;q(s||[])}catch(s){console.error("Erreur chargement images QCM:",s)}}),ae=()=>E(void 0,null,function*(){try{const{data:s,error:t}=yield w.from("tasks").select("category").neq("category",null);if(t)throw t;const r=[...new Set((s==null?void 0:s.map(a=>a.category))||[])];se(r.filter(Boolean).sort())}catch(s){console.error("Erreur chargement catÃ©gories:",s)}}),ie=()=>{const s={id:T(),text:"",helpText:"",questionType:"mixed",icon:null,imageId:null,imageName:"",choices:Array(6).fill(null).map(()=>({id:T(),imageId:null,imageName:"",icon:null,text:"",isCorrect:!1}))};N(t=>[...t,s])},ne=s=>{N(t=>t.filter(r=>r.id!==s))},j=(s,t,r)=>{N(a=>a.map(n=>n.id===s?g(h({},n),{[t]:r}):n))},le=s=>{N(t=>t.map(r=>r.id!==s||r.choices.length>=6?r:g(h({},r),{choices:[...r.choices,{id:T(),imageId:null,imageName:"",icon:null,text:"",isCorrect:!1}]})))},oe=(s,t)=>{N(r=>r.map(a=>a.id!==s||a.choices.length<=2?a:g(h({},a),{choices:a.choices.filter(n=>n.id!==t)})))},v=(s,t,r,a)=>{N(n=>n.map(o=>o.id!==s?o:g(h({},o),{choices:o.choices.map(k=>k.id===t?g(h({},k),{[r]:a}):k)})))},ce=(s,t)=>{N(r=>r.map(a=>a.id!==s?a:g(h({},a),{choices:a.choices.map(n=>n.id===t?g(h({},n),{isCorrect:!n.isCorrect}):n)})))},de=()=>{const s=[];return y.trim()||s.push("Le titre est requis"),f||s.push("La catÃ©gorie est requise"),m.length===0&&s.push("Au moins une question est requise"),m.forEach((t,r)=>{t.text.trim()||s.push(`Question ${r+1}: le texte est requis`);const a=t.choices.filter(o=>o.imageId||o.icon||o.text.trim());console.log(`ðŸ“‹ Q${r+1} validation:`,{totalChoices:t.choices.length,choicesWithContent:a.length,choices:t.choices.map(o=>({id:o.id.substring(0,5),text:o.text,isCorrect:o.isCorrect,hasImage:!!o.imageId,hasIcon:!!o.icon}))}),a.length<2&&s.push(`Question ${r+1}: au moins deux rÃ©ponses (texte, image ou icÃ´ne) sont requises`),a.filter(o=>o.isCorrect).length===0&&s.push(`Question ${r+1}: au moins une rÃ©ponse doit Ãªtre marquÃ©e correcte`)}),console.log("ðŸ” Validation errors:",s),s},me=()=>{const s={id:T(),type:"questionnaire",title:y,description:I,category:f,questions:m},t=JSON.parse(localStorage.getItem("questionnaireDrafts")||"[]"),r=t.findIndex(a=>a.id===s.id);r>=0?t[r]=s:t.push(s),localStorage.setItem("questionnaireDrafts",JSON.stringify(t)),R(!0),l({title:"Brouillon sauvegardÃ©",description:"Votre questionnaire a Ã©tÃ© sauvegardÃ© localement"}),setTimeout(()=>R(!1),3e3)},ue=()=>E(void 0,null,function*(){const s=de();if(s.length>0){l({title:"Erreurs de validation",description:s.join(`
`),variant:"destructive"});return}J(!0);try{const{data:{user:t}}=yield w.auth.getUser();if(!t){l({title:"Erreur",description:"Utilisateur non authentifiÃ©",variant:"destructive"});return}const{data:r,error:a}=yield w.from("tasks").insert([{title:y,description:I.trim()||null,category:f,owner_id:t.id,task_type:"questionnaire"}]).select().single();if(a)throw a;const{data:n,error:o}=yield w.from("versions").insert([{task_id:r.id,name:"Version 1",version:1,creation_status:"pending"}]).select().single();if(o)throw o;const k=m.map((u,C)=>{var L;const Q=u.choices.map(i=>g(h({},i),{text:i.text.trim()}));console.log(`ðŸ” DEBUG Q${C+1} - Avant JSON:`,{totalChoices:Q.length,choices:Q.map(i=>({id:i.id.substring(0,5),text:i.text,isCorrect:i.isCorrect,hasImage:!!i.imageId,hasIcon:!!i.icon}))});const D=Q.filter(i=>i.isCorrect).map(i=>i.id);console.log(`âœ… Correct answers for Q${C+1}:`,D.length,"IDs:",D.map(i=>i.substring(0,5)));const U={questionType:"mixed",type:"mixed",imageId:u.imageId,imageName:u.imageName,iconId:((L=u.icon)==null?void 0:L.id)||null,icon:u.icon?{id:u.icon.id,library:u.icon.library,name:u.icon.displayName||u.icon.name}:null,choices:Q.map(i=>{var M;return{id:i.id,imageId:i.imageId,imageName:i.imageName,text:i.text,iconId:((M=i.icon)==null?void 0:M.id)||null,icon:i.icon?{id:i.icon.id,library:i.icon.library,name:i.icon.displayName||i.icon.name}:null,isCorrect:i.isCorrect}}),correctAnswers:D},B=U.choices.filter(i=>i.isCorrect);console.log(`ðŸ“Š Q${C+1} has ${B.length} correct choices in final JSON`),B.length===0&&console.warn(`âš ï¸ WARNING: Question ${C+1} has NO correct answers in JSON!`);const F=JSON.stringify(U);return console.log(`ðŸ“¤ Q${C+1} JSON size: ${F.length} bytes`),{version_id:n.id,step_order:C+1,instruction:u.text,expected_input:F}}),{error:W}=yield w.from("steps").insert(k);if(W)throw W;l({title:"SuccÃ¨s!",description:"Votre questionnaire a Ã©tÃ© crÃ©Ã© et soumis pour validation"}),d("/contributeur/mes-contributions")}catch(t){console.error("Erreur:",t),l({title:"Erreur",description:t.message,variant:"destructive"})}finally{J(!1)}});return c?e.jsx("div",{className:"min-h-screen bg-gray-50 py-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold text-gray-900",children:"CrÃ©er un Questionnaire"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"CrÃ©ez un exercice d'apprentissage basÃ© sur la sÃ©lection d'images, d'icÃ´nes ou de texte."})]}),e.jsxs(_,{className:"mb-6",children:[e.jsx(H,{children:e.jsx(K,{children:"Informations gÃ©nÃ©rales"})}),e.jsxs($,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Titre du questionnaire *"}),e.jsx("input",{type:"text",value:y,onChange:s=>S(s.target.value),placeholder:"Ex: Identifier les paramÃ¨tres Wi-Fi",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Description"}),e.jsx("textarea",{value:I,onChange:s=>A(s.target.value),placeholder:"DÃ©crivez l'objectif de ce questionnaire (optionnel)...",rows:3,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsx("div",{className:"grid grid-cols-2 gap-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"CatÃ©gorie *"}),e.jsxs("select",{value:f,onChange:s=>x(s.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:"SÃ©lectionner..."}),ee.map(s=>e.jsx("option",{value:s,children:s},s))]})]})})]})]}),e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h2",{className:"text-2xl font-bold",children:["Questions (",m.length,")"]}),e.jsxs(b,{onClick:ie,className:"gap-2",children:[e.jsx(X,{className:"w-4 h-4"}),"Ajouter une question"]})]}),m.length===0?e.jsx(_,{className:"border-dashed",children:e.jsxs($,{className:"flex flex-col items-center justify-center py-12 text-gray-500",children:[e.jsx(ve,{className:"w-12 h-12 mb-4 text-gray-300"}),e.jsx("p",{children:"Aucune question ajoutÃ©e"}),e.jsx("p",{className:"text-sm",children:'Cliquez sur "Ajouter une question" pour commencer'})]})}):m.map((s,t)=>e.jsxs(_,{children:[e.jsx(H,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx("div",{children:e.jsxs(K,{className:"text-lg",children:["Question ",t+1]})}),e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>ne(s.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:e.jsx(Y,{className:"w-4 h-4"})})]})}),e.jsxs($,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Texte de la question *"}),e.jsx("input",{type:"text",value:s.text,onChange:r=>j(s.id,"text",r.target.value),placeholder:"Ex: Quelle capture montre le menu des paramÃ¨tres Wi-Fi?",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"IcÃ´ne de la question (optionnel)"}),e.jsx(P,{selectedIcon:s.icon,onSelect:r=>j(s.id,"icon",r),onRemove:()=>j(s.id,"icon",null),libraries:["fa6","bs","md","fi","hi2","ai","logos","skill","devicon"],type:"text",value:s.helpText,onChange:r=>j(s.id,"helpText",r.target.value),placeholder:"Ex: Cherchez l'engrenage et Wi-Fi",className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Image de la question (optionnel)"}),s.imageId?e.jsxs("div",{className:"mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-900",children:s.imageName})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>{j(s.id,"imageId",null),j(s.id,"imageName","")},className:"text-blue-600 hover:text-blue-700",children:"Retirer"})})]}):e.jsx("div",{className:"max-h-60 overflow-y-auto border rounded-lg bg-gray-50",children:e.jsx("div",{className:"grid grid-cols-3 gap-2 p-2",children:z.map(r=>e.jsxs("button",{onClick:()=>{j(s.id,"imageId",r.id),j(s.id,"imageName",r.name)},className:"p-2 text-center rounded hover:bg-blue-100 border border-gray-200 hover:border-blue-400 transition-colors bg-white",children:[e.jsx("img",{src:r.file_path,alt:r.name,className:"w-full h-20 object-cover rounded mb-1",onError:a=>{a.target.style.display="none"}}),e.jsx("p",{className:"text-xs text-gray-700 line-clamp-2",children:r.name})]},r.id))})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-900",children:"Chaque rÃ©ponse peut contenir un texte, une image, une icÃ´ne ou une combinaison des trois. Marquez au moins une rÃ©ponse correcte."}),e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"RÃ©ponses possibles (2-6 propositions) *"}),e.jsxs("div",{className:"space-y-3",children:[s.choices.map((r,a)=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["RÃ©ponse ",a+1]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:r.isCorrect,onChange:()=>ce(s.id,r.id),className:"w-4 h-4 rounded"}),e.jsx("span",{className:"text-xs text-gray-600",children:"Correcte"})]}),s.choices.length>2&&e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>oe(s.id,r.id),className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:e.jsx(Y,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-2",children:"Image (optionnel)"}),r.imageName?e.jsxs("div",{className:"mb-2 p-2 bg-blue-50 rounded border border-blue-200 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-xs text-blue-900",children:r.imageName})]}),e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>{v(s.id,r.id,"imageId",null),v(s.id,r.id,"imageName","")},className:"text-blue-600 hover:text-blue-700 p-0 h-6",children:e.jsx(ye,{className:"w-3 h-3"})})]}):e.jsx("div",{className:"max-h-40 overflow-y-auto border rounded bg-gray-50 p-2",children:e.jsx("div",{className:"grid grid-cols-3 gap-2",children:z.map(n=>e.jsxs("button",{onClick:()=>{v(s.id,r.id,"imageId",n.id),v(s.id,r.id,"imageName",n.name)},className:"p-1 text-center rounded hover:bg-blue-100 border border-gray-200 hover:border-blue-400 transition-colors bg-white",children:[e.jsx("img",{src:n.file_path,alt:n.name,className:"w-full h-16 object-cover rounded mb-1",onError:o=>{o.target.style.display="none"}}),e.jsx("p",{className:"text-xs text-gray-600 line-clamp-1",children:n.name})]},n.id))})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-2",children:"Texte (optionnel)"}),e.jsx("input",{type:"text",value:r.text,onChange:n=>v(s.id,r.id,"text",n.target.value),placeholder:"Ex: Mode poche, Notifications...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"IcÃ´ne (optionnel)"}),e.jsx(P,{selectedIcon:r.icon,onSelect:n=>v(s.id,r.id,"icon",n),onRemove:()=>v(s.id,r.id,"icon",null),libraries:["fa6","bs","md","fi","hi2","ai","logos","skill","devicon"],showLibraryTabs:!0})]})]})]})]},r.id)),s.choices.length<6&&e.jsxs(b,{onClick:()=>le(s.id),variant:"outline",className:"w-full gap-2",children:[e.jsx(X,{className:"w-4 h-4"}),"Ajouter une rÃ©ponse"]})]})]})]})]},s.id))]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(b,{onClick:me,variant:"outline",className:"flex-1",children:re?"Brouillon sauvegardÃ©":"Sauvegarder comme brouillon"}),e.jsx(b,{onClick:ue,disabled:O,className:"flex-1 bg-blue-600 hover:bg-blue-700",children:O?"CrÃ©ation en cours...":"CrÃ©er et soumettre"}),e.jsx(b,{onClick:()=>d("/contributeur"),variant:"outline",className:"flex-1",children:"Annuler"})]})]})}):null};export{Ae as default};
