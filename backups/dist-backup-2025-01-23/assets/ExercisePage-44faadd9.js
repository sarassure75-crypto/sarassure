var Rs=Object.defineProperty,Ds=Object.defineProperties;var zs=Object.getOwnPropertyDescriptors;var ut=Object.getOwnPropertySymbols;var Mt=Object.prototype.hasOwnProperty,Lt=Object.prototype.propertyIsEnumerable;var wt=Math.pow,$t=(t,o,i)=>o in t?Rs(t,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[o]=i,F=(t,o)=>{for(var i in o||(o={}))Mt.call(o,i)&&$t(t,i,o[i]);if(ut)for(var i of ut(o))Lt.call(o,i)&&$t(t,i,o[i]);return t},se=(t,o)=>Ds(t,zs(o));var ze=(t,o)=>{var i={};for(var a in t)Mt.call(t,a)&&o.indexOf(a)<0&&(i[a]=t[a]);if(t!=null&&ut)for(var a of ut(t))o.indexOf(a)<0&&Lt.call(t,a)&&(i[a]=t[a]);return i};var ee=(t,o,i)=>new Promise((a,r)=>{var s=c=>{try{h(i.next(c))}catch(m){r(m)}},n=c=>{try{h(i.throw(c))}catch(m){r(m)}},h=c=>c.done?a(c.value):Promise.resolve(c.value).then(s,n);h((i=i.apply(t,o)).next())});import{j as e,g as Os,r as Kt,A as es,u as ts,c as ss,m as nt,k as ns,s as $s,t as Ms,v as Ls,F as Fs,w as Bs,x as qs,y as Vs,o as Ws,z as Hs,i as Xs,E as Ys,G as Us}from"./radix-ui-2f58371e.js";import{r as l,e as Gs,f as xt,h as Qs,u as Zs,k as Js}from"./react-vendor-6cf6ded9.js";import{c as j,m as Q,I as Ks,A as Ue,a as rs,F as rt,B as kt,M as Pt,b as Et,H as It,d as At,e as $,P as en,g as tn,f as sn,h as nn,u as os,i as pt,s as ne,C as jt,j as yt,k as as,l as is,D as ls,n as cs,o as ds,p as us,q as ms,r as rn,V as on,t as an,v as Ft}from"./index-426aa6f1.js";import{X as at,Q as hs,E as ot,_ as ln,$ as Tt,a0 as xs,a1 as ps,n as cn,a2 as dn,e as fs,O as un,z as qe,w as ft,k as St,a3 as Rt,V as Dt,x as gs,a4 as mn,a5 as hn,a6 as Nt,G as xn,H as bs,a7 as pn,t as vs,v as fn,a8 as ws,a9 as gn,A as Bt,Z as bn}from"./ui-icons-e73ce4f7.js";import{I as ht}from"./ImageFromSupabase-e93ddddf.js";import{v as vn}from"./v4-7fe747c7.js";import{u as wn,r as qt}from"./useConfidence-4739bd19.js";import{D as jn,g as yn,T as Ct}from"./TranslationComponents-cc914843.js";import"./supabase-4b7d20da.js";const Nn=t=>{if(!t)return null;if(t.includes(":")&&(t.startsWith("logos:")||t.startsWith("skill-icons:")||t.startsWith("devicon:")))return s=>e.jsx(rs,F({icon:t},s));const[o,i]=t.split(":"),r={lucide:ot,fa6:rt,bs:kt,md:Pt,fi:Et,hi2:It,ai:At}[o];return r?r[i]:null},Vt=({imageId:t,alt:o,targetArea:i,actionType:a,startArea:r,onInteraction:s,imageContainerClassName:n,isMobileLayout:h,isZoomActive:c=!1,hideActionZone:m=!1,keyboardAutoShow:N=!1,expectedInput:v=""})=>{const[y,P]=l.useState(c),w=l.useRef(null),T=l.useRef(null),Z=l.useRef(null),[U,J]=l.useState({x:0,y:0}),[B,G]=l.useState(!1),[O,ie]=l.useState(null),[le,be]=l.useState(null),[te,pe]=l.useState({x:0,y:0,width:0,height:0}),I=["tap","double_tap","long_press","swipe_left","swipe_right","swipe_up","swipe_down","scroll","drag_and_drop","bravo"].includes(a)?r:i,[ce,R]=l.useState(!1),[$e,ve]=l.useState(""),de=l.useRef(null),[Ie,Y]=l.useState(0),[ye,x]=l.useState(!1),[S,C]=l.useState(!1),p=l.useRef({isDown:!1,startTime:0,hasMoved:!1,lastTapTime:0,lastTapX:0,lastTapY:0});l.useEffect(()=>{P(c)},[c]);const D=u=>{if(!y||!w.current)return;const g=w.current.getBoundingClientRect(),k=u.clientX-g.left,E=u.clientY-g.top;k>=0&&k<=g.width&&E>=0&&E<=g.height&&(J({x:k,y:E}),G(!0))},A=u=>{if(!y||!w.current||u.touches.length===0)return;const g=w.current.getBoundingClientRect(),k=u.touches[0].clientX-g.left,E=u.touches[0].clientY-g.top;k>=0&&k<=g.width&&E>=0&&E<=g.height&&(J({x:k,y:E}),G(!0))},z=()=>{G(!1)},Me=()=>{G(!1)};l.useEffect(()=>{(a==="number_input"||a==="text_input"&&N)&&R(!0)},[a,N]),l.useEffect(()=>{ce&&de.current&&de.current.focus()},[ce]);const Ae=l.useCallback(()=>{if(!w.current||!T.current)return;const u=w.current.getBoundingClientRect(),g=T.current.getBoundingClientRect(),k=g.left-u.left,E=g.top-u.top;pe({x:k,y:E,width:g.width,height:g.height,containerLeft:u.left,containerTop:u.top,containerWidth:u.width,containerHeight:u.height})},[]);if(l.useEffect(()=>{if(!T.current)return;const u=()=>Ae();return u(),window.addEventListener("resize",u),window.addEventListener("scroll",u,!0),()=>{window.removeEventListener("resize",u),window.removeEventListener("scroll",u,!0)}},[t,y,Ae]),!t)return e.jsx("div",{className:j("w-full h-full bg-muted flex items-center justify-center text-muted-foreground",n),children:e.jsx("p",{children:"Aucune image pour cette Ã©tape."})});const re=()=>{const u=Ie+1;Y(u),u>=3&&x(!0),s(!1)},Ve=u=>{u.preventDefault()},V=u=>{p.current={isDown:!0,startTime:Date.now(),hasMoved:!1,startX:u.clientX,startY:u.clientY,lastTapTime:p.current.lastTapTime,lastTapX:p.current.lastTapX,lastTapY:p.current.lastTapY},a==="long_press"&&(Z.current=setTimeout(()=>{p.current.isDown&&!p.current.hasMoved&&(Y(0),s(!0))},700))},Le=u=>{if(p.current.isDown){const g=u.clientX-(p.current.startX||u.clientX),k=u.clientY-(p.current.startY||u.clientY),E=Math.sqrt(g*g+k*k);p.current.currentX=u.clientX,p.current.currentY=u.clientY,E>10&&(p.current.hasMoved=!0,Z.current&&clearTimeout(Z.current))}},K=u=>{var d,oe,_e,ke,he,je,Re,lt,ct;if(a==="bravo")return!0;if(!I||!te.width)return!1;const g=te.width,k=te.height,E=(oe=(d=I.x_percent)!=null?d:I.x)!=null?oe:0,M=(ke=(_e=I.y_percent)!=null?_e:I.y)!=null?ke:0,W=(je=(he=I.width_percent)!=null?he:I.width)!=null?je:0,H=(lt=(Re=I.height_percent)!=null?Re:I.height)!=null?lt:0,me=te.x+E*g/100,we=te.y+M*k/100,Qe=me+W*g/100,Ze=we+H*k/100,Ne=(ct=w.current)==null?void 0:ct.getBoundingClientRect();if(!Ne)return!1;const Se=u.clientX-Ne.left,Ce=u.clientY-Ne.top;return Se>=me&&Se<=Qe&&Ce>=we&&Ce<=Ze},q=u=>{Z.current&&clearTimeout(Z.current),p.current.isDown=!1;const g=(p.current.currentX||u.clientX)-(p.current.startX||u.clientX),k=(p.current.currentY||u.clientY)-(p.current.startY||u.clientY),E=Math.sqrt(g*g+k*k);if(!K({clientX:p.current.startX,clientY:p.current.startY})){re();return}if(E>50){const W=Math.abs(g),H=Math.abs(k);if(W>H){if(a==="swipe_left"&&g<-50){Y(0),s(!0);return}else if(a==="swipe_right"&&g>50){Y(0),s(!0);return}else if(["swipe_left","swipe_right"].includes(a)){re();return}}else if(a==="swipe_up"&&k<-50){Y(0),s(!0);return}else if(a==="swipe_down"&&k>50){Y(0),s(!0);return}else if(a==="scroll"&&Math.abs(k)>50){Y(0),s(!0);return}else if(["swipe_up","swipe_down","scroll"].includes(a)){re();return}if(["swipe_left","swipe_right","swipe_up","swipe_down","scroll"].includes(a)){re();return}}if(E<10){const H=Date.now()-p.current.startTime<700;if(a==="double_tap"){const me=Date.now();if(me-p.current.lastTapTime<300&&Math.abs(u.clientX-p.current.lastTapX)<50&&Math.abs(u.clientY-p.current.lastTapY)<50){Y(0),s(!0),p.current.lastTapTime=0;return}else if(H){p.current.lastTapTime=me,p.current.lastTapX=u.clientX,p.current.lastTapY=u.clientY;return}}else if(H&&a==="tap"){Y(0),s(!0);return}else if(H&&a==="bravo"){Y(0),s(!0);return}else if(H&&(a==="text_input"||a==="number_input")){R(!0);return}else if(H&&!["long_press","drag_and_drop"].includes(a)){re();return}}["drag_and_drop"].includes(a)||re()},ue=(u,g)=>{a==="drag_and_drop"&&(Math.sqrt(wt(g.offset.x,2)+wt(g.offset.y,2))>30?(Y(0),s(!0)):re()),C(!1)},We=u=>{const g=u.target.value;if(ve(g),g.trim().length>0){const k=(I==null?void 0:I.expected_input)||(I==null?void 0:I.expected_text)||(I==null?void 0:I.expected_value)||(I==null?void 0:I.value),E=k==null?void 0:k.trim();g.toLowerCase()===(E==null?void 0:E.toLowerCase())&&setTimeout(()=>{Y(0),R(!1),ve(""),s(!0)},500)}},Te=()=>({tap:"un simple tap",double_tap:"un double tap (2 fois rapidement)",long_press:"un appui long (>700ms)",swipe_left:"un glissement vers la gauche",swipe_right:"un glissement vers la droite",swipe_up:"un glissement vers le haut",swipe_down:"un glissement vers le bas",scroll:"un scroll (haut ou bas)",drag_and_drop:"un maintien et dÃ©placement",text_input:"une saisie de texte",number_input:"une saisie de nombre"})[a]||"l'action attendue",He=u=>{var Ne,Se,Ce,d,oe,_e,ke,he,je,Re;const g=te.width||((Ne=T.current)==null?void 0:Ne.getBoundingClientRect().width)||0,k=te.height||((Se=T.current)==null?void 0:Se.getBoundingClientRect().height)||0,E=(d=(Ce=u.x_percent)!=null?Ce:u.x)!=null?d:0,M=(_e=(oe=u.y_percent)!=null?oe:u.y)!=null?_e:0,W=(he=(ke=u.width_percent)!=null?ke:u.width)!=null?he:0,H=(Re=(je=u.height_percent)!=null?je:u.height)!=null?Re:0,me=E*g/100,we=M*k/100,Qe=W*g/100,Ze=H*k/100;return{position:"absolute",left:`${me}px`,top:`${we}px`,width:`${Qe}px`,height:`${Ze}px`,borderRadius:u.shape==="ellipse"?"50%":"8px"}},_=u=>{const g=u.color||"rgba(59, 130, 246, 0.5)";if(u.show_border===!1)return{};const k=m?"1px":"2px",E=m?.1:1;let M=g;return m&&g.includes("rgba")?M=g.replace(/([\d.]+)\)$/,`${E})`):m&&g.includes("rgb(")&&(M=g.replace("rgb","rgba").replace(")",`, ${E})`)),{border:`${k} dashed ${M}`}},Xe=u=>{const g=u.color||"rgba(59, 130, 246, 0.3)",k=m?.02:u.opacity!==void 0?u.opacity:.3;if(g.includes("rgba")){const E=g.match(/^rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)$/);if(E){const[,M,W,H]=E;return{backgroundColor:`rgba(${M}, ${W}, ${H}, ${k})`}}}else if(g.includes("rgb")){const E=g.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);if(E){const[,M,W,H]=E;return{backgroundColor:`rgba(${M}, ${W}, ${H}, ${k})`}}}if(g.startsWith("#")){const E=g.replace("#",""),M=parseInt(E.substring(0,2),16),W=parseInt(E.substring(2,4),16),H=parseInt(E.substring(4,6),16);return{backgroundColor:`rgba(${M}, ${W}, ${H}, ${k})`}}return{backgroundColor:g}},bt=()=>{switch(a){case"tap":case"double_tap":return{opacity:[.5,1,.5],transition:{duration:2.5,repeat:1/0,ease:"easeInOut"}};case"long_press":return{opacity:[.4,.9,.4],transition:{duration:3,repeat:1/0,ease:"easeInOut"}};case"swipe_left":return{opacity:[.5,1,.5],x:[10,-20,10],transition:{duration:2,repeat:1/0,ease:"easeInOut"}};case"swipe_right":return{opacity:[.5,1,.5],x:[-10,20,-10],transition:{duration:2,repeat:1/0,ease:"easeInOut"}};case"swipe_up":return{opacity:[.5,1,.5],y:[10,-20,10],transition:{duration:2,repeat:1/0,ease:"easeInOut"}};case"swipe_down":return{opacity:[.5,1,.5],y:[-10,20,-10],transition:{duration:2,repeat:1/0,ease:"easeInOut"}};case"scroll":return{opacity:[.5,1,.5],y:[-10,20,-10],transition:{duration:2,repeat:1/0,ease:"easeInOut"}};case"drag_and_drop":return{opacity:[.5,1,.5],scale:[1,1.05,1],transition:{duration:2,repeat:1/0,ease:"easeInOut"}};case"text_input":case"number_input":return{opacity:[.3,1,.3],borderWidth:[1,3,1],transition:{duration:2.5,repeat:1/0,ease:"easeInOut"}};default:return{opacity:[.5,1,.5],transition:{duration:2.5,repeat:1/0,ease:"easeInOut"}}}};return e.jsxs("div",{ref:w,className:j("relative overflow-hidden w-full h-full flex justify-start items-start",n),onContextMenu:Ve,onPointerDown:V,onPointerMove:Le,onPointerUp:q,onMouseMove:D,onMouseLeave:z,onTouchMove:A,onTouchEnd:Me,children:[e.jsxs("div",{className:"relative",style:{lineHeight:0},children:[e.jsx(ht,{ref:T,imageId:t,alt:o,className:"w-full h-full object-contain",style:{display:"block"},onLoad:()=>{try{const u=T.current;if(u){const g=u.getBoundingClientRect();ie({width:g.width,height:g.height}),be(u.src||null),Ae()}}catch(u){}}}),I&&e.jsx(Q.div,{"data-action-zone":!0,style:se(F(F(F({},He(I)),_(I)),Xe(I)),{touchAction:"none",WebkitUserSelect:"none",WebkitTouchCallout:"none",pointerEvents:"auto"}),className:j("z-10 flex items-center justify-center",a==="drag_and_drop"&&"cursor-grab",a!=="drag_and_drop"&&"cursor-pointer"),animate:m?{opacity:1}:bt(),whileHover:m?{}:{scale:1.02},onContextMenu:Ve,onDragStart:()=>C(!0),onDragEnd:ue,drag:a==="drag_and_drop",dragConstraints:w,dragElastic:.1,children:I.icon_name&&(()=>{const u=Nn(I.icon_name);return u?e.jsx(u,{className:"text-white drop-shadow-lg",style:{fontSize:"3rem",pointerEvents:"none"}}):null})()}),ce&&i&&(()=>{const u=F({},i);return e.jsx("div",{style:He(u),className:"z-20 flex items-center justify-center p-2 bg-white/95 rounded border-2 border-blue-500",onClick:g=>g.stopPropagation(),children:e.jsx(Ks,{ref:de,type:a==="number_input"?"number":"text",inputMode:a==="number_input"?"numeric":"text",value:$e,onChange:We,onBlur:()=>{R(!1),ve("")},className:"w-full text-center text-lg p-3 rounded border-2 border-blue-500 bg-white",placeholder:a==="number_input"?"0":"Tapez ici...",autoComplete:"off",autoFocus:!0})})})()]}),e.jsx(Ue,{children:ye&&e.jsx(Q.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"absolute top-4 left-4 right-4 z-30 pointer-events-none",children:e.jsxs("div",{className:"bg-red-100 border-2 border-red-500 rounded-lg p-3 text-center shadow-lg pointer-events-auto cursor-pointer",onClick:()=>x(!1),children:[e.jsx("p",{className:"text-red-900 font-bold mb-1 text-sm",children:"Ce n'est pas le bon geste!"}),e.jsxs("p",{className:"text-red-800 text-xs mb-1",children:["Vous devez effectuer: ",e.jsx("strong",{children:Te()})]}),e.jsx("p",{className:"text-red-700 text-xs",children:"Essayez Ã  nouveau..."})]})})}),y&&B&&le&&O&&e.jsx("div",{className:"absolute pointer-events-none z-40",style:{left:`${U.x}px`,top:`${U.y}px`,width:"120px",height:"120px",transform:"translate(-50%, -50%)",border:"2px solid white",borderRadius:"50%",boxShadow:"0 0 10px rgba(0,0,0,0.3)",overflow:"hidden",backgroundColor:"rgba(255, 255, 255, 0.05)"},children:e.jsx("div",{style:{width:"100%",height:"100%",backgroundImage:`url(${le})`,backgroundRepeat:"no-repeat",backgroundSize:`${O.width*2}px ${O.height*2}px`,backgroundPosition:`${60-U.x*2}px ${60-U.y*2}px`}})}),e.jsx("button",{onClick:()=>P(!y),className:"absolute bottom-2 right-2 z-20 p-2 bg-background/50 backdrop-blur-sm rounded-full text-foreground hover:bg-background/80",title:y?"DÃ©sactiver la loupe":"Activer la loupe",children:y?e.jsx(at,{size:h?16:20}):e.jsx(hs,{size:h?16:20})})]})};var gt="Popover",[js,dr]=Os(gt,[Kt]),it=Kt(),[Cn,Oe]=js(gt),ys=t=>{const{__scopePopover:o,children:i,open:a,defaultOpen:r,onOpenChange:s,modal:n=!1}=t,h=it(o),c=l.useRef(null),[m,N]=l.useState(!1),[v,y]=Xs({prop:a,defaultProp:r!=null?r:!1,onChange:s,caller:gt});return e.jsx(Ys,se(F({},h),{children:e.jsx(Cn,{scope:o,contentId:Us(),triggerRef:c,open:v,onOpenChange:y,onOpenToggle:l.useCallback(()=>y(P=>!P),[y]),hasCustomAnchor:m,onCustomAnchorAdd:l.useCallback(()=>N(!0),[]),onCustomAnchorRemove:l.useCallback(()=>N(!1),[]),modal:n,children:i})}))};ys.displayName=gt;var Ns="PopoverAnchor",_n=l.forwardRef((t,o)=>{const c=t,{__scopePopover:i}=c,a=ze(c,["__scopePopover"]),r=Oe(Ns,i),s=it(i),{onCustomAnchorAdd:n,onCustomAnchorRemove:h}=r;return l.useEffect(()=>(n(),()=>h()),[n,h]),e.jsx(es,se(F(F({},s),a),{ref:o}))});_n.displayName=Ns;var Cs="PopoverTrigger",_s=l.forwardRef((t,o)=>{const c=t,{__scopePopover:i}=c,a=ze(c,["__scopePopover"]),r=Oe(Cs,i),s=it(i),n=ts(o,r.triggerRef),h=e.jsx(ss.button,se(F({type:"button","aria-haspopup":"dialog","aria-expanded":r.open,"aria-controls":r.contentId,"data-state":As(r.open)},a),{ref:n,onClick:nt(t.onClick,r.onOpenToggle)}));return r.hasCustomAnchor?h:e.jsx(es,se(F({asChild:!0},s),{children:h}))});_s.displayName=Cs;var zt="PopoverPortal",[kn,Pn]=js(zt,{forceMount:void 0}),ks=t=>{const{__scopePopover:o,forceMount:i,children:a,container:r}=t,s=Oe(zt,o);return e.jsx(kn,{scope:o,forceMount:i,children:e.jsx(ns,{present:i||s.open,children:e.jsx(Ws,{asChild:!0,container:r,children:a})})})};ks.displayName=zt;var Ge="PopoverContent",Ps=l.forwardRef((t,o)=>{const i=Pn(Ge,t.__scopePopover),n=t,{forceMount:a=i.forceMount}=n,r=ze(n,["forceMount"]),s=Oe(Ge,t.__scopePopover);return e.jsx(ns,{present:a||s.open,children:s.modal?e.jsx(In,se(F({},r),{ref:o})):e.jsx(An,se(F({},r),{ref:o}))})});Ps.displayName=Ge;var En=Hs("PopoverContent.RemoveScroll"),In=l.forwardRef((t,o)=>{const i=Oe(Ge,t.__scopePopover),a=l.useRef(null),r=ts(o,a),s=l.useRef(!1);return l.useEffect(()=>{const n=a.current;if(n)return $s(n)},[]),e.jsx(Ms,{as:En,allowPinchZoom:!0,children:e.jsx(Es,se(F({},t),{ref:r,trapFocus:i.open,disableOutsidePointerEvents:!0,onCloseAutoFocus:nt(t.onCloseAutoFocus,n=>{var h;n.preventDefault(),s.current||(h=i.triggerRef.current)==null||h.focus()}),onPointerDownOutside:nt(t.onPointerDownOutside,n=>{const h=n.detail.originalEvent,c=h.button===0&&h.ctrlKey===!0,m=h.button===2||c;s.current=m},{checkForDefaultPrevented:!1}),onFocusOutside:nt(t.onFocusOutside,n=>n.preventDefault(),{checkForDefaultPrevented:!1})}))})}),An=l.forwardRef((t,o)=>{const i=Oe(Ge,t.__scopePopover),a=l.useRef(!1),r=l.useRef(!1);return e.jsx(Es,se(F({},t),{ref:o,trapFocus:!1,disableOutsidePointerEvents:!1,onCloseAutoFocus:s=>{var n,h;(n=t.onCloseAutoFocus)==null||n.call(t,s),s.defaultPrevented||(a.current||(h=i.triggerRef.current)==null||h.focus(),s.preventDefault()),a.current=!1,r.current=!1},onInteractOutside:s=>{var c,m;(c=t.onInteractOutside)==null||c.call(t,s),s.defaultPrevented||(a.current=!0,s.detail.originalEvent.type==="pointerdown"&&(r.current=!0));const n=s.target;((m=i.triggerRef.current)==null?void 0:m.contains(n))&&s.preventDefault(),s.detail.originalEvent.type==="focusin"&&r.current&&s.preventDefault()}}))}),Es=l.forwardRef((t,o)=>{const w=t,{__scopePopover:i,trapFocus:a,onOpenAutoFocus:r,onCloseAutoFocus:s,disableOutsidePointerEvents:n,onEscapeKeyDown:h,onPointerDownOutside:c,onFocusOutside:m,onInteractOutside:N}=w,v=ze(w,["__scopePopover","trapFocus","onOpenAutoFocus","onCloseAutoFocus","disableOutsidePointerEvents","onEscapeKeyDown","onPointerDownOutside","onFocusOutside","onInteractOutside"]),y=Oe(Ge,i),P=it(i);return Ls(),e.jsx(Fs,{asChild:!0,loop:!0,trapped:a,onMountAutoFocus:r,onUnmountAutoFocus:s,children:e.jsx(Bs,{asChild:!0,disableOutsidePointerEvents:n,onInteractOutside:N,onEscapeKeyDown:h,onPointerDownOutside:c,onFocusOutside:m,onDismiss:()=>y.onOpenChange(!1),children:e.jsx(qs,se(F(F({"data-state":As(y.open),role:"dialog",id:y.contentId},P),v),{ref:o,style:se(F({},v.style),{"--radix-popover-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-popover-content-available-width":"var(--radix-popper-available-width)","--radix-popover-content-available-height":"var(--radix-popper-available-height)","--radix-popover-trigger-width":"var(--radix-popper-anchor-width)","--radix-popover-trigger-height":"var(--radix-popper-anchor-height)"})}))})})}),Is="PopoverClose",Tn=l.forwardRef((t,o)=>{const s=t,{__scopePopover:i}=s,a=ze(s,["__scopePopover"]),r=Oe(Is,i);return e.jsx(ss.button,se(F({type:"button"},a),{ref:o,onClick:nt(t.onClick,()=>r.onOpenChange(!1))}))});Tn.displayName=Is;var Sn="PopoverArrow",Rn=l.forwardRef((t,o)=>{const s=t,{__scopePopover:i}=s,a=ze(s,["__scopePopover"]),r=it(i);return e.jsx(Vs,se(F(F({},r),a),{ref:o}))});Rn.displayName=Sn;function As(t){return t?"open":"closed"}var Dn=ys,zn=_s,On=ks,Ts=Ps;const Wt=Dn,Ht=zn,_t=Gs.forwardRef((s,r)=>{var n=s,{className:t,align:o="center",sideOffset:i=4}=n,a=ze(n,["className","align","sideOffset"]);return e.jsx(On,{children:e.jsx(Ts,F({ref:r,align:o,sideOffset:i,className:j("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t)},a))})});_t.displayName=Ts.displayName;const $n=({isZoomActive:t,onZoomToggle:o,showInstructions:i,onInstructionsToggle:a,hideActionZone:r,onHideActionZone:s,versions:n,currentVersionId:h,onVersionChange:c,isMobileLayout:m,onDebugForceSave:N,onDebugDeleteProgress:v,taskId:y,versionId:P,currentStepIndex:w,hasPhoneButtonActions:T,forceShowPhoneFrame:Z,onForceShowPhoneFrame:U})=>{const J=xt(),B=m?"h-7 w-7":"h-8 w-8",G=()=>{const O=new URLSearchParams;y&&O.append("taskId",y),P&&O.append("versionId",P),w!==void 0&&w>=0&&O.append("stepIndex",w),J(`/report-error?${O.toString()}`)};return e.jsxs("div",{className:j("w-full flex items-center justify-center gap-2 shrink-0",m?"mb-1.5":"mb-2 sm:mb-4"),children:[e.jsx("button",{onClick:o,className:j("flex-shrink-0 rounded-md flex items-center justify-center transition-colors",B,t?"bg-primary/90 text-white":"bg-primary/80 hover:bg-primary/90 text-white"),title:"Zoom",children:e.jsx(ln,{className:m?"h-4 w-4":"h-5 w-5"})}),e.jsx("button",{onClick:a,className:j("flex-shrink-0 rounded-md flex items-center justify-center transition-colors",B,i?"bg-primary/90 text-white":"bg-primary/80 hover:bg-primary/90 text-white"),title:"Information",children:e.jsx(Tt,{className:m?"h-4 w-4":"h-5 w-5"})}),e.jsx("button",{onClick:s,className:j("flex-shrink-0 rounded-md flex items-center justify-center transition-colors",B,r?"bg-primary/90 text-white":"bg-primary/80 hover:bg-primary/90 text-white"),title:"Masquer la zone d'action",children:r?e.jsx(xs,{className:m?"h-4 w-4":"h-5 w-5"}):e.jsx(ps,{className:m?"h-4 w-4":"h-5 w-5"})}),T&&e.jsx("button",{onClick:U,className:j("flex-shrink-0 rounded-md flex items-center justify-center transition-colors",B,Z?"bg-blue-600 text-white":"bg-primary/80 hover:bg-primary/90 text-white"),title:"Afficher l'entourage du tÃ©lÃ©phone",children:e.jsx(cn,{className:m?"h-4 w-4":"h-5 w-5"})}),e.jsxs(Wt,{children:[e.jsx(Ht,{asChild:!0,children:e.jsx("button",{className:j("flex-shrink-0 bg-primary/80 hover:bg-primary/90 text-white rounded-md flex items-center justify-center transition-colors",B),title:"Versions",children:e.jsx(dn,{className:m?"h-4 w-4":"h-5 w-5"})})}),e.jsx(_t,{className:"w-auto p-1",children:e.jsx("div",{className:"flex flex-col space-y-1",children:n.map(O=>e.jsx($,{onClick:()=>c(O.id),variant:O.id===h?"secondary":"ghost",size:"sm",className:"justify-start",children:O.name},O.id))})})]}),e.jsx("button",{onClick:G,className:j("flex-shrink-0 rounded-md flex items-center justify-center transition-colors",B,"bg-red-600 hover:bg-red-700 text-white"),title:"Signaler une erreur",children:e.jsx(fs,{className:m?"h-4 w-4":"h-5 w-5"})}),N&&v&&e.jsxs(Wt,{children:[e.jsx(Ht,{asChild:!0,children:e.jsx($,{variant:"outline",size:"icon",className:j("shrink-0",B),title:"Debug",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{d:"M11 17a1 1 0 01-1 1H6a1 1 0 01-1-1v-4a1 1 0 011-1h4a1 1 0 011 1v4zM17 7a1 1 0 01-1 1h-4a1 1 0 01-1-1V3a1 1 0 011-1h4a1 1 0 011 1v4zM17 11a1 1 0 00-1 1v4a1 1 0 01-1 1h-4a1 1 0 00-1 1v-4a1 1 0 011-1h4a1 1 0 011-1zM11 3a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V3z"})})})}),e.jsx(_t,{className:"w-auto p-1",children:e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx($,{onClick:N,variant:"ghost",size:"sm",className:"justify-start",children:"Forcer enregistrement"}),e.jsx($,{onClick:v,variant:"destructive",size:"sm",className:"justify-start",children:"Supprimer progression"})]})})]})]})},Mn=({versionName:t,versionNumber:o,progress:i,hasVideo:a,onVideoClick:r,onListClick:s,isMobileLayout:n})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:j("flex justify-between items-center shrink-0",n?"mb-1":"mb-1 sm:mb-2"),children:[e.jsxs("h2",{className:j("font-semibold text-secondary truncate pr-2",n?"text-xs":"text-lg sm:text-xl"),children:[t," ",e.jsxs("span",{className:j("text-muted-foreground",n?"text-2xs":"text-xs sm:text-sm"),children:["(",o,")"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[a&&e.jsx($,{variant:"ghost",size:"icon_xs",onClick:r,className:"text-primary",children:e.jsx(un,{className:"h-4 w-4"})}),e.jsx($,{variant:"ghost",size:"icon_xs",onClick:s,className:"text-primary",children:e.jsx(qe,{className:"h-4 w-4"})})]})]}),e.jsx(en,{value:i,className:j("w-full shrink-0",n?"mb-1.5 h-0.5":"mb-2 sm:mb-4 h-1.5 sm:h-2")})]}),Ln=({onPrev:t,onNext:o,isPrevDisabled:i,isNextDisabled:a,isCompleted:r,isMobileLayout:s})=>e.jsx("div",{className:j("mt-auto shrink-0",s?"pt-1":"pt-2"),children:e.jsxs("div",{className:j("flex justify-between items-center",s?"mt-1":"mt-3 sm:mt-6"),children:[e.jsxs($,{onClick:t,disabled:i,variant:"outline",size:s?"xs":"sm",className:s?"text-2xs h-7 px-1.5":"text-xs sm:text-sm","aria-label":"Ã‰tape prÃ©cÃ©dente",children:[e.jsx(ft,{className:j("mr-0.5",s?"h-3 w-3":"h-3 w-3 sm:h-4 sm:w-4")})," PrÃ©c."]}),r?e.jsxs("span",{className:j("text-green-600 font-semibold flex items-center",s?"text-xs":"text-xs sm:text-sm"),children:[e.jsx(St,{className:j("mr-1",s?"h-3 w-3":"h-4 w-4 sm:h-5 sm:w-5")})," TerminÃ© !"]}):e.jsxs($,{onClick:o,disabled:a,size:s?"xs":"sm",className:s?"text-2xs h-7 px-1.5":"text-xs sm:text-sm","aria-label":"Ã‰tape suivante",children:["Suiv. ",e.jsx(Rt,{className:j("ml-0.5",s?"h-3 w-3":"h-3 w-3 sm:h-4 sm:w-4")})]})]})}),Fn=({isZoomActive:t,onZoomToggle:o,showInstructions:i,onInstructionsToggle:a,hideActionZone:r,onHideActionZone:s,versions:n,currentVersionId:h,onVersionChange:c,onNavigateHome:m,onViewNotes:N,onAddNote:v,onPrev:y,onNext:P,isPrevDisabled:w,isNextDisabled:T,onNavigateToTasks:Z,onPlayAudio:U,currentStep:J,textZoom:B,onTextZoomChange:G,isMobileLayout:O,taskId:ie,versionId:le,currentStepIndex:be,totalSteps:te,currentLanguage:pe,onLanguageChange:I,preferredLanguage:ce="en"})=>{const R=xt(),[$e,ve]=l.useState(!1),[de,Ie]=l.useState(!1);l.useState(!1);const[Y,ye]=l.useState([]),[x,S]=l.useState(!1),C=O?"h-5 w-5":"h-6 w-6",p="w-full p-3 flex items-center justify-center text-white hover:bg-green-600 transition-colors border-b border-green-600",D=()=>{const A=new URLSearchParams;ie&&A.append("taskId",ie),le&&A.append("versionId",le),be!==void 0&&be>=0&&A.append("stepIndex",be),R(`/report-error?${A.toString()}`)};return l.useEffect(()=>{(()=>ee(void 0,null,function*(){S(!0);try{const z=yield tn();ye(z)}catch(z){console.error("Erreur lors du chargement des langues:",z)}finally{S(!1)}}))()},[]),e.jsxs("div",{className:"flex flex-col bg-green-700 rounded-lg shadow-lg overflow-y-auto h-auto",children:[e.jsx("button",{onClick:o,className:p,title:t?"DÃ©sactiver la loupe":"Activer la loupe","aria-label":t?"DÃ©sactiver la loupe":"Activer la loupe",children:t?e.jsx(at,{className:C}):e.jsx(hs,{className:C})}),e.jsx("button",{onClick:a,className:p,title:i?"Masquer les instructions":"Afficher les instructions","aria-label":i?"Masquer les instructions":"Afficher les instructions",children:e.jsx(Tt,{className:C})}),e.jsx("button",{onClick:s,className:p,title:r?"Afficher la zone d'action":"Masquer la zone d'action","aria-label":r?"Afficher la zone d'action":"Masquer la zone d'action",children:r?e.jsx(ps,{className:C}):e.jsx(xs,{className:C})}),(J==null?void 0:J.instruction)&&U&&e.jsx("button",{onClick:()=>U(J.instruction),className:p,title:"Lire l'instruction audio","aria-label":"Lire l'instruction audio",children:e.jsx(Dt,{className:C})}),e.jsxs("div",{className:"relative w-full",children:[e.jsx("button",{onClick:()=>Ie(!de),className:p,title:`Taille du texte (${Math.round(B*100)}%)`,children:e.jsx(gs,{className:C})}),de&&e.jsx("div",{className:"fixed bg-white border-2 border-green-700 rounded-lg shadow-2xl z-50 min-w-[180px] pointer-events-auto",style:{top:"150px",right:"20px"},children:e.jsxs("div",{className:"p-2",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-600 mb-2 px-2",children:"Taille du texte:"}),[1,1.25,1.5,2].map(A=>e.jsxs("button",{onClick:()=>{G(A),Ie(!1)},className:j("w-full text-left px-3 py-2 text-sm rounded hover:bg-green-50 transition-colors",B===A&&"bg-green-100 font-semibold text-green-800"),children:[Math.round(A*100),"%"]},A))]})})]}),e.jsxs("div",{className:"relative w-full",children:[e.jsx("button",{onClick:()=>ve(!$e),className:p,title:"Changer de version",children:e.jsx(mn,{className:C})}),$e&&n&&n.length>0&&e.jsx("div",{className:"fixed bg-white border-2 border-green-700 rounded-lg shadow-2xl z-50 min-w-[240px] pointer-events-auto",style:{top:"50px",right:"20px"},children:e.jsxs("div",{className:"p-3",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-600 mb-2 px-2",children:"SÃ©lectionner une version :"}),n.map(A=>e.jsx("button",{onClick:()=>{c(A.id),ve(!1)},className:j("w-full text-left px-3 py-2 text-sm rounded hover:bg-green-50 transition-colors",A.id===h&&"bg-green-100 font-semibold text-green-800"),children:A.name},A.id))]})})]}),e.jsx("button",{onClick:N,className:p,title:"Consulter mes notes",children:e.jsx(hn,{className:C})}),e.jsx("button",{onClick:v,className:p,title:"Ajouter une note",children:e.jsx(Nt,{className:C})}),e.jsx("button",{onClick:D,className:p,title:"Signaler une erreur",children:e.jsx(fs,{className:C})}),e.jsx("button",{onClick:y,disabled:w,className:j(p,w&&"opacity-50 cursor-not-allowed"),title:"Ã‰tape prÃ©cÃ©dente",children:e.jsx(ft,{className:C})}),e.jsx("button",{onClick:P,disabled:T,className:j(p,T&&"opacity-50 cursor-not-allowed"),title:"Ã‰tape suivante",children:e.jsx(Rt,{className:C})}),e.jsx("button",{onClick:()=>{const A=pe==="fr"?ce:"fr";I==null||I(A)},className:p,title:pe==="fr"?"Cliquez pour voir la traduction":"Cliquez pour revenir au franÃ§ais","aria-label":"Changer la langue",children:e.jsxs("div",{className:"flex flex-col items-center justify-center w-full",children:[e.jsx(xn,{className:C}),e.jsx("span",{className:"text-xs font-bold text-white mt-1",children:pe.toUpperCase()})]})}),e.jsx("button",{onClick:Z,className:j(p,"border-b-0"),title:"Retour aux tÃ¢ches",children:e.jsx(bs,{className:C})})]})},Bn=({term:t,definition:o,example:i=null,relatedTerms:a=[],isOpen:r,onClose:s})=>{const[n,h]=l.useState([]),[c,m]=l.useState(!1);return l.useEffect(()=>{r&&a&&a.length>0&&(m(!0),nn(a).then(N=>{h(N)}).catch(N=>{console.error("Error loading related terms:",N)}).finally(()=>{m(!1)}))},[r,a]),r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/30 z-40",onClick:s}),e.jsxs("div",{className:"fixed bg-white rounded-lg shadow-2xl z-50 max-w-md p-6 border-2 border-blue-400 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 max-h-[80vh] overflow-y-auto",onClick:N=>N.stopPropagation(),children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsx("h3",{className:"text-2xl font-bold text-blue-700",children:t}),e.jsx("button",{onClick:s,className:"p-1 hover:bg-gray-100 rounded-full transition-colors","aria-label":"Fermer",children:e.jsx(at,{className:"h-5 w-5 text-gray-500"})})]}),e.jsx("div",{className:"mb-4",children:e.jsx("p",{className:"text-gray-800 leading-relaxed",children:o})}),i&&e.jsxs("div",{className:"mb-4 bg-blue-50 border-l-4 border-blue-400 p-3 rounded",children:[e.jsx("p",{className:"text-sm font-semibold text-blue-600 mb-1",children:"Exemple :"}),e.jsxs("p",{className:"text-sm text-gray-700 italic",children:['"',i,'"']})]}),n&&n.length>0&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("p",{className:"text-sm font-semibold text-gray-600 mb-3",children:"Termes connexes :"}),e.jsx("div",{className:"space-y-2",children:n.map((N,v)=>e.jsxs("div",{className:"bg-gray-50 p-2 rounded",children:[e.jsx("p",{className:"text-sm font-medium text-gray-800",children:N.term}),e.jsx("p",{className:"text-xs text-gray-600",children:N.definition})]},v))})]}),c&&e.jsx("div",{className:"text-center text-sm text-gray-500 mt-2",children:"Chargement des termes connexes..."})]})]}):null},qn=({term:t,definition:o,example:i=null,relatedTerms:a=[],children:r,className:s=""})=>{const[n,h]=l.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx("span",{onClick:()=>h(!0),className:j("cursor-help underline decoration-blue-400 decoration-dotted hover:decoration-solid hover:bg-blue-50 transition-all rounded px-1",s),role:"button",tabIndex:0,title:`Cliquez pour la dÃ©finition de "${t}"`,onKeyDown:c=>{(c.key==="Enter"||c.key===" ")&&(c.preventDefault(),h(!0))},children:r||t}),e.jsx(Bn,{term:t,definition:o,example:i,relatedTerms:a,isOpen:n,onClose:()=>h(!1)})]})},Xt=t=>{let o=t.toLowerCase();const i=["ement","ment","tion","sion","er","Ã©","Ã©e","Ã©s","Ã©es","al","aux","ite","itude","ance","ence","ure","age","ire"];for(const a of i)if(o.endsWith(a)&&o.length>a.length+2){const r=o.slice(0,-a.length);if(r.length>2)return{base:r,original:t}}return{base:o,original:t}},Vn=(t,o)=>{const i=t.toLowerCase(),a=o.find(s=>s.term.toLowerCase()===i);if(a)return a;for(const s of o)if(s.variants&&Array.isArray(s.variants)&&s.variants.some(n=>n&&n.toLowerCase()===i))return s;const r=Xt(t);for(const s of o){const n=Xt(s.term);if(n.base===r.base&&n.base.length>2)return s}return null},Yt=({text:t,glossaryTerms:o=null,className:i=""})=>{const[a,r]=l.useState(o||[]),[s,n]=l.useState(!o);if(l.useEffect(()=>{o||ee(void 0,null,function*(){try{const w=yield sn();r(w||[])}catch(w){console.error("Error loading glossary terms:",w),r([])}finally{n(!1)}})},[o]),!t)return e.jsx("span",{className:i,children:t});if(s)return e.jsx("span",{className:i,children:t});if(!a||a.length===0)return e.jsx("span",{className:i,children:t});const h=[...a].sort((P,w)=>w.term.length-P.term.length),c=[];h.forEach(P=>{c.push(P.term.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"))}),h.forEach(P=>{P.variants&&Array.isArray(P.variants)&&P.variants.forEach(w=>{w&&c.push(w.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"))})});const m=[...new Set(c)].sort((P,w)=>w.length-P.length),N=m.join("|");if(console.log("Patterns pour regex:",m.slice(0,20)),console.log('Inclut "glisse"?',m.includes("glisse")),!N)return e.jsx("span",{className:i,children:t});const v=new RegExp(`\\b(${N})\\b`,"gi"),y=t.split(v);return e.jsx("span",{className:i,children:y.map((P,w)=>{if(!P)return null;const T=Vn(P,h);return T?e.jsx(qn,{term:T.term,definition:T.definition,example:T.example,relatedTerms:T.related_terms,children:P},w):e.jsx("span",{children:P},w)})})},Wn=t=>{if(!t)return null;if(t.includes(":")&&(t.startsWith("logos:")||t.startsWith("skill-icons:")||t.startsWith("devicon:")))return e.jsx(rs,{icon:t,width:"64",height:"64"});let o,i;if(t.includes("-")){const n=t.split("-");o=n[0],i=n.slice(1).join("-")}else if(t.includes(":")){const[n,h]=t.split(":");o=n,i=h}else return console.error("âŒ Format d'icÃ´ne invalide:",t),null;const r={lucide:ot,fa6:rt,fa:rt,bs:kt,md:Pt,fi:Et,hi2:It,ai:At}[o];if(!r)return console.error("âŒ Library not found:",o),null;const s=r[i];return s?e.jsx(s,{size:64,className:"text-primary"}):(console.error("âŒ Icon not found:",i,"in library:",o),console.log("Available icons sample:",Object.keys(r).slice(0,5)),null)},Hn=t=>!t||typeof t!="string"?!1:t.startsWith("fa6-")||t.startsWith("fa-")||t.startsWith("bs-")||t.startsWith("md-")||t.startsWith("fi-")||t.startsWith("hi2-")||t.startsWith("ai-")||t.startsWith("lucide-")||t.includes(":");function Ut({versionId:t,taskId:o,learner_id:i,onComplete:a}){const{currentUser:r}=os(),{toast:s}=pt(),n=xt(),[h,c]=l.useState([]),[m,N]=l.useState(0),[v,y]=l.useState({}),[P,w]=l.useState(!0),[T,Z]=l.useState(!1),[U,J]=l.useState(null),[B,G]=l.useState(!1),[O,ie]=l.useState(null),[le,be]=l.useState(1),[te,pe]=l.useState(!1);l.useEffect(()=>{console.log("ðŸŽ¬ QuestionnairePlayer mounted with props:",{versionId:t,taskId:o,learner_id:i}),I(),ce()},[t]);const I=()=>ee(this,null,function*(){w(!0);try{console.log("ðŸ”„ Loading questions for versionId:",t,"taskId:",o);const{data:x,error:S}=yield ne.from("steps").select("*").eq("version_id",t).order("step_order",{ascending:!0});if(console.log("ðŸ“Š Query result:",{error:S,dataLength:x==null?void 0:x.length,versionId:t}),S)throw S;if(!x||x.length===0){console.warn("âš ï¸ No steps found for versionId:",t),console.warn("Check if:"),console.warn("1. versionId is correct"),console.warn("2. Steps exist in the database for this version"),console.warn("3. RLS policies allow reading"),c([]),w(!1);return}console.log("âœ… Steps found:",x.length);const C=(x||[]).map(D=>{const A=D.expected_input;let z=A;if(typeof A=="string")try{z=JSON.parse(A)}catch(V){console.error("Erreur de parsing expected_input pour la question",D.id,V),z={}}z=z||{};const Me=z.questionType||z.type||"mixed",re=(Array.isArray(z.choices)?z.choices:Array.isArray(z.answers)?z.answers:[]).map(V=>{var K;const Le=V.iconId||((K=V.icon)==null?void 0:K.id)||(typeof V.icon=="string"?V.icon:null);return{id:V.id||vn(),text:V.text||"",imageId:V.imageId||null,imageName:V.imageName||"",iconId:Le,icon:V.icon||null,iconSvg:V.iconSvg||null,isCorrect:!!V.isCorrect}});console.log("ðŸ” DEBUG QCM - Choices chargÃ©es:",re);const Ve=Array.isArray(z.correctAnswers)&&z.correctAnswers.length>0?z.correctAnswers:re.filter(V=>V.isCorrect).map(V=>V.id);return{id:D.id,order:D.step_order,instruction:D.instruction,questionType:Me,imageId:z.imageId||null,imageName:z.imageName||null,choices:re,correctAnswers:Ve}});c(C);const p={};C.forEach(D=>{p[D.id]=[]}),y(p),console.log("âœ… Questions loaded successfully:",{totalQuestions:C.length,firstQuestion:C[0]?{id:C[0].id,instruction:C[0].instruction,choiceCount:C[0].choices.length,choices:C[0].choices.map(D=>({id:D.id.substring(0,5),text:D.text,isCorrect:D.isCorrect}))}:null})}catch(x){console.error("Erreur chargement questions:",x),s({title:"Erreur",description:"Impossible de charger les questions",variant:"destructive"})}finally{w(!1)}}),ce=()=>ee(this,null,function*(){try{const{data:x,error:S}=yield ne.from("questionnaire_attempts").insert({learner_id:r.id,questionnaire_id:o,version_id:t,status:"in_progress"}).select().single();if(S)throw S;J(x.id)}catch(x){console.error("Erreur crÃ©ation tentative:",x)}}),R=h[m];if(!R||!R.choices||!Array.isArray(R.choices))return console.error("âŒ Question invalide:",m,R),e.jsx("div",{className:"text-center py-8 text-red-600",children:"Erreur: Question invalide"});const $e=x=>{if(!R)return;const S=v[R.id]||[];S.includes(x)?y(se(F({},v),{[R.id]:S.filter(C=>C!==x)})):y(se(F({},v),{[R.id]:[...S,x]}))},ve=()=>{m>0&&N(m-1)},de=()=>{m<h.length-1&&N(m+1)},Ie=x=>{if("speechSynthesis"in window&&x){const S=new SpeechSynthesisUtterance(x);S.lang="fr-FR",S.rate=1,S.pitch=1.2,S.volume=1;const C=window.speechSynthesis.getVoices(),p=C.find(D=>D.lang.startsWith("fr")&&D.name.toLowerCase().includes("female"))||C.find(D=>D.lang.startsWith("fr"));p&&(S.voice=p),window.speechSynthesis.cancel(),window.speechSynthesis.speak(S)}else s({title:"Audio non disponible",description:"La lecture audio n'est pas supportÃ©e par votre navigateur.",variant:"destructive"})},Y=()=>ee(this,null,function*(){if(!(!U||!R)){Z(!0);try{let x=0,S=h.length;for(const p of h){const D=v[p.id]||[],A=p.correctAnswers||[],z=D.length===A.length&&D.every(Me=>A.includes(Me));z&&(x+=1),yield ne.from("questionnaire_answers").insert({attempt_id:U,step_id:p.id,selected_choice_ids:D,is_correct:z})}const C=Math.round(x/S*100);yield ne.from("questionnaire_attempts").update({score:x,max_score:S,percentage:C,status:"completed",completed_at:new Date().toISOString()}).eq("id",U),ie({score:x,maxScore:S,percentage:C}),G(!0),s({title:"SuccÃ¨s",description:`Score: ${x}/${S}`}),a&&setTimeout(()=>a({score:x,maxScore:S,percentage:C}),3e3)}catch(x){console.error("Erreur soumission:",x),s({title:"Erreur",description:"Impossible de soumettre votre rÃ©ponse",variant:"destructive"})}finally{Z(!1)}}});if(P)return e.jsx("div",{className:"text-center py-8",children:"Chargement du questionnaire..."});if(h.length===0)return e.jsx("div",{className:"text-center py-8",children:"Aucune question trouvÃ©e"});if(B&&O)return e.jsx(jt,{className:"w-full max-w-2xl mx-auto",children:e.jsxs(yt,{className:"pt-8 text-center",children:[e.jsx("div",{className:"mb-6",children:O.percentage>=80?e.jsx(St,{className:"w-16 h-16 text-blue-600 mx-auto mb-4"}):e.jsx(pn,{className:"w-16 h-16 text-blue-400 mx-auto mb-4"})}),e.jsxs("h2",{className:"text-3xl font-bold mb-4",children:["RÃ©sultat: ",O.percentage,"%"]}),e.jsxs("p",{className:"text-lg text-gray-600 mb-2",children:[O.score," / ",O.maxScore," rÃ©ponses correctes"]}),e.jsx("p",{className:"text-sm text-gray-500",children:O.percentage>=80?"âœ“ Excellent travail!":"Continuez vos efforts!"})]})});if(!R)return null;const ye=v[R.id]||[];return e.jsxs("div",{className:"flex flex-col w-full max-w-4xl mx-auto gap-4",children:[e.jsxs("div",{className:"flex gap-2 bg-white border-2 border-gray-300 rounded-lg p-3 shadow-md sticky top-0 z-10",children:[e.jsxs($,{variant:"ghost",size:"sm",onClick:()=>n("/taches"),title:"Retour Ã  la liste des exercices",className:"flex items-center gap-2 hover:bg-gray-100",children:[e.jsx(bs,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Accueil"})]}),(R==null?void 0:R.instruction)&&e.jsxs($,{variant:"ghost",size:"sm",onClick:()=>Ie(R.instruction),title:"Lire l'instruction audio",className:"flex items-center gap-2 hover:bg-gray-100",children:[e.jsx(Dt,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Ã‰couter"})]}),e.jsxs("div",{className:"relative ml-auto",children:[e.jsxs($,{variant:"ghost",size:"sm",onClick:()=>pe(!te),title:`Taille du texte (${Math.round(le*100)}%)`,className:"flex items-center gap-2 hover:bg-gray-100",children:[e.jsx(gs,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Texte"})]}),te&&e.jsx("div",{className:"absolute bg-white border-2 border-gray-300 rounded-lg shadow-xl z-50 min-w-[160px] top-full mt-2 right-0",children:e.jsxs("div",{className:"p-2",children:[e.jsx("p",{className:"text-xs font-semibold text-gray-600 mb-2 px-2",children:"Taille du texte:"}),[1,1.25,1.5,2].map(x=>e.jsxs("button",{onClick:()=>{be(x),pe(!1)},className:j("w-full text-left px-3 py-2 text-sm rounded hover:bg-blue-50 transition-colors",le===x&&"bg-blue-100 font-semibold text-blue-800"),children:[Math.round(x*100),"%"]},x))]})})]})]}),e.jsxs(jt,{className:"w-full max-w-4xl mx-auto border-2 border-blue-500",children:[e.jsx(as,{className:"bg-blue-50",children:e.jsxs(is,{className:"text-blue-700",children:["Question ",m+1," / ",h.length]})}),e.jsxs(yt,{className:"space-y-6",children:[e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg border-l-4 border-blue-600",children:[e.jsx("h3",{className:"text-xl font-bold text-blue-900 mb-2",style:{fontSize:`${100*le}%`},children:e.jsx(Yt,{text:R.instruction})}),R.imageId&&e.jsx("div",{className:"mb-4 flex justify-center",children:e.jsx(ht,{imageId:R.imageId,alt:"Question",className:"w-full max-w-md h-auto rounded-lg object-contain"})})]}),e.jsx("div",{className:"space-y-3",children:R.choices.map((x,S)=>{var z;console.log("ðŸŽ¯ Affichage choice:",{id:x.id,text:x.text,imageId:x.imageId,iconId:x.iconId});const C=x.id||S,p=ye.includes(C),D=x.iconId||((z=x.icon)==null?void 0:z.id)||(typeof x.icon=="string"?x.icon:null)||(Hn(x.imageId)?x.imageId:null),A=D?null:x.imageId;return e.jsxs("div",{className:`flex items-start gap-3 p-3 rounded-lg border-2 transition-all ${p?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-blue-300"}`,children:[e.jsx("input",{type:"checkbox",checked:p,onChange:()=>$e(C),className:"w-5 h-5 mt-1 cursor-pointer accent-blue-600"}),e.jsxs("label",{className:"flex-1 cursor-pointer",children:[x.iconSvg?e.jsx("div",{className:"mb-2 flex justify-center",children:e.jsx("div",{className:"w-32 h-32 flex items-center justify-center bg-primary/10 rounded-lg",children:e.jsx("div",{dangerouslySetInnerHTML:{__html:x.iconSvg}})})}):D?e.jsx("div",{className:"mb-2 flex justify-center",children:e.jsx("div",{className:"w-32 h-32 flex items-center justify-center bg-primary/10 rounded-lg",children:Wn(D)})}):A?e.jsx("div",{className:"mb-2 flex justify-center",children:e.jsx(ht,{imageId:A,alt:x.text||"RÃ©ponse",className:"w-32 h-32 rounded object-contain cursor-pointer"})}):null,x.text&&e.jsx("p",{className:"text-base",style:{fontSize:`${100*le}%`},children:e.jsx(Yt,{text:x.text})})]})]},C)})}),e.jsxs("div",{className:"flex gap-2 justify-between pt-4 border-t",children:[e.jsxs($,{variant:"outline",onClick:ve,disabled:m===0,children:[e.jsx(ft,{className:"w-4 h-4 mr-2"}),"PrÃ©cÃ©dent"]}),m===h.length-1?e.jsx($,{onClick:Y,disabled:T,className:"bg-blue-600 hover:bg-blue-700",children:T?"Soumission...":"Soumettre"}):e.jsxs($,{onClick:de,className:"bg-blue-600 hover:bg-blue-700 text-white",children:["Suivant",e.jsx(Rt,{className:"w-4 h-4 ml-2"})]})]}),e.jsx("div",{className:"pt-2",children:e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all",style:{width:`${(m+1)/h.length*100}%`}})})})]})]})]})}const Gt=({children:t,showPhoneFrame:o=!1,hideActionZones:i=!1,onButtonClick:a=()=>{},buttonConfig:r=jn,hideButtons:s=!1})=>{if(!o)return t;const n=yn(r),h=n.buttons;return e.jsxs("div",{className:"relative w-full",style:{overflow:"visible",margin:0,padding:0},children:[e.jsxs("div",{className:"absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-8 text-xs text-gray-500 font-semibold z-50 whitespace-nowrap",style:{pointerEvents:"none"},children:["ðŸ“± ",n.name]}),e.jsx("div",{style:{position:"relative",width:"100%",overflow:"visible",margin:0,padding:0},children:t}),!s&&Object.entries(h).map(([c,m])=>{const N=m.position.side==="right";return e.jsx("div",{style:{position:"absolute",[N?"right":"left"]:"-40px",top:m.position.top,transform:"translateY(-50%)",minWidth:"32px",width:m.width||"32px",height:m.height?Math.max(32,parseInt(m.height)*.75):"36px",padding:"4px",backgroundColor:"#000000",borderRadius:"8px",cursor:"pointer",zIndex:9999,boxShadow:"0 4px 12px rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"14px",color:"#ffffff",fontWeight:"700",transition:"all 0.18s ease",userSelect:"none",pointerEvents:"auto",overflow:"visible",margin:0,border:"2px solid rgba(255,255,255,0.3)"},className:"hover:scale-110 hover:shadow-2xl active:scale-95",onClick:()=>a(m.id),title:m.description,children:m.icon},m.id)})]})},Qt=({isVisible:t,onClose:o,actionType:i,startArea:a})=>{if(!t||!i)return null;const r=()=>({tap:"Appuyer",long_press:"Appui long",swipe_left:"Glisser vers la gauche",swipe_right:"Glisser vers la droite",swipe_up:"Glisser vers le haut",swipe_down:"Glisser vers le bas",drag_and_drop:"Glisser et dÃ©poser",text_input:"Saisir du texte",number_input:"Saisir un numÃ©ro"})[i]||i.replace(/_/g," ");return e.jsx(Ue,{children:e.jsx(Q.div,{className:"w-full bg-blue-50 border border-blue-200 rounded-md p-2 mt-1",initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex items-start gap-2 flex-1",children:[e.jsx(Tt,{className:"h-4 w-4 text-blue-600 flex-shrink-0 mt-0.5"}),e.jsx("div",{className:"text-xs text-blue-700",children:e.jsxs("p",{className:"font-semibold",children:["Action: ",r()]})})]}),e.jsx($,{onClick:o,variant:"ghost",size:"sm",className:"h-5 w-5 p-0 flex-shrink-0",children:e.jsx(at,{className:"h-3 w-3"})})]})})})},mt=t=>["button_power","button_volume_up","button_volume_down","button_power_volume_down","button_power_volume_up","button_volume_up_down"].includes(t),Xn=({open:t,onClose:o,taskId:i,userId:a})=>{const[r,s]=l.useState([]),[n,h]=l.useState(!1),{toast:c}=pt();l.useEffect(()=>{t&&a&&m()},[t,i,a]);const m=()=>ee(void 0,null,function*(){h(!0);try{const{data:v,error:y}=yield ne.from("learner_notes").select(`
          id,
          note_text,
          created_at,
          versions:version_id(name),
          steps:step_id(instruction),
          learner_note_images(image_url)
        `).eq("user_id",a).eq("task_id",i).order("created_at",{ascending:!1});if(y)throw y;s(v||[])}catch(v){console.error("Erreur lors du chargement des notes:",v),c({title:"Erreur",description:"Impossible de charger les notes",variant:"destructive"})}finally{h(!1)}}),N=v=>ee(void 0,null,function*(){try{const{error:y}=yield ne.from("learner_notes").delete().eq("id",v);if(y)throw y;c({title:"SuccÃ¨s",description:"Note supprimÃ©e"}),m()}catch(y){console.error("Erreur lors de la suppression:",y),c({title:"Erreur",description:"Impossible de supprimer la note",variant:"destructive"})}});return t?e.jsx(Ue,{children:e.jsx(Q.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center bg-black/30 p-4",onClick:o,children:e.jsxs(Q.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},className:"bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[80vh] overflow-hidden",onClick:v=>v.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b sticky top-0 bg-white z-10",children:[e.jsxs("h2",{className:"font-bold text-lg flex items-center gap-2",children:[e.jsx(Nt,{className:"h-5 w-5 text-primary"}),"Mes notes personnelles"]}),e.jsx($,{variant:"ghost",size:"icon",onClick:o,children:e.jsx(at,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"p-4 overflow-y-auto max-h-[calc(80vh-80px)]",children:n?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(vs,{className:"h-8 w-8 animate-spin text-primary"})}):r.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(Nt,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Aucune note enregistrÃ©e pour cette tÃ¢che"})]}):e.jsx("div",{className:"space-y-4",children:r.map(v=>e.jsxs(jt,{children:[e.jsx(as,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-grow",children:[e.jsx(is,{className:"text-sm font-medium text-muted-foreground",children:new Date(v.created_at).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}),v.versions&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Version : ",v.versions.name]}),v.steps&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Ã‰tape : ",v.steps.instruction]})]}),e.jsx($,{variant:"ghost",size:"icon",onClick:()=>N(v.id),className:"text-destructive hover:text-destructive",children:e.jsx(fn,{className:"h-4 w-4"})})]})}),e.jsxs(yt,{children:[v.note_text&&e.jsx("p",{className:"text-sm whitespace-pre-wrap mb-3",children:v.note_text}),v.learner_note_images&&v.learner_note_images.length>0&&e.jsx("div",{className:"grid grid-cols-2 gap-2",children:v.learner_note_images.map((y,P)=>e.jsx("img",{src:y.image_url,alt:`Capture ${P+1}`,className:"rounded border w-full h-32 object-cover cursor-pointer hover:opacity-80 transition-opacity",onClick:()=>window.open(y.image_url,"_blank")},P))})]})]},v.id))})})]})})}):null},Yn=()=>{l.useEffect(()=>{document.documentElement.style.overscrollBehavior="none",document.documentElement.style.overscrollBehaviorY="none",document.documentElement.style.overscrollBehaviorX="none",document.body.style.overscrollBehavior="none",document.body.style.overscrollBehaviorY="none",document.body.style.overscrollBehaviorX="none";let t=0;const o=s=>{const n=Date.now();n-t<300&&s.preventDefault(),t=n,s.touches&&s.touches[0].clientX<15&&s.preventDefault()},i=s=>{const n=s.target;(n.closest(".exercise-container")||n.closest("[data-zoomable-image]")||n.closest("motion-div")||n.closest('[style*="touchAction"]'))&&s.cancelable},a=s=>{s.preventDefault()};document.addEventListener("touchstart",o,{passive:!1}),document.addEventListener("touchmove",i,{passive:!1}),document.addEventListener("gesturestart",a,{passive:!1});const r=document.createElement("style");return r.textContent=`
      html, body {
        overscroll-behavior: none !important;
        overscroll-behavior-y: none !important;
        overscroll-behavior-x: none !important;
        touch-action: manipulation !important;
        user-select: none !important;
        -webkit-user-select: none !important;
        -webkit-touch-callout: none !important;
      }
      
      * {
        -webkit-user-select: none !important;
        -webkit-touch-callout: none !important;
      }
      
      [data-zoomable-image], 
      .exercise-container,
      motion-div[style*="touchAction"] {
        touch-action: none !important;
        user-select: none !important;
        -webkit-user-select: none !important;
        -webkit-touch-callout: none !important;
      }
    `,document.head.appendChild(r),()=>{document.removeEventListener("touchstart",o),document.removeEventListener("touchmove",i),document.removeEventListener("gesturestart",a),document.head.removeChild(r),document.documentElement.style.overscrollBehavior="auto",document.body.style.overscrollBehavior="auto"}},[])},Zt=({isOpen:t,onClose:o,onReturnToTasks:i})=>t?e.jsx(Q.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 z-50 flex items-center justify-center",style:{background:"linear-gradient(135deg, rgba(240, 253, 244, 0.85) 0%, rgba(209, 250, 229, 0.85) 100%)",backdropFilter:"blur(3px)"},children:e.jsxs(Q.div,{initial:{scale:.8,y:20},animate:{scale:1,y:0},transition:{type:"spring",stiffness:200,damping:20},className:"text-center px-6 py-8 max-w-sm",children:[e.jsx(Q.div,{initial:{scale:0},animate:{scale:1,rotate:[0,-10,10,-10,0]},transition:{scale:{delay:.2,type:"spring",stiffness:200},rotate:{delay:.3,duration:.5}},className:"mb-6 flex justify-center",children:e.jsx("div",{className:"w-24 h-24 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center shadow-lg",children:e.jsx(ws,{className:"w-12 h-12 text-white",strokeWidth:2.5})})}),e.jsx(Q.h2,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.3},className:"text-4xl font-bold text-gray-800 mb-4",style:{fontFamily:"system-ui, -apple-system"},children:"Bravo !"}),e.jsx(Q.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.4},className:"text-lg text-gray-600 mb-8",children:"Vous avez terminÃ© cet exercice avec succÃ¨s."}),e.jsx(Q.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.5},children:e.jsx($,{onClick:i,size:"lg",className:"bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold px-8 py-6 text-lg shadow-lg",children:"Retour Ã  la liste des tÃ¢ches"})})]})}):null;function Un({isOpen:t,onClose:o,onSubmit:i,taskTitle:a}){const[r,s]=l.useState(null),n=[{value:1,emoji:"ðŸ˜Ÿ",label:"Pas confiant",description:"J'ai peur de me tromper"},{value:2,emoji:"ðŸ™‚",label:"Un peu confiant",description:"Je vais essayer"},{value:3,emoji:"ðŸ˜„",label:"Confiant",description:"Je peux le faire"}],h=()=>{r!==null&&(i(r),s(null))};return e.jsx(ls,{open:t,onOpenChange:o,children:e.jsxs(cs,{className:"max-w-md",children:[e.jsxs(ds,{children:[e.jsx(us,{className:"text-center text-lg",children:"Avant de commencer"}),e.jsxs(ms,{className:"text-center mt-2",children:[e.jsx("p",{className:"font-semibold text-foreground",children:a}),e.jsx("p",{className:"mt-2 text-sm",children:"Combien tu te sens confiant(e) pour cet exercice?"})]})]}),e.jsx("div",{className:"grid grid-cols-3 gap-3 my-6",children:n.map(c=>e.jsxs(Q.button,{onClick:()=>s(c.value),whileHover:{scale:1.05},whileTap:{scale:.95},className:`
                flex flex-col items-center justify-center p-4 rounded-lg border-2 transition-all
                ${r===c.value?"border-green-500 bg-green-50 ring-2 ring-green-300":"border-gray-200 hover:border-gray-300 bg-white hover:bg-gray-50"}
              `,children:[e.jsx("span",{className:"text-4xl mb-2",children:c.emoji}),e.jsx("span",{className:"text-xs font-semibold text-center text-gray-900",children:c.label}),e.jsx("span",{className:"text-xs text-gray-600 text-center mt-1",children:c.description})]},c.value))}),e.jsx("div",{className:"flex gap-2",children:e.jsx($,{onClick:h,disabled:r===null,className:"flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold",children:"Commencer l'exercice"})}),e.jsx("p",{className:"text-xs text-center text-gray-600 mt-4",children:"N'oublie pas: cet exercice est une simulation. Tu peux te tromper autant que tu veux - c'est comme Ã§a qu'on apprend ! ðŸ’ª"})]})})}function Gn({isOpen:t,onClose:o,onSubmit:i,taskTitle:a,confidenceBefore:r}){const[s,n]=l.useState(null),h=[{value:1,emoji:"ðŸ˜Ÿ",label:"Pas confiant",description:"C'est difficile"},{value:2,emoji:"ðŸ™‚",label:"Un peu confiant",description:"C'est mieux"},{value:3,emoji:"ðŸ˜„",label:"Confiant",description:"Je maÃ®trise!"}],m=(()=>{if(!r||s===null)return null;if(s>r){const v=s-r;if(v===2)return{title:"ðŸŒŸ Wow! Progression Ã©norme!",message:"Tu as gagnÃ© Ã©normÃ©ment en confiance. Bravo, tu as progressÃ©!",color:"text-green-600"};if(v===1)return{title:"âœ¨ Super! Tu as progressÃ©!",message:"Tu es devenu(e) plus confiant(e). Continue comme Ã§a!",color:"text-green-600"}}else return s===r?{title:"ðŸ‘ Bien!",message:"Tu as gardÃ© ton niveau de confiance. Tu maÃ®trises cet exercice!",color:"text-blue-600"}:{title:"ðŸ’ª C'est normal!",message:"L'apprentissage, c'est progressif. Tu vas progresser rapidement!",color:"text-amber-600"}})(),N=()=>{s!==null&&(i(s),n(null))};return e.jsx(ls,{open:t,onOpenChange:o,children:e.jsxs(cs,{className:"max-w-md",children:[e.jsxs(ds,{children:[e.jsx(us,{className:"text-center text-lg",children:"AprÃ¨s l'exercice"}),e.jsxs(ms,{className:"text-center mt-2",children:[e.jsx("p",{className:"font-semibold text-foreground",children:a}),e.jsx("p",{className:"mt-2 text-sm",children:"Maintenant, combien tu te sens confiant(e)?"})]})]}),e.jsx("div",{className:"grid grid-cols-3 gap-3 my-6",children:h.map(v=>e.jsxs(Q.button,{onClick:()=>n(v.value),whileHover:{scale:1.05},whileTap:{scale:.95},className:`
                flex flex-col items-center justify-center p-4 rounded-lg border-2 transition-all
                ${s===v.value?"border-blue-500 bg-blue-50 ring-2 ring-blue-300":"border-gray-200 hover:border-gray-300 bg-white hover:bg-gray-50"}
              `,children:[e.jsx("span",{className:"text-4xl mb-2",children:v.emoji}),e.jsx("span",{className:"text-xs font-semibold text-center text-gray-900",children:v.label}),e.jsx("span",{className:"text-xs text-gray-600 text-center mt-1",children:v.description})]},v.value))}),m&&e.jsxs(Q.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`p-4 rounded-lg bg-gray-50 border-l-4 ${m.color==="text-green-600"?"border-green-400":m.color==="text-blue-600"?"border-blue-400":"border-amber-400"}`,children:[e.jsx("p",{className:`font-bold mb-1 ${m.color}`,children:m.title}),e.jsx("p",{className:"text-sm text-gray-700",children:m.message})]}),e.jsx("div",{className:"flex gap-2 mt-6",children:e.jsx($,{onClick:N,disabled:s===null,className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold",children:"Continuer"})}),e.jsx("div",{className:"text-xs text-center text-gray-600 mt-4",children:e.jsxs("p",{className:"flex items-center justify-center gap-1",children:[e.jsx(gn,{className:"w-3 h-3"})," Tu progresses! C'est comme Ã§a qu'on devient compÃ©tent!"]})})]})})}const Ss=t=>t?t.split(/[\s-]+/).map(o=>o.charAt(0).toUpperCase()+o.slice(1).toLowerCase()).join(""):null,Qn=t=>{if(!t)return qe;if(t.includes(":")){const[i,a]=t.split(":"),s={lucide:ot,fa6:rt,fa:rt,bs:kt,md:Pt,fi:Et,hi2:It,ai:At}[i];return s&&s[a]?s[a]:qe}const o=Ss(t);return ot[o]||qe},Zn=({taskTitle:t,currentStep:o,onPlayAudio:i,showInstructions:a,textZoom:r,isMobileLayout:s,currentLanguage:n="fr"})=>{let h=qe;try{o!=null&&o.icon_name&&(h=Qn(o.icon_name))}catch(c){console.warn("Icon resolution error in ExerciseHeader:",c),h=qe}return e.jsxs("div",{className:j("flex justify-between items-center shrink-0 relative bg-white p-4 rounded-lg shadow",s?"mb-1 p-2":"mb-4"),"data-exercise-header":!0,children:[e.jsx("div",{className:"flex items-center gap-1 flex-grow min-w-0",children:e.jsx("div",{className:j("font-bold text-primary line-clamp-3",s?"text-xs":"text-xl sm:text-2xl"),style:{fontSize:`${100*r}%`},children:e.jsx(Ct,{text:t,language:n,className:"w-full"},`title-${n}`)})}),a&&!s&&e.jsxs("div",{className:"flex items-center gap-3",children:[h&&e.jsx("div",{className:"flex items-center justify-center w-10 h-10 rounded-full bg-primary/10",children:e.jsx(h,{className:"w-6 h-6 text-primary"})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("div",{className:"text-gray-700 text-base",style:{fontSize:`${100*r}%`},children:e.jsx(Ct,{text:(o==null?void 0:o.instruction)||"Aucune instruction",language:n,className:"w-full"},`instr-${n}`)})})]})]})},Jn=({currentStep:t,currentStepIndex:o,totalSteps:i,showInstructions:a,isMobileLayout:r,onPlayAudio:s,iconName:n,currentLanguage:h})=>{if(!t)return null;const c=ot[Ss(n)]||null;return e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h3",{className:j("font-semibold text-accent-foreground flex items-center",r?"text-xs":"text-sm sm:text-base"),children:[e.jsx(bn,{className:j("mr-1 text-primary",r?"h-3 w-3":"h-4 sm:h-5 w-4 sm:w-5")}),"Action (",o+1,"/",i,"):"]}),e.jsx($,{variant:"ghost",size:"icon_xs",onClick:()=>s(t.instruction),title:"Lire l'instruction",className:r?"h-5 w-5":"",children:e.jsx(Dt,{className:j("text-primary",r?"h-3 w-3":"h-4 w-4")})})]}),e.jsxs("div",{className:"flex items-start space-x-1 sm:space-x-2",children:[e.jsx("div",{className:j("flex-shrink-0 bg-white border rounded-md flex items-center justify-center",r?"h-7 w-7 p-0.5":"h-10 w-10 sm:h-12 sm:w-12 p-0.5 sm:p-1"),children:c?e.jsx(c,{className:j("object-contain text-primary",r?"h-5 w-5":"h-8 w-8")}):t.pictogram_app_image_id?e.jsx(ht,{imageId:t.pictogram_app_image_id,alt:"Pictogramme de l'Ã©tape",className:j("object-contain","h-full w-full")}):e.jsx(qe,{className:j("object-contain text-muted-foreground",r?"h-5 w-5":"h-8 w-8")})}),e.jsx("div",{className:j("text-foreground leading-snug flex-grow",r?"text-xs":"text-sm sm:text-md"),children:e.jsx(Ct,{text:t.instruction,language:h,className:""},`step-instr-${h}`)})]}),t.hint&&e.jsx("div",{className:j("mt-2 p-2 rounded bg-blue-50 border border-blue-200 text-blue-900 text-xs font-semibold",r?"text-xs":"text-sm"),children:t.hint})]})},Jt=({onBackToList:t,isMobileLayout:o})=>e.jsxs(Q.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},transition:{duration:.3},className:"absolute inset-0 bg-background/80 backdrop-blur-sm flex flex-col items-center justify-center text-center p-4 z-20",children:[e.jsx(ws,{className:j("text-primary",o?"h-16 w-16":"h-24 w-24")}),e.jsx("h2",{className:j("font-bold mt-4",o?"text-2xl":"text-4xl"),children:"Bravo !"}),e.jsx("p",{className:j("text-muted-foreground mt-2",o?"text-sm":"text-lg"),children:"Vous avez terminÃ© cet exercice avec succÃ¨s."}),e.jsx($,{onClick:t,className:j("mt-6",o?" ":"text-base py-6 px-8"),children:"Retour Ã  la liste des tÃ¢ches"})]}),Kn=({open:t,onClose:o,taskId:i,versionId:a,stepId:r,userId:s})=>{const[n,h]=l.useState(""),[c,m]=l.useState([]),[N,v]=l.useState(!1),{toast:y}=pt();if(!t)return null;const P=()=>ee(void 0,null,function*(){if(!n.trim()&&c.length===0){y({title:"Erreur",description:"Ajoutez au moins une note ou une image",variant:"destructive"});return}v(!0);try{const{data:w,error:T}=yield ne.from("learner_notes").insert({user_id:s,task_id:i,version_id:a,step_id:r,note_text:n.trim()||null}).select().single();if(T)throw T;if(c.length>0)for(const Z of c){const U=Z.name.split(".").pop(),J=`${w.id}_${Date.now()}.${U}`,B=`learner-notes/${s}/${J}`,{error:G}=yield ne.storage.from("images").upload(B,Z);if(G)throw G;const{data:{publicUrl:O}}=ne.storage.from("images").getPublicUrl(B),{error:ie}=yield ne.from("learner_note_images").insert({note_id:w.id,image_url:O});if(ie)throw ie}y({title:"SuccÃ¨s",description:"Note enregistrÃ©e avec succÃ¨s !"}),h(""),m([]),o()}catch(w){console.error("Erreur lors de la sauvegarde:",w),y({title:"Erreur",description:"Impossible d'enregistrer la note",variant:"destructive"})}finally{v(!1)}});return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/30",onClick:o,children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 w-full max-w-sm mx-4",onClick:w=>w.stopPropagation(),children:[e.jsx("h2",{className:"font-bold text-lg mb-4",children:"Ajouter une note personnelle"}),e.jsx("textarea",{className:"w-full border rounded mb-3 p-2 text-sm",rows:4,placeholder:"Ã‰crivez votre note ici...",value:n,onChange:w=>h(w.target.value)}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Captures d'Ã©cran (optionnel)"}),e.jsx("input",{type:"file",accept:"image/*",multiple:!0,onChange:w=>m(Array.from(w.target.files||[])),className:"text-sm w-full"}),c.length>0&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[c.length," image(s) sÃ©lectionnÃ©e(s)"]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx($,{variant:"outline",onClick:o,disabled:N,children:"Annuler"}),e.jsx($,{variant:"default",onClick:P,disabled:N,children:N?"Enregistrement...":"Enregistrer"})]})]})})},ur=()=>{console.log("ðŸ”´ ExercisePage chargÃ© - VERSION AVEC BOUTON NOTES - "+new Date().toISOString());const[t,o]=l.useState(!1),[i,a]=l.useState(!1),[r,s]=l.useState(null),[n,h]=l.useState(null),[c,m]=l.useState(0),[N,v]=l.useState(!0),[y,P]=l.useState(!1),[w,T]=l.useState(!1),[Z,U]=l.useState(!1),[J,B]=l.useState(!0),[G,O]=l.useState(!1),[ie,le]=l.useState(1),[be,te]=l.useState(null),[pe,I]=l.useState(!1),[ce,R]=l.useState(!1),[$e,ve]=l.useState(!1),[de,Ie]=l.useState(!1),[Y,ye]=l.useState(!1),[x,S]=l.useState("exercise"),[C,p]=l.useState(!1),[D,A]=l.useState(!1),[z,Me]=l.useState(null),[Ae,re]=l.useState("fr"),[Ve,V]=l.useState("en"),Le=l.useRef(null),{taskId:K,versionId:q}=Qs(),ue=xt(),We=Zs(),{toast:Te}=pt(),He=Js(),{currentUser:_}=os(),Xe=rn(),{recordConfidenceBefore:bt,recordConfidenceAfter:u,fetchConfidence:g}=wn(),k=l.useRef(null),E=l.useCallback(f=>ee(void 0,null,function*(){re(f);try{if(localStorage.setItem("preferredLanguage",f),_!=null&&_.id&&f!=="fr"){const{error:b}=yield ne.from("profiles").update({preferred_translation_language:f}).eq("id",_.id);b&&console.error("Error saving language to profile:",b)}}catch(b){console.error("Error saving language preference:",b)}}),[_==null?void 0:_.id]);l.useEffect(()=>{(()=>ee(void 0,null,function*(){if(_!=null&&_.id)try{const{data:b}=yield ne.from("profiles").select("preferred_translation_language").eq("id",_.id).single();if(b!=null&&b.preferred_translation_language){const L=b.preferred_translation_language;V(L),localStorage.setItem("preferredLanguage",L),L!=="fr"&&re(L)}}catch(b){console.error("Error loading user language preference:",b)}}))()},[_==null?void 0:_.id]),Yn();const M=(He==null?void 0:He.isMobileView)||!1,W=We.pathname.includes("/admin/preview");l.useEffect(()=>{const f=()=>o(!0);return window.addEventListener("openNotesModal",f),()=>window.removeEventListener("openNotesModal",f)},[]),l.useEffect(()=>{const f=document.body.style.overflow,b=document.body.style.position,L=document.body.style.top,Fe=document.body.style.left,Pe=document.body.style.right,Je=document.body.style.bottom,fe=document.body.style.width,Ye=document.body.style.height,vt=document.body.style.touchAction,dt=document.documentElement.style.overflow;let ae=0;const X=Ee=>(Ee.preventDefault(),Ee.stopPropagation(),!1),Be=()=>{ae=window.pageYOffset||document.documentElement.scrollTop,document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.top=`-${ae}px`,document.body.style.left="0",document.body.style.right="0",document.body.style.width="100%",document.body.style.height="100vh",document.body.style.touchAction="none",document.documentElement.style.overflow="hidden",window.addEventListener("scroll",X,{passive:!1}),window.addEventListener("touchmove",X,{passive:!1}),window.addEventListener("wheel",X,{passive:!1})},xe=()=>{document.body.style.overflow=f,document.body.style.position=b,document.body.style.top=L,document.body.style.left=Fe,document.body.style.right=Pe,document.body.style.bottom=Je,document.body.style.width=fe,document.body.style.height=Ye,document.body.style.touchAction=vt,document.documentElement.style.overflow=dt,window.scrollTo(0,ae),window.removeEventListener("scroll",X,{passive:!1}),window.removeEventListener("touchmove",X,{passive:!1}),window.removeEventListener("wheel",X,{passive:!1})},ge=Ee=>{var et,tt,st;const Ke=(tt=(et=Ee.target)==null?void 0:et.tagName)==null?void 0:tt.toLowerCase();if(Ke==="input"||Ke==="textarea"||(st=Ee.target)!=null&&st.isContentEditable){const Ot=document.querySelector("[data-exercise-header]");Ot?Ot.scrollIntoView({behavior:"instant",block:"start"}):window.scrollTo({top:0,behavior:"instant"}),setTimeout(()=>Be(),100)}},De=Ee=>{var et,tt,st;const Ke=(tt=(et=Ee.target)==null?void 0:et.tagName)==null?void 0:tt.toLowerCase();(Ke==="input"||Ke==="textarea"||(st=Ee.target)!=null&&st.isContentEditable)&&setTimeout(()=>xe(),300)};return window.addEventListener("focusin",ge),window.addEventListener("focusout",De),()=>{xe(),window.removeEventListener("focusin",ge),window.removeEventListener("focusout",De)}},[]),l.useEffect(()=>{k.current=Date.now()},[q]),l.useEffect(()=>{if(n&&n.steps&&n.steps.length>0){const f=n.steps.some(b=>mt(b.action_type));ve(f)}},[n]),l.useEffect(()=>{(()=>ee(void 0,null,function*(){B(!0),te(null),T(!1);try{let b;if(W){if(!Xe||!Xe.tasks||Xe.tasks.length===0)return;b=Xe.tasks.find(fe=>fe.id===K)}else{const fe=`exercise:${K}`,Ye=an(fe);if(Ye){b=Ye,s(b);const ae=b.versions.find(X=>X.id===q);if(ae){ae.steps=ae.steps?ae.steps.sort((ge,De)=>ge.step_order-De.step_order):[],S(b.task_type||"exercise"),h(ae);const Be=new URLSearchParams(We.search).get("step"),xe=Be?parseInt(Be,10)-1:0;m(xe>=0&&xe<ae.steps.length?xe:0),P(!1),B(!1)}ee(void 0,null,function*(){try{const{data:X,error:Be}=yield ne.from("tasks").select("id, title, video_url, task_type, versions(*)").eq("id",K).maybeSingle();if(Be)throw Be;if(X&&X.versions){for(const ge of X.versions){const{data:De,error:Ee}=yield ne.from("steps").select("*").eq("version_id",ge.id).order("step_order");ge.steps=De||[]}Ft(fe,X,36e5);const xe=X.versions.find(ge=>ge.id===q);xe&&(xe.steps=xe.steps?xe.steps.sort((ge,De)=>ge.step_order-De.step_order):[],s(X),h(xe))}}catch(X){console.warn("Background refresh failed, using cached data:",X)}});return}const{data:vt,error:dt}=yield ne.from("tasks").select("id, title, video_url, task_type, versions(*)").eq("id",K).maybeSingle();if(dt)throw dt;if(b=vt,b&&b.versions){for(const ae of b.versions){const{data:X}=yield ne.from("steps").select("*").eq("version_id",ae.id).order("step_order");ae.steps=X||[]}Ft(fe,b,36e5)}}if(!b){te("TÃ¢che non trouvÃ©e. Elle a peut-Ãªtre Ã©tÃ© supprimÃ©e."),B(!1);return}const L=b.versions.find(fe=>fe.id===q);if(L)L.steps=L.steps?L.steps.sort((fe,Ye)=>fe.step_order-Ye.step_order):[];else{te("Version de l'exercice non trouvÃ©e."),B(!1),s(b);return}s(b),S(b.task_type||"exercise"),h(L);const Pe=new URLSearchParams(We.search).get("step"),Je=Pe?parseInt(Pe,10)-1:0;m(Je>=0&&Je<L.steps.length?Je:0),P(!1)}catch(b){console.error("Error fetching data:",b),te("Impossible de charger les donnÃ©es de l'exercice. VÃ©rifiez votre connexion Internet.")}finally{B(!1)}}))()},[K,q,W,We.search]),l.useEffect(()=>{(()=>ee(void 0,null,function*(){if(n&&_&&!W&&!J)try{const b=yield g(_.id,q);(!b||!b.confidence_before)&&p(!0)}catch(b){console.error("Error checking confidence:",b),p(!0)}}))()},[q,_,W,J,g]);const H=f=>{const b=W?`/admin/preview/tache/${K}/version/${f}`:`/tache/${K}/version/${f}`;ue(b)},me=l.useCallback((f=!1)=>ee(void 0,null,function*(){if(P(!0),_&&!W&&!f?A(!0):f||T(!0),_&&!W&&k.current){const b=(Date.now()-k.current)/1e3;try{const L=yield qt(_.id,q,b);L&&L.error?(console.error("recordCompletion error",L.error),Te({title:"Erreur",description:"Impossible d'enregistrer la progression.",variant:"destructive"})):console.log("Progression enregistrÃ©e avec succÃ¨s")}catch(L){console.error("recordCompletion threw",L),Te({title:"Erreur",description:"Enregistrement Ã©chouÃ©.",variant:"destructive"})}}}),[_,W,q,Te]),we=l.useCallback(f=>{if(!(!n||!n.steps||c>=n.steps.length)&&f){const b=n.steps[c];if(!b){console.error("âŒ currentStep est undefined, index:",c);return}if((b==null?void 0:b.action_type)==="bravo"){ye(!0),c===n.steps.length-1&&me(!0);return}Le.current&&Le.current.dismiss();const L=Te({title:"Bien jouÃ© !",description:`Ã‰tape ${c+1} rÃ©ussie.`,action:e.jsx(St,{className:"text-green-500"}),duration:2e3});Le.current=L,c<n.steps.length-1?m(Fe=>Fe+1):me()}},[n,c,Te,me]),Qe=f=>ee(void 0,null,function*(){Me(f),_&&q&&(yield bt(_.id,q,f)),p(!1)}),Ze=f=>ee(void 0,null,function*(){_&&q&&(yield u(_.id,q,f)),A(!1),T(!0)}),Ne=()=>{n&&c<n.steps.length-1?m(f=>f+1):n&&c===n.steps.length-1&&!y&&me()},Se=()=>{c>0&&(m(f=>f-1),P(!1),T(!1))},Ce=f=>{if("speechSynthesis"in window&&f){const b=new SpeechSynthesisUtterance(f);b.lang="fr-FR",b.rate=1,b.pitch=1.2,b.volume=1;const L=window.speechSynthesis.getVoices(),Fe=L.find(Pe=>Pe.lang.startsWith("fr")&&Pe.name.toLowerCase().includes("female"))||L.find(Pe=>Pe.lang.startsWith("fr"));Fe&&(b.voice=Fe),window.speechSynthesis.cancel(),window.speechSynthesis.speak(b)}else Te({title:"Audio non disponible",description:"La lecture audio n'est pas supportÃ©e par votre navigateur ou aucun texte n'est disponible.",variant:"destructive"})};if(J)return e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx(vs,{className:"h-8 w-8 animate-spin text-primary"})});if(be)return e.jsxs("div",{className:"flex flex-col items-center justify-center text-center p-4 h-full",children:[e.jsx(Bt,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Erreur de chargement"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:be}),e.jsxs($,{onClick:()=>ue("/taches"),children:[e.jsx(ft,{className:"mr-2 h-4 w-4"}),"Retour Ã  la liste des tÃ¢ches"]})]});if(!r||!n||!n.steps||!Array.isArray(n.steps))return console.error("âŒ DonnÃ©es invalides:",{task:!!r,currentVersion:!!n,steps:n==null?void 0:n.steps}),null;if(c>=n.steps.length)return console.error("âŒ Index de step invalide:",c,"max:",n.steps.length),null;const d=n.steps[c];if(!d)return console.error("âŒ currentStep est undefined"),null;const oe=n.steps.length,_e=n.steps.some(f=>mt(f.action_type)),ke=_e&&(mt(d==null?void 0:d.action_type)||de);console.log("PhoneFrame Debug:",{shouldShowPhoneFrame:ke,hasPhoneButtonActions:_e,currentActionType:d==null?void 0:d.action_type,isPhysicalButton:mt(d==null?void 0:d.action_type),buttonConfig:d==null?void 0:d.button_config,forceShowPhoneFrame:de});const he=r.versions?[...r.versions].sort((f,b)=>f.name.localeCompare(b.name)):[],je=he.findIndex(f=>f.id===n.id);je>0&&he[je-1],je<he.length-1&&he[je+1];const Re=n.video_url||r.video_url;if(x==="questionnaire")return e.jsx(Q.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"w-full h-full p-4",children:e.jsx(Ut,{versionId:q,taskId:K,learner_id:_==null?void 0:_.id,onComplete:()=>{T(!0),setTimeout(()=>ue("/taches"),3e3)}})},`questionnaire-${q}`);const lt=e.jsxs("div",{className:"p-0.5 sm:p-1 bg-card rounded-lg shadow-xl flex flex-col h-full relative",children:[e.jsx(Ue,{children:w&&e.jsx(Jt,{onBackToList:()=>ue("/taches"),isMobileLayout:!0})}),e.jsx(Mn,{versionName:n.name,versionNumber:n.version,progress:oe>0?(y?oe:c+1)/oe*100:0,hasVideo:!!Re,onVideoClick:()=>U(!0),onListClick:()=>ue(`/tache/${K}`),isMobileLayout:!0}),n.has_variant_note&&e.jsxs("div",{className:"p-1 my-0.5 text-2xs bg-amber-100 border-l-4 border-amber-500 text-amber-700 rounded shrink-0",children:[e.jsxs("div",{className:"flex items-center",children:[" ",e.jsx(Bt,{className:"mr-1 h-2.5 w-2.5"})," ",e.jsx("p",{className:"font-semibold",children:"Note :"})," "]}),e.jsx("p",{children:"Cette version peut prÃ©senter des diffÃ©rences."})]}),e.jsx("div",{className:"flex items-center justify-center space-x-2 mb-1"}),!N&&e.jsx(Jn,{currentStep:d,currentStepIndex:c,totalSteps:oe,showInstructions:N,isMobileLayout:!0,onPlayAudio:Ce,iconName:d==null?void 0:d.icon_name,currentLanguage:Ae}),e.jsx(Gt,{showPhoneFrame:ke,buttonConfig:(d==null?void 0:d.button_config)||"samsung",hideButtons:Y,onButtonClick:f=>{({power:"button_power",volumeUp:"button_volume_up",volumeDown:"button_volume_down"})[f]===(d==null?void 0:d.action_type)&&we(!0)},children:e.jsxs("div",{className:"flex-grow min-h-0 w-full aspect-[9/16] bg-black rounded-lg overflow-hidden relative",children:[e.jsx(Vt,{imageId:d==null?void 0:d.app_image_id,alt:"Capture d'Ã©cran pour l'Ã©tape",targetArea:d==null?void 0:d.target_area,actionType:d==null?void 0:d.action_type,startArea:d==null?void 0:d.start_area,onInteraction:we,imageContainerClassName:"w-full h-full",isMobileLayout:!0,isZoomActive:G,hideActionZone:ce,keyboardAutoShow:(d==null?void 0:d.keyboard_auto_show)||!1,expectedInput:(d==null?void 0:d.expected_input)||""}),e.jsx(Zt,{isOpen:Y,onClose:()=>ye(!1),onReturnToTasks:()=>ue("/taches")})]})}),e.jsxs("div",{className:"shrink-0 mt-1.5",children:[e.jsx($n,{isZoomActive:G,onZoomToggle:()=>O(f=>!f),showInstructions:N,onInstructionsToggle:()=>v(f=>!f),hideActionZone:ce,onHideActionZone:()=>R(f=>!f),hasPhoneButtonActions:_e,forceShowPhoneFrame:de,onForceShowPhoneFrame:()=>Ie(f=>!f),versions:he,currentVersionId:q,onVersionChange:H,isMobileLayout:!0,taskId:K,versionId:q,currentStepIndex:c,onDebugForceSave:void 0,onDebugDeleteProgress:void 0}),e.jsx(Qt,{isVisible:pe,onClose:()=>I(!1),actionType:d==null?void 0:d.action_type,startArea:d==null?void 0:d.start_area}),e.jsx(Ln,{onPrev:Se,onNext:Ne,isPrevDisabled:c===0,isNextDisabled:c===oe-1&&y,isCompleted:y,isMobileLayout:!0})]})]}),ct=e.jsxs("div",{className:"bg-card rounded-lg shadow-xl",children:[e.jsx(Ue,{children:w&&e.jsx(Jt,{onBackToList:()=>ue("/taches"),isMobileLayout:!1})}),e.jsxs("div",{className:"flex gap-2 items-start p-4 pb-0",children:[e.jsx(Fn,{isZoomActive:G,onZoomToggle:()=>O(f=>!f),showInstructions:N,onInstructionsToggle:()=>v(f=>!f),hideActionZone:ce,onHideActionZone:()=>R(f=>!f),versions:he,currentVersionId:q,onVersionChange:H,onNavigateHome:()=>ue("/"),onViewNotes:()=>a(!0),onAddNote:()=>window.dispatchEvent(new CustomEvent("openNotesModal")),onPrev:Se,onNext:Ne,isPrevDisabled:c===0,isNextDisabled:c===oe-1&&y,onNavigateToTasks:()=>ue("/taches"),onPlayAudio:Ce,currentStep:d,textZoom:ie,onTextZoomChange:le,isMobileLayout:!1,taskId:K,versionId:q,currentStepIndex:c,totalSteps:oe,currentLanguage:Ae,onLanguageChange:E,preferredLanguage:Ve}),e.jsx("div",{className:"flex-1",children:e.jsx(Gt,{showPhoneFrame:ke,buttonConfig:(d==null?void 0:d.button_config)||"samsung",onButtonClick:f=>{({power:"button_power",volumeUp:"button_volume_up",volumeDown:"button_volume_down"})[f]===(d==null?void 0:d.action_type)&&we(!0)},children:e.jsxs("div",{className:"relative w-full h-full",children:[e.jsx(Vt,{imageId:d==null?void 0:d.app_image_id,alt:"Capture d'Ã©cran pour l'Ã©tape",targetArea:d==null?void 0:d.target_area,actionType:d==null?void 0:d.action_type,startArea:d==null?void 0:d.start_area,onInteraction:we,imageContainerClassName:"",isMobileLayout:!1,isZoomActive:G,hideActionZone:ce,keyboardAutoShow:(d==null?void 0:d.keyboard_auto_show)||!1,expectedInput:(d==null?void 0:d.expected_input)||""}),e.jsx(Zt,{isOpen:Y,onClose:()=>ye(!1),onReturnToTasks:()=>ue("/taches")})]})})})]}),e.jsx(Qt,{isVisible:pe,onClose:()=>I(!1),actionType:d==null?void 0:d.action_type,startArea:d==null?void 0:d.start_area})]});return e.jsxs(Q.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.3},className:j("mx-auto flex flex-col w-full h-screen",M?"p-0.5 overflow-hidden":"p-2 md:p-4 max-w-4xl mx-auto overflow-auto"),children:[e.jsxs("div",{className:j("shrink-0 z-50",M?"sticky top-0 bg-background pb-1":""),children:[e.jsx(Zn,{taskTitle:r.title,currentStep:d,onPlayAudio:Ce,showInstructions:N,textZoom:ie,isMobileLayout:M,currentLanguage:Ae}),e.jsx(Kn,{open:t,onClose:()=>o(!1),taskId:r==null?void 0:r.id,versionId:n==null?void 0:n.id,stepId:d==null?void 0:d.id,userId:_==null?void 0:_.id}),e.jsx(Xn,{open:i,onClose:()=>a(!1),taskId:r==null?void 0:r.id,userId:_==null?void 0:_.id})]}),e.jsx("div",{className:j("flex-grow min-h-0 overflow-y-auto p-4"),children:e.jsx(Ue,{mode:"wait",children:x==="questionnaire"?e.jsx(Ut,{versionId:q,taskId:K,learner_id:_==null?void 0:_.id,onComplete:f=>{qt(_==null?void 0:_.id,q,Date.now()-(k.current||Date.now())),T(!0)}}):e.jsx(Q.div,{initial:{opacity:0,x:M?5:15},animate:{opacity:1,x:0},exit:{opacity:0,x:M?-5:-15},transition:{duration:.2},className:j("flex flex-col",M?"h-full":""),children:M?lt:ct},`${n.id}-${c}`)})}),e.jsx("div",{className:j("flex justify-between shrink-0",M?"mt-1.5":"mt-4 sm:mt-6 md:mt-8")}),e.jsx(on,{isOpen:Z,onClose:()=>U(!1),videoUrl:Re,title:`VidÃ©o pour: ${n.name}`}),e.jsx(Un,{isOpen:C,onClose:()=>p(!1),onSubmit:Qe,taskTitle:(r==null?void 0:r.title)||"Cet exercice"}),e.jsx(Gn,{isOpen:D,onClose:()=>{A(!1),T(!0)},onSubmit:Ze,taskTitle:(r==null?void 0:r.title)||"Cet exercice",confidenceBefore:z})]})};export{ur as default};
