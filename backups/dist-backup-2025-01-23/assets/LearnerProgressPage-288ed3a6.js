var E=(t,m,i)=>new Promise((l,o)=>{var b=h=>{try{w(i.next(h))}catch(x){o(x)}},a=h=>{try{w(i.throw(h))}catch(x){o(x)}},w=h=>h.done?l(h.value):Promise.resolve(h.value).then(b,a);w((i=i.apply(t,m)).next())});import{j as e}from"./radix-ui-2f58371e.js";import{r as j}from"./react-vendor-6cf6ded9.js";import{m as ie,c as le,u as oe,i as ce,aS as de,s as me,C as M,k as V,l as k,w as xe,j as $,e as O,aV as fe,an as ue}from"./index-426aa6f1.js";import{u as he,f as pe}from"./useConfidence-4739bd19.js";import{T as X,a as G,b as A,c as y,d as J,e as u}from"./table-8f722342.js";import{S as Y}from"./scroll-area-8a7e81aa.js";import{A as ge,h as je,a as be,b as _e,c as Ne,d as ve,e as we,f as ye,g as Ce}from"./alert-dialog-bc29e295.js";import{t as H,bc as Ae,aW as De,y as Te,Z as Se,R as Pe,K as Ee}from"./ui-icons-e73ce4f7.js";import"./supabase-4b7d20da.js";import"./index-d203b311.js";function U({value:t,onChange:m,editable:i=!1,size:l="md"}){const o=[{value:1,emoji:"üòü",label:"Pas confiant"},{value:2,emoji:"üôÇ",label:"Un peu"},{value:3,emoji:"üòÑ",label:"Confiant"}],b={sm:"text-lg",md:"text-2xl",lg:"text-4xl"};if(!i&&t){const a=o.find(w=>w.value===t);return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:b[l],children:a==null?void 0:a.emoji}),e.jsx("span",{className:"text-xs text-gray-600",children:a==null?void 0:a.label})]})}return i?e.jsx("div",{className:"flex gap-2 justify-center",children:o.map(a=>e.jsx(ie.button,{onClick:()=>m(a.value),whileHover:{scale:1.1},whileTap:{scale:.95},className:le("p-2 rounded-lg border-2 transition-all",t===a.value?"border-green-500 bg-green-50 ring-2 ring-green-300":"border-gray-200 hover:border-gray-300 bg-white hover:bg-gray-50"),title:a.label,children:e.jsx("span",{className:b[l],children:a.emoji})},a.value))}):e.jsx("span",{className:"text-gray-400 text-sm",children:"-"})}const Q=(t,m)=>{if(!t||!m||m.length===0)return!1;const i=m.reduce((o,b)=>o+b,0)/m.length,l=Math.max(i*.1,5);return t>=l},Me=(t,m,i,l)=>{const o=t.filter(r=>{const d=new Date(r.created_at||new Date);return d>=i&&d<=l});if(o.length===0)return{totalExercises:0,avgAttempts:0,speedProgress:0,avgConfidenceBefore:0,avgConfidenceAfter:0};const a=(o.reduce((r,d)=>r+(d.attempts||0),0)/o.length).toFixed(1),w=o.filter(r=>r.first_time_seconds&&r.best_time_seconds),h=w.flatMap(r=>[r.first_time_seconds,r.best_time_seconds]),x=w.filter(r=>{const d=Q(r.first_time_seconds,h),S=Q(r.best_time_seconds,h);return d&&S});let D=0;x.length>0&&(D=x.reduce((r,d)=>{const S=(d.first_time_seconds-d.best_time_seconds)/d.first_time_seconds*100;return r+S},0)/x.length);const f=o.map(r=>m.get(r.id)).filter(Boolean),B=f.length>0?(f.reduce((r,d)=>r+(d.confidence_before||0),0)/f.length).toFixed(1):0,R=f.length>0?(f.reduce((r,d)=>r+(d.confidence_after||0),0)/f.length).toFixed(1):0;return{totalExercises:o.length,avgAttempts:a,speedProgress:D.toFixed(1),avgConfidenceBefore:B,avgConfidenceAfter:R}},qe=()=>{const{currentUser:t,refetchUser:m}=oe(),{toast:i}=ce(),[l,o]=j.useState(null),[b,a]=j.useState(!1),[w,h]=j.useState([]),[x,D]=j.useState(!0),[f,B]=j.useState(null),[R,r]=j.useState(!0),[d,S]=j.useState([]);j.useState("last-week");const[q,ee]=j.useState([]),{fetchConfidenceHistory:W,recordConfidenceAfter:se}=he(),F=j.useCallback(()=>E(void 0,null,function*(){if(!(t!=null&&t.id)){D(!1),o([]);return}D(!0);try{const s=yield de();let c=[],p=[],P=[];h(s||[]);try{c=yield pe(t.id),p=yield W(t.id);const{data:n,error:N}=yield me.from("questionnaire_attempts").select("*").eq("learner_id",t.id).eq("status","completed").order("attempted_at",{ascending:!1});!N&&n&&(P=n,console.log("QCM attempts loaded:",n)),a(!1)}catch(n){console.error("Error fetching progress:",n),a(!0),c=[],p=[],P=[]}const T=new Map;(c||[]).forEach(n=>{T.set(`${n.task_id}-${n.version_id}`,n)});const _=new Map;(p||[]).forEach(n=>{_.set(`${n.versionId}`,n)});const Z=[],K=[];s.forEach(n=>{if(n.task_type==="questionnaire"){const N=P.filter(v=>v.questionnaire_id===n.id);if(N.length>0){const v=[...N].sort((L,z)=>new Date(z.attempted_at)-new Date(L.attempted_at)),g=v[v.length-1],C=v.reduce((L,z)=>z.percentage>L.percentage?z:L,v[0]);K.push({id:n.id,task_title:n.title,totalAttempts:N.length,firstAttemptScore:g.percentage,bestScore:C.percentage,lastAttemptDate:v[0].attempted_at})}}else(n.versions||[]).forEach(N=>{const v=`${n.id}-${N.id}`,g=T.get(v),C=_.get(N.id);Z.push({id:v,versionId:N.id,task_title:n.title,version_name:N.name,attempts:g?g.attempts:0,first_time_seconds:g?g.first_time_seconds:null,best_time_seconds:g?g.best_time_seconds:null,completed_steps_history:g?g.completed_steps_history:null,created_at:g?g.created_at:new Date().toISOString(),confidence_before:(C==null?void 0:C.confidenceBefore)||null,confidence_after:(C==null?void 0:C.confidenceAfter)||null})})}),o(Z),ee(K),S(p),b||i({title:"Progression mise √† jour",description:"Vos donn√©es de suivi sont √† jour."})}catch(s){console.error("Error in fetchProgressData:",s),a(!0),o([])}finally{D(!1)}}),[t,i,W]);j.useEffect(()=>{F()},[F]),j.useEffect(()=>{(()=>E(void 0,null,function*(){r(!0);try{if(t!=null&&t.trainer_id){const c=yield fe(t.trainer_id);B(c)}}catch(c){console.error("Error loading trainer profile:",c)}finally{r(!1)}}))()},[t==null?void 0:t.trainer_id]);const te=()=>E(void 0,null,function*(){try{yield ue(t.id),B(null),i({title:"Succ√®s",description:"Vous avez √©t√© d√©li√© du formateur."}),m&&(yield m())}catch(s){i({title:"Erreur",description:"La dissociation a √©chou√©.",variant:"destructive"})}}),re=()=>f?[f.first_name,f.last_name,f.pseudo?`(${f.pseudo})`:""].filter(Boolean).join(" "):"";if(!t)return e.jsx("div",{className:"flex justify-center items-center h-full pt-16",children:e.jsx(H,{className:"h-8 w-8 animate-spin"})});const ae=()=>{if(!(t!=null&&t.created_at))return null;const s=new Date(t.created_at),c=new Date;return{period1:{label:"Ma premi√®re semaine",startDate:s,endDate:new Date(s.getTime()+7*24*60*60*1e3)},period2:{label:"Mon premier mois",startDate:s,endDate:new Date(s.getTime()+30*24*60*60*1e3)},period3:{label:"Ma derni√®re semaine",startDate:new Date(c.getTime()-7*24*60*60*1e3),endDate:c}}},ne=(s,c)=>E(void 0,null,function*(){try{yield se(t.id,s,c),yield F(),i({title:"Confiance mise √† jour",description:"Votre confiance a √©t√© enregistr√©e."})}catch(p){console.error("Error updating confidence:",p),i({title:"Erreur",description:"Impossible de mettre √† jour la confiance.",variant:"destructive"})}}),I=ae();return e.jsxs("div",{className:"container mx-auto p-4 md:p-8",children:[e.jsx(M,{className:"mb-6 shadow-lg",children:e.jsxs(V,{children:[e.jsxs(k,{className:"text-3xl flex items-center",children:[e.jsx(Ae,{className:"mr-3 h-8 w-8 text-primary"}),"Mon Suivi d'Apprentissage"]}),e.jsxs(xe,{children:["Bonjour ",t.first_name," ! Suivez vos progr√®s et g√©rez votre liaison avec un formateur."]})]})}),e.jsxs(M,{className:"mb-6",children:[e.jsx(V,{children:e.jsxs(k,{className:"text-xl flex items-center",children:[e.jsx(De,{className:"mr-2 h-5 w-5"}),"Liaison Formateur"]})}),e.jsx($,{children:R?e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(H,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{children:"Chargement du profil formateur..."})]}):f?e.jsxs("div",{className:"flex items-center justify-between p-4 bg-muted/50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Li√© au formateur :"}),e.jsx("p",{className:"font-semibold text-lg",children:re()})]}),e.jsxs(ge,{children:[e.jsx(je,{asChild:!0,children:e.jsxs(O,{variant:"destructive",size:"sm",children:[e.jsx(Te,{className:"mr-2 h-4 w-4"})," Modifier la liaison"]})}),e.jsxs(be,{className:"max-h-[90vh] overflow-y-auto",children:[e.jsxs(_e,{children:[e.jsx(Ne,{children:"Voulez-vous vraiment vous d√©lier ?"}),e.jsx(ve,{children:"Cette action est irr√©versible. Vous devrez contacter votre formateur pour √™tre li√© √† nouveau."})]}),e.jsxs(we,{children:[e.jsx(ye,{children:"Annuler"}),e.jsx(Ce,{onClick:te,className:"bg-destructive hover:bg-destructive/80",children:"Confirmer la dissociation"})]})]})]})]}):e.jsxs("p",{className:"text-muted-foreground",children:["Vous n'√™tes actuellement li√© √† aucun formateur. Partagez votre code apprenant (",e.jsx("strong",{className:"text-primary",children:t.learner_code}),") avec votre formateur pour qu'il puisse vous lier."]})})]}),!x&&l&&l.length>0&&I&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[I.period1,I.period2,I.period3].map((s,c)=>{const p=Me(l,new Map,s.startDate,s.endDate);return e.jsxs(M,{className:"bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200",children:[e.jsx(V,{className:"pb-3",children:e.jsx(k,{className:"text-lg text-blue-900",children:s.label})}),e.jsxs($,{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-blue-700",children:"Exercices r√©alis√©s"}),e.jsx("span",{className:"font-bold text-blue-900",children:p.totalExercises})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-blue-700",children:"Moyenne tentatives"}),e.jsx("span",{className:"font-bold text-blue-900",children:parseFloat(p.avgAttempts).toFixed(1)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-blue-700",children:"Progression vitesse"}),e.jsxs("span",{className:"font-bold text-green-600",children:["+",parseFloat(p.speedProgress).toFixed(1),"%"]})]})]})]},c)})}),e.jsxs(M,{className:"mb-6",children:[e.jsxs(V,{className:"flex flex-row items-center justify-between",children:[e.jsxs(k,{className:"text-xl flex items-center",children:[e.jsx(Se,{className:"mr-2 h-5 w-5 text-primary"}),"D√©tail de vos exercices"]}),e.jsxs(O,{variant:"outline",size:"sm",onClick:F,disabled:x,children:[e.jsx(Pe,{className:`mr-2 h-4 w-4 ${x?"animate-spin":""}`}),"Rafra√Æchir"]})]}),e.jsxs($,{children:[b&&e.jsx("div",{className:"text-red-600 mb-2",children:"Erreur : Impossible de charger la progression. Les t√¢ches sont affich√©es sans suivi."}),e.jsx(Y,{className:"h-[600px]",children:e.jsxs(X,{children:[e.jsx(G,{children:e.jsxs(A,{children:[e.jsx(y,{children:"T√¢che / Version"}),e.jsx(y,{className:"text-center",children:"Tentatives"}),e.jsx(y,{className:"text-center",children:"Progression vitesse"}),e.jsx(y,{className:"text-center",children:"Confiance Avant"}),e.jsx(y,{className:"text-center",children:"Confiance Apr√®s"})]})}),e.jsx(J,{children:x&&l===null?e.jsx(A,{children:e.jsx(u,{colSpan:5,className:"text-center",children:e.jsx(H,{className:"mx-auto h-6 w-6 animate-spin"})})}):l&&l.length>0?l.map((s,c)=>{const p=Q(s.first_time_seconds,l.flatMap(_=>[_.first_time_seconds,_.best_time_seconds]).filter(Boolean)),P=Q(s.best_time_seconds,l.flatMap(_=>[_.first_time_seconds,_.best_time_seconds]).filter(Boolean)),T=p&&P&&s.first_time_seconds&&s.best_time_seconds?(s.first_time_seconds-s.best_time_seconds)/s.first_time_seconds*100:0;return e.jsxs(A,{children:[e.jsxs(u,{children:[e.jsx("p",{className:"font-medium",children:s.task_title}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.version_name})]}),e.jsx(u,{className:"text-center",children:s.attempts}),e.jsx(u,{className:"text-center",children:e.jsxs("span",{className:`font-semibold ${T>0?"text-green-600":"text-gray-500"}`,children:[T>0?"+":"",T.toFixed(1),"%"]})}),e.jsx(u,{className:"text-center",children:e.jsx(U,{value:s.confidence_before,editable:!1,size:"sm"})}),e.jsx(u,{className:"text-center",children:e.jsx(U,{value:s.confidence_after,onChange:_=>ne(s.versionId,_),editable:!0,size:"sm"})})]},c)}):e.jsx(A,{children:e.jsx(u,{colSpan:5,className:"text-center text-muted-foreground",children:"Aucune t√¢che disponible ou progression."})})})]})})]})]}),e.jsxs(M,{children:[e.jsx(V,{children:e.jsxs(k,{className:"text-xl flex items-center",children:[e.jsx(Ee,{className:"mr-2 h-5 w-5 text-blue-600"}),"D√©tail de vos QCM"]})}),e.jsxs($,{children:[b&&e.jsx("div",{className:"text-red-600 mb-2",children:"Erreur : Impossible de charger les QCM."}),e.jsx(Y,{className:"h-[400px]",children:e.jsxs(X,{children:[e.jsx(G,{children:e.jsxs(A,{className:"bg-blue-50",children:[e.jsx(y,{children:"QCM / Version"}),e.jsx(y,{className:"text-center",children:"Nombre de tentatives"}),e.jsx(y,{className:"text-center",children:"Taux bonne r√©ponse 1√®re fois"}),e.jsx(y,{className:"text-center",children:"Meilleur taux bonne r√©ponse"})]})}),e.jsx(J,{children:x&&q.length===0?e.jsx(A,{children:e.jsx(u,{colSpan:4,className:"text-center",children:e.jsx(H,{className:"mx-auto h-6 w-6 animate-spin"})})}):q.length>0?q.map((s,c)=>e.jsxs(A,{className:"hover:bg-blue-50/50",children:[e.jsxs(u,{children:[e.jsx("p",{className:"font-medium text-blue-900",children:s.task_title}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.version_name})]}),e.jsx(u,{className:"text-center font-semibold",children:s.totalAttempts}),e.jsx(u,{className:"text-center",children:e.jsxs("span",{className:`font-semibold px-3 py-1 rounded-full ${s.firstAttemptScore>=80?"bg-green-100 text-green-700":s.firstAttemptScore>=50?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:[s.firstAttemptScore,"%"]})}),e.jsx(u,{className:"text-center",children:e.jsxs("span",{className:`font-semibold px-3 py-1 rounded-full ${s.bestScore>=80?"bg-green-100 text-green-700":s.bestScore>=50?"bg-yellow-100 text-yellow-700":"bg-red-100 text-red-700"}`,children:[s.bestScore,"%"]})})]},c)):e.jsx(A,{children:e.jsx(u,{colSpan:4,className:"text-center text-muted-foreground",children:"Aucun QCM compl√©t√© pour le moment."})})})]})})]})]})]})};export{qe as default};
