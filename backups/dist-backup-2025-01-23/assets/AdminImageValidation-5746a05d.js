var se=Object.defineProperty,te=Object.defineProperties;var ae=Object.getOwnPropertyDescriptors;var D=Object.getOwnPropertySymbols;var re=Object.prototype.hasOwnProperty,le=Object.prototype.propertyIsEnumerable;var F=(d,n,r)=>n in d?se(d,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):d[n]=r,L=(d,n)=>{for(var r in n||(n={}))re.call(n,r)&&F(d,r,n[r]);if(D)for(var r of D(n))le.call(n,r)&&F(d,r,n[r]);return d},H=(d,n)=>te(d,ae(n));var N=(d,n,r)=>new Promise((g,j)=>{var C=s=>{try{m(r.next(s))}catch(o){j(o)}},v=s=>{try{m(r.throw(s))}catch(o){j(o)}},m=s=>s.done?g(s.value):Promise.resolve(s.value).then(C,v);m((r=r.apply(d,n)).next())});import{j as e}from"./radix-ui-2f58371e.js";import{r as c}from"./react-vendor-6cf6ded9.js";import{u as ne,aB as ie,s as f}from"./index-426aa6f1.js";import{A as O}from"./AdminTabNavigation-8abb78e2.js";import{H as B,a1 as de,A as oe,ai as ce,X as T,v as me,w as xe,a3 as ue}from"./ui-icons-e73ce4f7.js";import"./supabase-4b7d20da.js";function Ne(){const{currentUser:d}=ne(),{counters:n}=ie(),[r,g]=c.useState([]),[j,C]=c.useState(!0),[v,m]=c.useState(0),[s,o]=c.useState(null),[x,b]=c.useState(null),[q,V]=c.useState(!1),[E,S]=c.useState(""),[G,A]=c.useState(!1),[R,w]=c.useState(""),[h,k]=c.useState(null),M=c.useRef(!1),[p,Q]=c.useState(0),[_,U]=c.useState(0),y=20;c.useEffect(()=>{P()},[]);const P=(t=0)=>N(this,null,function*(){var a;if(M.current){console.log("⚠️ Chargement déjà en cours, annulation...");return}M.current=!0,C(!0);try{const{count:l,error:i}=yield f.from("images_metadata").select("*",{count:"exact",head:!0}).eq("moderation_status","pending");if(i)throw i;U(l||0);const u=t*y,ee=u+y-1,{data:I,error:z}=yield f.from("images_metadata").select(`
          *,
          uploader:uploaded_by (
            id,
            first_name,
            last_name,
            email,
            role
          )
        `).eq("moderation_status","pending").order("uploaded_at",{ascending:!1}).range(u,ee);if(z)throw z;g(I||[]),Q(t),I&&I.length>0?(o(I[0]),m(0)):(o(null),m(0))}catch(l){console.error("Erreur lors du chargement des images:",l),(a=l.message)!=null&&a.includes("aborted")||alert("Erreur: "+l.message)}finally{C(!1),M.current=!1}}),X=t=>N(this,null,function*(){if(!x){b(t);try{const{error:a}=yield f.from("images_metadata").update({moderation_status:"approved",reviewed_by:d.id,reviewed_at:new Date().toISOString()}).eq("id",t);if(a)throw a;const l=r.filter(i=>i.id!==t);if(g(l),l.length>0){const i=Math.min(v,l.length-1);m(i),o(l[i])}else o(null),m(0);alert("✅ Image approuvée!")}catch(a){console.error("Erreur:",a),alert("❌ Erreur: "+a.message)}finally{b(null)}}}),$=t=>{k(t),w(""),A(!0)},J=()=>N(this,null,function*(){if(!(!h||!R.trim()||x)){b(h);try{const{error:t}=yield f.from("images_metadata").update({moderation_status:"rejected",rejection_reason:R.trim(),reviewed_by:d.id,reviewed_at:new Date().toISOString()}).eq("id",h);if(t)throw t;const a=r.filter(l=>l.id!==h);if(g(a),a.length>0){const l=Math.min(v,a.length-1);m(l),o(a[l])}else o(null),m(0);A(!1),k(null),w(""),alert("✅ Image rejetée")}catch(t){console.error("Erreur:",t),alert("❌ Erreur: "+t.message)}finally{b(null)}}}),K=()=>N(this,null,function*(){if(!(!s||!E.trim()))try{const{error:t}=yield f.from("images_metadata").update({android_version:E.trim()}).eq("id",s.id);if(t)throw t;const a=H(L({},s),{android_version:E.trim()});o(a),g(r.map(l=>l.id===s.id?a:l)),V(!1),S(""),alert("✅ Version Android mise à jour!")}catch(t){console.error("Erreur:",t),alert("❌ Erreur: "+t.message)}}),W=()=>{S((s==null?void 0:s.android_version)||""),V(!0)},Y=()=>{V(!1),S("")},Z=t=>N(this,null,function*(){if(!(!confirm("Êtes-vous sûr?")||x)){b(t);try{const a=r.find(u=>u.id===t);a!=null&&a.file_path&&(yield f.storage.from("images").remove([a.file_path]));const{error:l}=yield f.from("images_metadata").delete().eq("id",t);if(l)throw l;const i=r.filter(u=>u.id!==t);if(g(i),i.length>0){const u=Math.min(v,i.length-1);m(u),o(i[u])}else o(null),m(0);alert("✅ Image supprimée")}catch(a){console.error("Erreur:",a),alert("❌ Erreur: "+a.message)}finally{b(null)}}});return j?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600",children:"Chargement..."})]})}):r.length===0?e.jsxs("div",{className:"container mx-auto p-4",children:[e.jsx("div",{className:"bg-white rounded-lg border shadow-sm mb-6",children:e.jsxs("div",{className:"flex flex-col space-y-1.5 p-6",children:[e.jsxs("h3",{className:"flex items-center text-3xl font-semibold leading-none tracking-tight",children:[e.jsx(B,{className:"mr-3 h-8 w-8 text-primary"}),"Validation des images"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Validez les images soumises par les contributeurs"})]})}),e.jsx(O,{counters:n}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center",children:[e.jsx(de,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Aucune image à valider"}),e.jsx("p",{className:"text-gray-600",children:"Toutes les images en attente ont été validées!"})]})]}):e.jsxs("div",{className:"container mx-auto p-4",children:[e.jsx("div",{className:"bg-white rounded-lg border shadow-sm mb-6",children:e.jsxs("div",{className:"flex flex-col space-y-1.5 p-6",children:[e.jsxs("h3",{className:"flex items-center text-3xl font-semibold leading-none tracking-tight",children:[e.jsx(B,{className:"mr-3 h-8 w-8 text-primary"}),"Validation des images"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[r.length," image(s) en attente de validation"]})]})}),e.jsx(O,{counters:n}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[s&&e.jsx("div",{className:"lg:col-span-2",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"aspect-video bg-gray-100 flex items-center justify-center",children:e.jsx("img",{src:s.public_url,alt:s.title,className:"max-w-full max-h-full object-contain"})}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:s.title}),e.jsx("p",{className:"text-gray-600 mt-2",children:s.description})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Catégorie"}),e.jsx("p",{className:"font-medium text-gray-900 capitalize",children:s.category})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Date"}),e.jsx("p",{className:"font-medium text-gray-900",children:new Date(s.uploaded_at).toLocaleDateString("fr-FR")})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Version Android"}),!q&&e.jsx("button",{onClick:W,className:"text-blue-600 hover:text-blue-800 text-xs",title:"Modifier la version Android",children:"✏️ Modifier"})]}),q?e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("input",{type:"text",value:E,onChange:t=>S(t.target.value),className:"flex-1 px-2 py-1 border border-gray-300 rounded text-sm",placeholder:"Ex: Android 13",autoFocus:!0}),e.jsx("button",{onClick:K,className:"text-green-600 hover:text-green-800 font-bold",title:"Sauvegarder",children:"✓"}),e.jsx("button",{onClick:Y,className:"text-red-600 hover:text-red-800 font-bold",title:"Annuler",children:"✕"})]}):e.jsx("p",{className:"font-medium text-gray-900",children:s.android_version||"Non spécifiée"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Statut"}),e.jsx("p",{className:"font-medium text-gray-900 capitalize",children:s.moderation_status==="pending"?"En attente":s.moderation_status})]})]}),s.tags&&s.tags.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600 text-sm",children:"Tags"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:s.tags.map((t,a)=>e.jsx("span",{className:"px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm",children:t},a))})]}),s.uploader&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("p",{className:"text-sm text-blue-600 font-medium",children:"Soumis par"}),e.jsxs("p",{className:"text-gray-900 font-medium",children:[s.uploader.first_name," ",s.uploader.last_name]}),e.jsx("p",{className:"text-sm text-gray-600",children:s.uploader.email}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Rôle: ",e.jsx("span",{className:"font-medium",children:s.uploader.role})]})]}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(oe,{className:"w-5 h-5 text-yellow-600 mt-0.5 mr-3 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-semibold mb-1",children:"À vérifier avant d'approuver:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-xs",children:[e.jsx("li",{children:"Aucune donnée personnelle visible"}),e.jsx("li",{children:"Qualité d'image acceptable"}),e.jsx("li",{children:"Contenu approprié pour l'app"}),e.jsx("li",{children:"Pas de contenu dupliqué"})]})]})]})}),e.jsxs("div",{className:"flex gap-3 pt-4 border-t",children:[e.jsxs("button",{onClick:()=>X(s.id),disabled:x===s.id,className:"flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors disabled:opacity-50",children:[e.jsx(ce,{className:"w-5 h-5"}),e.jsx("span",{children:"Approuver"})]}),e.jsxs("button",{onClick:()=>$(s.id),disabled:x===s.id,className:"flex-1 flex items-center justify-center gap-2 px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors disabled:opacity-50",children:[e.jsx(T,{className:"w-5 h-5"}),e.jsx("span",{children:"Rejeter"})]}),e.jsx("button",{onClick:()=>Z(s.id),disabled:x===s.id,className:"flex items-center justify-center gap-2 px-4 py-3 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition-colors disabled:opacity-50",title:"Supprimer",children:e.jsx(me,{className:"w-5 h-5"})})]})]})]})}),e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b bg-gray-50",children:[e.jsxs("h3",{className:"font-semibold text-gray-900",children:["En attente (",_,")"]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Page ",p+1," / ",Math.ceil(_/y)]})]}),e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b bg-gray-50",children:[e.jsxs("button",{onClick:()=>P(p-1),disabled:p===0||j,className:"flex items-center gap-1 px-3 py-1 text-sm text-blue-600 hover:bg-blue-50 rounded disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"Page précédente",children:[e.jsx(xe,{className:"w-4 h-4"}),"Préc."]}),e.jsxs("span",{className:"text-sm text-gray-600",children:[p*y+1," - ",Math.min((p+1)*y,_)," / ",_]}),e.jsxs("button",{onClick:()=>P(p+1),disabled:(p+1)*y>=_||j,className:"flex items-center gap-1 px-3 py-1 text-sm text-blue-600 hover:bg-blue-50 rounded disabled:opacity-50 disabled:cursor-not-allowed","aria-label":"Page suivante",children:["Suiv.",e.jsx(ue,{className:"w-4 h-4"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:r.map((t,a)=>{var l,i;return e.jsxs("button",{onClick:()=>{o(t),m(a)},className:`w-full p-3 text-left border-b transition-colors ${(s==null?void 0:s.id)===t.id?"bg-blue-50 border-l-4 border-l-blue-600":"hover:bg-gray-50"}`,children:[e.jsx("img",{src:t.public_url,alt:t.title,className:"w-full h-20 object-cover rounded mb-2"}),e.jsx("p",{className:"font-medium text-gray-900 text-sm truncate",children:t.title}),e.jsxs("p",{className:"text-xs text-gray-600",children:[(l=t.uploader)==null?void 0:l.first_name," ",(i=t.uploader)==null?void 0:i.last_name]})]},t.id)})})]})})]}),G&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsx("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Rejeter l'image"}),e.jsx("button",{onClick:()=>{A(!1),k(null),w("")},className:"text-gray-400 hover:text-gray-600",children:e.jsx(T,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Raison du rejet *"}),e.jsx("textarea",{value:R,onChange:t=>w(t.target.value),placeholder:"Ex: Image floue, données personnelles visibles, contenu inapproprié...",rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent resize-none"})]})}),e.jsxs("div",{className:"flex gap-3 mt-6 pt-4 border-t",children:[e.jsx("button",{onClick:J,disabled:x===h||!R.trim(),className:"flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors disabled:opacity-50",children:x===h?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Rejet..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"w-4 h-4"}),e.jsx("span",{children:"Rejeter"})]})}),e.jsx("button",{onClick:()=>{A(!1),k(null),w("")},disabled:x===h,className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50",children:"Annuler"})]})]})})})]})}export{Ne as default};
