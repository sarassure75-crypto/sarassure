var g=(r,p,x)=>new Promise((a,c)=>{var f=i=>{try{d(x.next(i))}catch(m){c(m)}},l=i=>{try{d(x.throw(i))}catch(m){c(m)}},d=i=>i.done?a(i.value):Promise.resolve(i.value).then(f,l);d((x=x.apply(r,p)).next())});import{j as e}from"./radix-ui-2f58371e.js";import{r as j,f as D,e as b}from"./react-vendor-6cf6ded9.js";import{u as S,i as E,Z as P,e as h,s as v,C as A,k as F,l as $,w as R,j as G,$ as O}from"./index-426aa6f1.js";import{t as w,G as M,ai as B,b as V,ad as q,aV as H,aW as L,L as K}from"./ui-icons-e73ce4f7.js";import"./supabase-4b7d20da.js";const W=({onSubmitted:r,taskId:p=null,trainerId:x=null})=>{const{currentUser:a}=S(),{toast:c}=E(),[f,l]=j.useState(5),[d,i]=j.useState(""),[m,N]=j.useState(!1);j.useEffect(()=>{},[a]);const t=s=>g(void 0,null,function*(){if(s&&s.preventDefault(),!a){c({title:"Connexion requise",description:"Veuillez vous connecter pour envoyer votre avis.",variant:"destructive"});return}N(!0);try{const{error:n}=yield v.from("learner_reviews").insert({learner_id:a.id,rating:parseInt(f,10),comment:d||null,task_id:p||null,trainer_id:x||null});if(n)throw n;c({title:"Merci !",description:"Votre avis a bien √©t√© enregistr√©."}),i(""),l(5),r&&r()}catch(n){console.error("Satisfaction submit error:",n),c({title:"Erreur",description:n.message||"Impossible d'envoyer l'avis.",variant:"destructive"})}finally{N(!1)}});return e.jsxs("form",{onSubmit:t,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Votre satisfaction (1-5)"}),e.jsx("div",{className:"flex gap-2",children:[1,2,3,4,5].map(s=>e.jsx("button",{type:"button",onClick:()=>l(s),className:`px-3 py-2 rounded-lg border ${f===s?"bg-primary text-white":"bg-white text-muted-foreground"}`,children:s},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Commentaire (optionnel)"}),e.jsx(P,{value:d,onChange:s=>i(s.target.value),placeholder:"Dites-nous ce que vous avez aim√© ou pas..."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{type:"submit",disabled:m,children:m?"Envoi...":"Envoyer mon avis"}),e.jsx(h,{type:"button",variant:"outline",onClick:()=>{i(""),l(5)},children:"Annuler"})]})]})},Z=()=>{const{currentUser:r}=S(),{toast:p}=E(),[x,a]=j.useState(!0),[c,f]=j.useState(!1),[l,d]=j.useState("fr"),[i,m]=j.useState([]);j.useEffect(()=>{(()=>g(void 0,null,function*(){if(!(r!=null&&r.id)){a(!1);return}try{const{data:s}=yield v.from("translation_settings").select("language_code, language_name").order("language_code",{ascending:!0});s&&m(s);const{data:n}=yield v.from("profiles").select("preferred_translation_language").eq("id",r.id).single();n!=null&&n.preferred_translation_language&&d(n.preferred_translation_language)}catch(s){console.error("Error loading language preferences:",s),p({title:"Erreur",description:"Impossible de charger les langues disponibles",variant:"destructive"})}finally{a(!1)}}))()},[r==null?void 0:r.id,p]);const N=t=>g(void 0,null,function*(){var s;if(t!==l){f(!0);try{const{error:n}=yield v.from("profiles").update({preferred_translation_language:t}).eq("id",r.id);if(n)throw n;d(t);try{localStorage.setItem("preferredLanguage",t)}catch(_){console.error("Error updating localStorage:",_)}p({title:"Succ√®s",description:`Langue de traduction d√©finie √† ${((s=i.find(_=>_.language_code===t))==null?void 0:s.language_name)||t.toUpperCase()}`})}catch(n){console.error("Error updating language preference:",n),p({title:"Erreur",description:"Impossible de mettre √† jour la langue pr√©f√©r√©e",variant:"destructive"})}finally{f(!1)}}});return x?e.jsx("div",{className:"flex items-center justify-center p-6",children:e.jsx(w,{className:"w-5 h-5 animate-spin"})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(M,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"font-semibold",children:"Langue de traduction"})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"S√©lectionnez votre langue pr√©f√©r√©e pour les traductions des exercices. Vous pourrez toujours basculer vers le fran√ßais en cours d'exercice."}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:i.map(t=>e.jsxs("button",{onClick:()=>N(t.language_code),disabled:c,className:`
              relative p-3 rounded-lg border-2 transition-all
              ${l===t.language_code?"border-primary bg-primary/10":"border-border hover:border-primary"}
              disabled:opacity-50 disabled:cursor-not-allowed
            `,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium text-sm",children:t.language_name||t.language_code.toUpperCase()}),l===t.language_code&&!c&&e.jsx(B,{className:"w-4 h-4 text-primary"}),l===t.language_code&&c&&e.jsx(w,{className:"w-4 h-4 animate-spin text-primary"})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:t.language_code.toUpperCase()})]},t.language_code))}),e.jsx("div",{className:"mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-900",children:["üí° ",e.jsx("strong",{children:"Astuce :"})," Dans les exercices, cliquez sur le bouton üåê pour basculer entre le fran√ßais et votre langue pr√©f√©r√©e."]})})]})},se=()=>{const{currentUser:r,logout:p}=S(),x=D(),{toast:a}=E(),[c,f]=b.useState(!1),[l,d]=b.useState(""),[i,m]=b.useState(null),[N,t]=b.useState(!0),[s,n]=b.useState(!1),[_,C]=b.useState(!1);if(!r)return e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(w,{className:"h-12 w-12 animate-spin text-primary"})});b.useEffect(()=>{(()=>g(void 0,null,function*(){try{if(t(!0),r.assigned_trainer_id){const{data:u,error:y}=yield v.from("profiles").select("id, first_name, pseudo, trainer_code").eq("id",r.assigned_trainer_id).single();if(y)throw y;m(u)}}catch(u){console.error("Erreur lors du chargement du profil du formateur:",u)}finally{t(!1)}}))()},[r.assigned_trainer_id]);const I=o=>g(void 0,null,function*(){if(o.preventDefault(),!l.trim()){a({title:"Code requis",description:"Veuillez entrer le code du formateur.",variant:"destructive"});return}n(!0);try{const{data:u,error:y}=yield v.from("profiles").select("id, first_name, pseudo, trainer_code").eq("trainer_code",l.toUpperCase()).eq("role","formateur").single();if(y||!u){a({title:"Formateur non trouv√©",description:"Aucun formateur ne correspond √† ce code.",variant:"destructive"});return}const{error:z}=yield v.from("profiles").update({assigned_trainer_id:u.id}).eq("id",r.id);if(z)throw z;m(u),d(""),C(!1),a({title:"Succ√®s!",description:`Vous avez √©t√© li√© au formateur ${u.first_name}`})}catch(u){console.error("Erreur:",u),a({title:"Erreur de liaison",description:u.message,variant:"destructive"})}finally{n(!1)}}),T=()=>g(void 0,null,function*(){try{const{error:o}=yield v.from("profiles").update({assigned_trainer_id:null}).eq("id",r.id);if(o)throw o;m(null),a({title:"Succ√®s!",description:"Vous avez √©t√© d√©li√© du formateur"})}catch(o){console.error("Erreur:",o),a({title:"Erreur",description:o.message,variant:"destructive"})}}),k=(o,u)=>{navigator.clipboard.writeText(o).then(()=>{a({title:`${u} copi√© !`,description:`${o} a √©t√© copi√© dans le presse-papiers.`})}).catch(y=>{a({title:"Erreur de copie",description:`Impossible de copier : ${y}`,variant:"destructive"})})},U=()=>g(void 0,null,function*(){f(!0);try{yield p(),x("/"),a({title:"D√©connexion r√©ussie",description:"Vous avez √©t√© d√©connect√©."})}catch(o){a({title:"Erreur de d√©connexion",description:o.message,variant:"destructive"}),f(!1)}});return e.jsx("div",{className:"container mx-auto px-4 py-8 max-w-2xl",children:e.jsxs(A,{className:"w-full shadow-xl border-primary/20",children:[e.jsxs(F,{children:[e.jsxs($,{className:"text-3xl font-bold text-primary flex items-center",children:[e.jsx(V,{className:"mr-3 h-8 w-8"}),"Mon Compte Apprenant"]}),e.jsx(R,{children:"Voici vos informations personnelles. Gardez votre code secret en s√©curit√©."})]}),e.jsxs(G,{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center p-4 bg-muted/50 rounded-lg border",children:[e.jsx(V,{className:"h-6 w-6 text-muted-foreground mr-4"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Votre Pr√©nom"}),e.jsx("p",{className:"text-xl font-semibold",children:r.first_name})]}),e.jsx(h,{variant:"ghost",size:"icon",className:"ml-auto",onClick:()=>k(r.first_name,"Pr√©nom"),children:e.jsx(q,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Donnez votre avis"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"Votre retour nous aide √† am√©liorer l'application. Ce questionnaire est court et anonyme."}),e.jsx(W,{onSubmitted:()=>g(void 0,null,function*(){})})]}),e.jsxs("div",{className:"flex items-center p-4 bg-muted/50 rounded-lg border",children:[e.jsx(H,{className:"h-6 w-6 text-muted-foreground mr-4"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Votre Code Secret (mot de passe)"}),e.jsx("p",{className:"text-2xl font-bold tracking-wider",children:r.learner_code})]}),e.jsx(h,{variant:"ghost",size:"icon",className:"ml-auto",onClick:()=>k(r.learner_code,"Code Secret"),children:e.jsx(q,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"border-t pt-6",children:e.jsx(Z,{})}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 flex items-center gap-2",children:[e.jsx(L,{className:"h-5 w-5"}),"Liaison Formateur"]}),N?e.jsxs("div",{className:"flex items-center justify-center p-4",children:[e.jsx(w,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{className:"ml-2",children:"Chargement du profil formateur..."})]}):i?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-sm text-green-700 font-medium",children:"Vous √™tes li√© au formateur :"}),e.jsxs("p",{className:"text-lg font-semibold text-green-900",children:[i.first_name," (",i.pseudo,")"]})]}),e.jsx(h,{variant:"destructive",size:"sm",onClick:T,className:"w-full",children:"Se d√©lier du formateur"})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Vous n'√™tes pas li√© √† un formateur. Entrez le code du formateur pour l'ajouter."}),_?e.jsxs("form",{onSubmit:I,className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 block mb-2",children:"Code du Formateur"}),e.jsx("input",{type:"text",value:l,onChange:o=>d(o.target.value.toUpperCase()),placeholder:"Ex: US5785",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent",disabled:s}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Le code du formateur se trouve dans son compte"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{type:"submit",disabled:s,className:"flex-1",children:s?e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"mr-2 h-4 w-4 animate-spin"}),"Liaison..."]}):e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Lier"]})}),e.jsx(h,{type:"button",variant:"outline",onClick:()=>{C(!1),d("")},disabled:s,children:"Annuler"})]})]}):e.jsxs(h,{onClick:()=>C(!0),className:"w-full",variant:"outline",children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Lier un formateur"]})]})]})]}),e.jsx(O,{children:e.jsxs(h,{variant:"destructive",className:"w-full",onClick:U,disabled:c,children:[c?e.jsx(w,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(K,{className:"mr-2 h-4 w-4"}),"Se d√©connecter"]})})]})})};export{se as default};
