var f=(a,i,n)=>new Promise((m,r)=>{var b=o=>{try{x(n.next(o))}catch(p){r(p)}},u=o=>{try{x(n.throw(o))}catch(p){r(p)}},x=o=>o.done?m(o.value):Promise.resolve(o.value).then(b,u);x((n=n.apply(a,i)).next())});import{j as e}from"./radix-ui-2f58371e.js";import{r as d,e as A}from"./react-vendor-6cf6ded9.js";import{s as N,i as R,u as F,aR as C,C as z,k as O,l as q,w as B,j as H,aS as I,al as P}from"./index-426aa6f1.js";import{S as K}from"./switch-f7f54a7b.js";import{T as U,a as G,b as g,c as L,d as J,e as y}from"./table-8f722342.js";import{S as Q}from"./scroll-area-8a7e81aa.js";import{S as W,a as X,b as Y,c as Z,d as M}from"./select-6c123d42.js";import{t as V,f as ee,a1 as se,a0 as re}from"./ui-icons-e73ce4f7.js";import"./supabase-4b7d20da.js";import"./index-cc17d877.js";import"./index-d203b311.js";const ie=a=>f(void 0,null,function*(){if(!a)return new Map;const{data:i,error:n}=yield N.from("learner_visibility").select("task_id, version_id, is_visible").eq("learner_id",a);if(n)throw console.error("Erreur lors de la récupération des paramètres de visibilité :",n),n;const m=new Map;return i&&i.forEach(r=>{if(r.task_id&&r.version_id){const b=`${r.task_id}-${r.version_id}`;m.set(b,r.is_visible)}}),m}),te=(a,i,n,m)=>f(void 0,null,function*(){if(!a||!i||!n)throw new Error("Les IDs de l'apprenant, de la tâche et de la version sont requis.");if(m){const{error:r}=yield N.from("learner_visibility").delete().match({learner_id:a,task_id:i,version_id:n});if(r)throw console.error("Erreur lors de la suppression de l'exception de visibilité :",r),r}else{const{error:r}=yield N.from("learner_visibility").upsert({learner_id:a,task_id:i,version_id:n,is_visible:!1},{onConflict:"learner_id, task_id, version_id",ignoreDuplicates:!1});if(r)throw console.error("Erreur lors de la définition de la visibilité :",r),r}return{success:!0}}),be=()=>{const{toast:a}=R(),{currentUser:i}=F(),[n,m]=d.useState([]),[r,b]=d.useState([]),[u,x]=d.useState(null),[o,p]=d.useState(new Map),[k,S]=d.useState(!0),[D,_]=d.useState(!1),E=d.useCallback(s=>f(void 0,null,function*(){if(s){_(!0);try{const l=yield ie(s);p(l)}catch(l){a({title:"Erreur",description:"Impossible de charger les données de visibilité de l'apprenant.",variant:"destructive"})}finally{_(!1)}}}),[a]);d.useEffect(()=>{const s=()=>f(void 0,null,function*(){S(!0);try{const[l,t]=yield Promise.all([I(),P(i.id)]);if(m(l||[]),b(t||[]),t&&t.length>0){const c=t[0].id;x(c)}}catch(l){console.error("Error loading initial data:",l),a({title:"Erreur de chargement",description:"Impossible de charger les données du tableau de bord.",variant:"destructive"})}finally{S(!1)}});i!=null&&i.id&&s()},[i,a]),d.useEffect(()=>{u&&E(u)},[u,E]);const $=(s,l,t)=>f(void 0,null,function*(){if(!u)return;const c=`${s}-${l}`,w=o.get(c)!==!1;p(j=>{const h=new Map(j);return h.set(c,t),h});try{yield te(u,s,l,t),a({title:"Visibilité de l'exercice modifiée."})}catch(j){p(h=>{const v=new Map(h);return v.set(c,w),v}),a({title:"Erreur",description:"Impossible de modifier la visibilité.",variant:"destructive"})}}),T=d.useMemo(()=>(n||[]).reduce((s,l)=>{const t=l.category||"Non Catégorisé";return s[t]||(s[t]=[]),s[t].push(l),s},{}),[n]);return!i||i.role!==C.TRAINER&&i.role!==C.ADMIN?e.jsx("p",{className:"p-4 text-center text-destructive",children:"Accès non autorisé."}):k?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(V,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs(z,{className:"w-full",children:[e.jsxs(O,{children:[e.jsx(q,{children:"Tableau de Bord Formateur"}),e.jsx(B,{children:"Suivez les progrès et gérez la visibilité des exercices pour chaque apprenant."})]}),e.jsxs(H,{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"learner-select",className:"text-sm font-medium",children:"Sélectionner un apprenant"}),e.jsxs(W,{value:u||"",onValueChange:x,children:[e.jsx(X,{id:"learner-select",className:"w-full sm:w-[300px]",children:e.jsx(Y,{placeholder:"Choisissez un apprenant..."})}),e.jsx(Z,{children:r.length>0?r.map(s=>e.jsx(M,{value:s.id,children:s.first_name||`Apprenant ${s.learner_code}`},s.id)):e.jsx(M,{value:"none",disabled:!0,children:"Aucun apprenant lié"})})]})]}),e.jsx(Q,{className:"h-[600px] w-full",children:D?e.jsx("div",{className:"flex justify-center items-center h-96",children:e.jsx(V,{className:"h-8 w-8 animate-spin text-primary"})}):u?e.jsxs(U,{children:[e.jsx(G,{children:e.jsxs(g,{children:[e.jsx(L,{className:"w-[400px]",children:"Tâche / Version"}),e.jsx(L,{className:"text-center",children:"Visibilité"})]})}),e.jsx(J,{children:Object.keys(T).length>0?Object.entries(T).map(([s,l])=>e.jsxs(A.Fragment,{children:[e.jsx(g,{className:"bg-muted/50 hover:bg-muted/60",children:e.jsx(y,{colSpan:2,className:"font-semibold text-primary",children:s})}),l.map(t=>(t.versions||[]).map((c,w)=>{const j=`${t.id}-${c.id}`,h=o.get(j)!==!1;return e.jsxs(g,{className:`border-l-4 ${h?"border-green-200":"border-red-200"} hover:bg-slate-50`,children:[e.jsxs(y,{className:"pl-6 text-sm",children:[w===0&&e.jsx("div",{className:"font-medium pb-1",children:t.title}),e.jsx("div",{className:"pl-4 text-muted-foreground",children:c.name})]}),e.jsx(y,{className:"text-center",children:e.jsxs("div",{className:"flex items-center justify-center space-x-2",children:[e.jsx(K,{checked:h,onCheckedChange:v=>$(t.id,c.id,v),"aria-label":`Visibilité de l'exercice ${c.name}`}),h?e.jsx(se,{className:"h-4 w-4 text-green-500"}):e.jsx(re,{className:"h-4 w-4 text-red-500"})]})})]},c.id)}))]},s)):e.jsx(g,{children:e.jsx(y,{colSpan:"2",className:"text-center text-muted-foreground h-48",children:"Aucune tâche à afficher."})})})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-96 text-muted-foreground",children:[e.jsx(ee,{className:"h-12 w-12 mb-4"}),e.jsx("p",{children:"Veuillez sélectionner un apprenant pour gérer la visibilité des exercices."})]})})]})]})};export{be as default};
