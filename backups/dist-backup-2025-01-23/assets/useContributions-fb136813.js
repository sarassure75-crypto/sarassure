var q=Object.defineProperty,E=Object.defineProperties;var C=Object.getOwnPropertyDescriptors;var _=Object.getOwnPropertySymbols;var S=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable;var h=(r,t,s)=>t in r?q(r,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[t]=s,y=(r,t)=>{for(var s in t||(t={}))S.call(t,s)&&h(r,s,t[s]);if(_)for(var s of _(t))k.call(t,s)&&h(r,s,t[s]);return r},v=(r,t)=>E(r,C(t));var i=(r,t,s)=>new Promise((e,o)=>{var a=c=>{try{f(s.next(c))}catch(m){o(m)}},l=c=>{try{f(s.throw(c))}catch(m){o(m)}},f=c=>c.done?e(c.value):Promise.resolve(c.value).then(a,l);f((s=s.apply(r,t)).next())});import{r as g}from"./react-vendor-6cf6ded9.js";import{s as n}from"./index-426aa6f1.js";import{e as j}from"./imagesMetadata-470e1c8a.js";function x(r,t,s){return i(this,null,function*(){try{const{data:e,error:o}=yield n.from("contributions").insert([{contributor_id:r,type:t,content:s,status:"draft"}]).select().single();if(o)throw o;return{success:!0,data:e}}catch(e){return console.error("Error creating contribution:",e),{success:!1,error:e.message}}})}function P(r,t){return i(this,null,function*(){try{const{data:s,error:e}=yield n.from("contributions").update(t).eq("id",r).eq("status","draft").select().single();if(e)throw e;return{success:!0,data:s}}catch(s){return console.error("Error updating contribution:",s),{success:!1,error:s.message}}})}function D(r){return i(this,null,function*(){try{const{data:t,error:s}=yield n.from("contributions").update({status:"pending",submitted_at:new Date().toISOString()}).eq("id",r).select().single();if(s)throw s;return{success:!0,data:t}}catch(t){return console.error("Error submitting contribution:",t),{success:!1,error:t.message}}})}function L(){return i(this,arguments,function*(r={}){try{let t=n.from("contributions").select(`
        *,
        contributor:contributor_id (
          id,
          email,
          first_name,
          last_name
        )
      `).eq("status","pending");r.type&&(t=t.eq("type",r.type)),t=t.order("submitted_at",{ascending:!0});const{data:s,error:e}=yield t;if(e)throw e;return{success:!0,data:s}}catch(t){return console.error("Error fetching pending contributions:",t),{success:!1,error:t.message}}})}function I(r,t,s=null){return i(this,null,function*(){try{const e={status:"approved",reviewed_by:t,reviewed_at:new Date().toISOString()};s&&(e.admin_modifications=s,e.content=s.modifiedContent);const{data:o,error:a}=yield n.from("contributions").update(e).eq("id",r).select().single();if(a)throw a;if(o.type==="exercise"){const l=yield A(o);l.success||console.error("Error publishing task:",l.error)}return{success:!0,data:o}}catch(e){return console.error("Error approving contribution:",e),{success:!1,error:e.message}}})}function O(r,t,s){return i(this,null,function*(){try{const{data:e,error:o}=yield n.from("contributions").update({status:"rejected",reviewed_by:t,reviewed_at:new Date().toISOString(),rejection_reason:s}).eq("id",r).select().single();if(o)throw o;return{success:!0,data:e}}catch(e){return console.error("Error rejecting contribution:",e),{success:!1,error:e.message}}})}function A(r){return i(this,null,function*(){try{const t=v(y({},r.content),{contributor_id:r.contributor_id,contribution_id:r.id,is_community_content:!0,original_contributor:r.contributor_id,created_by:r.reviewed_by,is_visible:!0}),{data:s,error:e}=yield n.from("tasks").insert([t]).select().single();if(e)throw e;return yield n.from("contributions").update({published_task_id:s.id}).eq("id",r.id),{success:!0,data:s}}catch(t){return console.error("Error publishing contribution as task:",t),{success:!1,error:t.message}}})}function R(r,t="version",s=null){return i(this,null,function*(){try{let e;if(t==="image"){const o=yield j(r,s);if(!o.success)throw new Error(o.error)}else if(t==="draft"){const{error:o}=yield n.from("tasks").delete().eq("id",r);e=o}else{const{data:o,error:a}=yield n.from("versions").select("task_id").eq("id",r).single();if(a)throw a;const l=o==null?void 0:o.task_id,{error:f}=yield n.from("versions").delete().eq("id",r);if(f)throw f;if(l){const{data:c}=yield n.from("versions").select("id").eq("task_id",l);if(!c||c.length===0){const{error:m}=yield n.from("tasks").delete().eq("id",l);if(m)throw m}}}if(e)throw e;return{success:!0}}catch(e){return console.error("Error deleting contribution:",e),{success:!1,error:e.message}}})}function z(r){return i(this,null,function*(){try{const{data:t}=yield n.from("tasks").select("id").eq("owner_id",r),s=(t==null?void 0:t.map(w=>w.id))||[],{data:e}=yield n.from("versions").select("id, creation_status").in("task_id",s),o=(e==null?void 0:e.filter(w=>w.creation_status==="validated").length)||0,a=(e==null?void 0:e.filter(w=>w.creation_status==="pending").length)||0,l=(e==null?void 0:e.filter(w=>w.creation_status==="rejected").length)||0,f=o+a,{count:c}=yield n.from("images_metadata").select("id",{count:"exact",head:!0}).eq("uploaded_by",r),{count:m}=yield n.from("images_metadata").select("id",{count:"exact",head:!0}).eq("uploaded_by",r).eq("moderation_status","approved"),{count:u}=yield n.from("images_metadata").select("id",{count:"exact",head:!0}).eq("uploaded_by",r).eq("moderation_status","pending"),{count:d}=yield n.from("images_metadata").select("id",{count:"exact",head:!0}).eq("uploaded_by",r).eq("moderation_status","rejected"),{count:b}=yield n.from("tasks").select("id",{count:"exact",head:!0}),{count:p}=yield n.from("images_metadata").select("id",{count:"exact",head:!0});return{success:!0,data:{exercises:{total:f,approved:o,pending:a,rejected:l},images:{total:c||0,approved:m||0,pending:u||0,rejected:d||0},global:{total_exercises:b||0,total_images:p||0},total_contributions:f+(c||0),approved_contributions:o+(m||0),pending_contributions:a+(u||0),rejected_contributions:l+(d||0),images_uploaded:c||0,images_approved:m||0}}}catch(t){return console.error("Error fetching contributor stats:",t),{success:!1,error:t.message}}})}function B(){return i(this,null,function*(){try{const{count:r,error:t}=yield n.from("contributions").select("*",{count:"exact",head:!0}).eq("status","pending");if(t)throw t;return{success:!0,count:r}}catch(r){return console.error("Error counting pending contributions:",r),{success:!1,error:r.message,count:0}}})}function M(r){const[t,s]=g.useState(null),[e,o]=g.useState(!0),[a,l]=g.useState(null),f=g.useCallback(()=>i(this,null,function*(){o(!0),l(null);const c=yield z(r);c.success?s(c.data):l(c.error),o(!1)}),[r]);return g.useEffect(()=>{r&&f()},[r,f]),{stats:t,loading:e,error:a,refresh:f}}function N(r={}){const[t,s]=g.useState([]),[e,o]=g.useState(!0),[a,l]=g.useState(null),[f,c]=g.useState(0),m=g.useCallback(()=>i(this,null,function*(){o(!0),l(null);const u=yield L(r);u.success?(s(u.data),c(u.data.length)):l(u.error),o(!1)}),[r]);return g.useEffect(()=>{m()},[m]),{contributions:t,count:f,loading:e,error:a,refresh:m}}function Q(){const[r,t]=g.useState(!1),[s,e]=g.useState(null);return{loading:r,error:s,create:(u,d,b)=>i(this,null,function*(){t(!0),e(null);const p=yield x(u,d,b);return t(!1),p.success||e(p.error),p}),update:(u,d)=>i(this,null,function*(){t(!0),e(null);const b=yield P(u,d);return t(!1),b.success||e(b.error),b}),submit:u=>i(this,null,function*(){t(!0),e(null);const d=yield D(u);return t(!1),d.success||e(d.error),d}),remove:u=>i(this,null,function*(){t(!0),e(null);const d=yield R(u);return t(!1),d.success||e(d.error),d}),approve:(u,d,b=null)=>i(this,null,function*(){t(!0),e(null);const p=yield I(u,d,b);return t(!1),p.success||e(p.error),p}),reject:(u,d,b)=>i(this,null,function*(){t(!0),e(null);const p=yield O(u,d,b);return t(!1),p.success||e(p.error),p})}}function T(){const[r,t]=g.useState(0),[s,e]=g.useState(!0),o=()=>i(this,null,function*(){e(!0);const a=yield B();a.success&&t(a.count),e(!1)});return g.useEffect(()=>{o();const a=setInterval(o,3e4);return()=>clearInterval(a)},[]),{count:r,loading:s,refresh:o}}export{Q as a,N as b,T as c,M as u};
