var Y=(l,s,r)=>new Promise((N,p)=>{var f=i=>{try{x(r.next(i))}catch(d){p(d)}},u=i=>{try{x(r.throw(i))}catch(d){p(d)}},x=i=>i.done?N(i.value):Promise.resolve(i.value).then(f,u);x((r=r.apply(l,s)).next())});import{j as e}from"./radix-ui-2f58371e.js";import{r as h,f as ae}from"./react-vendor-6cf6ded9.js";import{aX as a,s as o,u as le,aB as ie}from"./index-426aa6f1.js";import{A as oe}from"./AdminTabNavigation-8abb78e2.js";import{H as ne,a6 as F,I as Z,a9 as P,c as de,l as ce,aK as me,q as D}from"./ui-icons-e73ce4f7.js";import"./supabase-4b7d20da.js";function xe(l){const[s,r]=h.useState(null),[N,p]=h.useState(null),[f,u]=h.useState(!0),[x,i]=h.useState(null),d=h.useCallback(()=>Y(this,null,function*(){try{u(!0),i(null),a.log("Loading admin data for adminId:",l);const{data:g}=yield o.from("profiles").select("id, email, role").eq("id",l).single();a.log("Admin profile:",g);const{data:c,error:_}=yield o.from("tasks").select("id").eq("owner_id",l);if(_)throw a.error("Tasks error:",_),_;a.log("Admin tasks loaded:",(c==null?void 0:c.length)||0);const v=(c==null?void 0:c.map(t=>t.id))||[];let b=0;if(v.length>0){const{count:t,error:m}=yield o.from("versions").select("id",{count:"exact",head:!0}).in("task_id",v);m?a.error("Versions error:",m):(b=t||0,a.log("Admin versions count (all, no status filter):",b))}const{count:j,error:q}=yield o.from("app_images").select("id",{count:"exact",head:!0}).is("user_id",null);q&&a.error("Admin images (app_images) error:",q),a.log("Admin images count (from app_images with user_id=null):",j||0);const{data:ee}=yield o.from("app_images").select("id, file_path, user_id, created_at").is("user_id",null).limit(3);a.log("Sample admin images (app_images):",ee);const{count:I,error:V}=yield o.from("profiles").select("id",{count:"exact",head:!0}).eq("role","contributor");V&&a.error("Contributors error:",V),a.log("Contributors count:",I||0),a.log("ðŸ” DEBUGGING: Checking the problematic version 8f637b93-22a5-474d-8805-fb06f46356b3");const{data:w}=yield o.from("versions").select(`
          id,
          creation_status,
          task_id,
          tasks(id, owner_id, title)
        `).eq("id","8f637b93-22a5-474d-8805-fb06f46356b3").single();if(a.log("Problem version:",w),w!=null&&w.task_id){const{data:t}=yield o.from("tasks").select("id, owner_id, title").eq("id",w.task_id).single();a.log("Problem task:",t)}const{data:te}=yield o.from("profiles").select("id, username, email").neq("id",l).limit(5);a.log("Non-admin users:",te);const{data:E}=yield o.from("tasks").select("id, title, owner_id").limit(10);a.log("All tasks (first 10):",E==null?void 0:E.map(t=>({id:t.id,title:t.title,owner_id:t.owner_id,is_admin:t.owner_id===l})));const{data:n,error:L}=yield o.from("versions").select(`
          id,
          creation_status,
          task_id,
          user_id
        `);L&&a.error("All versions error:",L),a.log("ðŸ” RAW versions data (first 5):",n==null?void 0:n.slice(0,5).map(t=>({id:t.id,creation_status:t.creation_status,user_id:t.user_id,is_admin:t.user_id===l}))),a.log("All versions data:",(n==null?void 0:n.length)||0),a.log("AdminId for filtering:",l);const T=(n==null?void 0:n.filter(t=>t.creation_status==="validated"))||[];a.log("ðŸ” ALL VALIDATED VERSIONS:",T.length),T.forEach(t=>{a.log(`Version ${t.id}:`,{creation_status:t.creation_status,user_id:t.user_id,is_admin_owned:t.user_id===l,adminId:l})});const $=(n==null?void 0:n.filter(t=>{const m=t.creation_status==="validated",Q=t.user_id&&t.user_id!==l;return m&&a.log(`âœ… Validated version ${t.id}:`,{creation_status:t.creation_status,user_id:t.user_id,is_admin:t.user_id===l,shouldInclude:m&&Q}),m&&Q}))||[],C=$.length;a.log("ðŸŽ¯ FINAL Contributor validated versions count:",C),a.log("ðŸŽ¯ Contributor versions details:",$.map(t=>{var m;return{id:t.id,task_owner:(m=t.tasks)==null?void 0:m.owner_id}}));const{data:k,error:G}=yield o.from("images_metadata").select("id, uploaded_by, moderation_status");G&&a.error("All images error:",G);const R=((k==null?void 0:k.filter(t=>t.uploaded_by!==l&&t.moderation_status==="approved"))||[]).length;a.log("Contributor validated images count:",R);const{data:A,error:z}=yield o.from("contributor_revenue_summary").select("*");z&&a.error("Revenue error:",z),a.log("All revenue data:",A);let S=0,M=0,U=0,B=0,H=0,K=0;A&&A.length>0&&A.forEach(t=>{S+=t.total_revenue_cents||0,M+=t.total_sales_count||0,U+=t.exercise_sales_count||0,B+=t.exercise_revenue_cents||0,H+=t.image_sales_count||0,K+=t.image_revenue_cents||0});const se=Math.floor(S/1e5),O=b+C,W=j+R,re=O+W,X={exercises:{total:b,approved:0,pending:0},images:{total:j,approved:0,pending:0},global:{total_exercises:O,total_images:W,total_content:re},contributors:{count:I||0,versions:C,images:R}},J={exercise_sales_count:U,exercise_revenue_cents:B,image_sales_count:H,image_revenue_cents:K,total_revenue_cents:S,total_sales_count:M,milestone_count:se};a.log("Final stats:",X),a.log("Final revenue:",J),r(X),p(J)}catch(g){a.error("Error loading admin data:",g),i(g.message)}finally{u(!1)}}),[l]);h.useEffect(()=>{l&&d()},[l,d]);const y=h.useCallback(()=>{d()},[d]);return{stats:s,revenue:N,loading:f,error:x,refresh:y}}function Ne(){var f,u,x,i,d,y,g,c,_,v,b,j;ae();const{currentUser:l}=le(),{stats:s,revenue:r,loading:N}=xe(l==null?void 0:l.id),{counters:p}=ie();return N?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"container mx-auto p-4",children:[e.jsx("div",{className:"bg-white rounded-lg border shadow-sm mb-6",children:e.jsxs("div",{className:"flex flex-col space-y-1.5 p-6",children:[e.jsxs("h3",{className:"flex items-center text-3xl font-semibold leading-none tracking-tight",children:[e.jsx(ne,{className:"mr-3 h-8 w-8 text-primary"}),"Administration - Revenus"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Statistiques de vos contributions et revenus gÃ©nÃ©rÃ©s par la plateforme"})]})}),e.jsx(oe,{counters:p}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow border border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-gray-600 text-sm font-medium",children:"Exercices: nombre de versions"}),e.jsx(F,{className:"w-5 h-5 text-blue-600"})]}),e.jsx("p",{className:"text-3xl font-bold text-gray-900",children:((f=s==null?void 0:s.exercises)==null?void 0:f.total)||0}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"CrÃ©Ã©es par l'administration"})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow border border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-gray-600 text-sm font-medium",children:"Images"}),e.jsx(Z,{className:"w-5 h-5 text-purple-600"})]}),e.jsx("p",{className:"text-3xl font-bold text-gray-900",children:((u=s==null?void 0:s.images)==null?void 0:u.total)||0}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"CrÃ©Ã©es par l'administration"})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow border border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-gray-600 text-sm font-medium",children:"Total Contributions Admin"}),e.jsx(F,{className:"w-5 h-5 text-green-600"})]}),e.jsx("p",{className:"text-3xl font-bold text-gray-900",children:(((x=s==null?void 0:s.exercises)==null?void 0:x.total)||0)+(((i=s==null?void 0:s.images)==null?void 0:i.total)||0)}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"CrÃ©Ã©es par l'administration"})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow border border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-gray-600 text-sm font-medium",children:"Sur la plateforme"}),e.jsx(P,{className:"w-5 h-5 text-orange-600"})]}),e.jsx("p",{className:"text-3xl font-bold text-gray-900",children:((d=s==null?void 0:s.global)==null?void 0:d.total_content)||0}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:[((y=s==null?void 0:s.global)==null?void 0:y.total_exercises)||0," exercices â€¢ ",((g=s==null?void 0:s.global)==null?void 0:g.total_images)||0," images"]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-indigo-100 p-6 rounded-lg shadow border border-blue-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-blue-900 text-sm font-medium",children:"Contributeurs"}),e.jsx(de,{className:"w-5 h-5 text-blue-600"})]}),e.jsx("p",{className:"text-3xl font-bold text-blue-900",children:((c=s==null?void 0:s.contributors)==null?void 0:c.count)||0}),e.jsx("p",{className:"text-xs text-blue-700 mt-2",children:"Actifs sur la plateforme"})]}),e.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-pink-100 p-6 rounded-lg shadow border border-purple-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-purple-900 text-sm font-medium",children:"Exercices contributeurs"}),e.jsx(F,{className:"w-5 h-5 text-purple-600"})]}),e.jsx("p",{className:"text-3xl font-bold text-purple-900",children:((_=s==null?void 0:s.contributors)==null?void 0:_.versions)||0}),e.jsx("p",{className:"text-xs text-purple-700 mt-2",children:"Versions validÃ©es"})]}),e.jsxs("div",{className:"bg-gradient-to-br from-green-50 to-emerald-100 p-6 rounded-lg shadow border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-green-900 text-sm font-medium",children:"Images contributeurs"}),e.jsx(Z,{className:"w-5 h-5 text-green-600"})]}),e.jsx("p",{className:"text-3xl font-bold text-green-900",children:((v=s==null?void 0:s.contributors)==null?void 0:v.images)||0}),e.jsx("p",{className:"text-xs text-green-700 mt-2",children:"Images crÃ©Ã©es par contributeurs"})]})]}),r&&e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"ðŸ’° Revenus Plateforme"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow border border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-600",children:"Licences vendues"}),e.jsx(ce,{className:"w-5 h-5 text-blue-600"})]}),e.jsx("p",{className:"text-3xl font-bold text-gray-900",children:r.total_sales_count||0}),e.jsxs("div",{className:"text-xs text-gray-500 mt-2 space-y-1",children:[e.jsxs("p",{children:["ðŸ“š Exercices: ",r.exercise_sales_count||0]}),e.jsxs("p",{children:["ðŸ–¼ï¸ Images: ",r.image_sales_count||0]})]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-emerald-50 to-teal-100 p-6 rounded-lg shadow border border-emerald-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-emerald-900",children:"Revenus gÃ©nÃ©rÃ©s"}),e.jsx(P,{className:"w-5 h-5 text-emerald-600"})]}),e.jsxs("p",{className:"text-3xl font-bold text-emerald-900",children:["â‚¬",((r.total_revenue_cents||0)/100).toFixed(2)]}),e.jsxs("div",{className:"text-xs text-emerald-600 mt-2 space-y-1",children:[e.jsxs("p",{children:["ðŸ“š â‚¬",((r.exercise_revenue_cents||0)/100).toFixed(2)]}),e.jsxs("p",{children:["ðŸ–¼ï¸ â‚¬",((r.image_revenue_cents||0)/100).toFixed(2)]})]})]}),e.jsxs("div",{className:"bg-gradient-to-br from-amber-50 to-orange-100 p-6 rounded-lg shadow border border-amber-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-amber-900",children:"Palier atteint"}),e.jsx(me,{className:"w-5 h-5 text-amber-600"})]}),e.jsxs("p",{className:"text-3xl font-bold text-amber-900",children:["Palier ",r.milestone_count||0]}),e.jsx("p",{className:"text-xs text-amber-600 mt-2",children:(r.milestone_count||0)>0?`${r.milestone_count} Ã— â‚¬1000`:"Aucun palier atteint"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-indigo-100 p-6 rounded-lg shadow border border-blue-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-blue-900",children:"Revenus Plateforme (80%)"}),e.jsx(D,{className:"w-6 h-6 text-blue-600"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("p",{className:"text-4xl font-bold text-blue-900",children:["â‚¬",((r.total_revenue_cents||0)*.8/100).toFixed(2)]}),e.jsxs("p",{className:"text-sm text-blue-700 mt-2",children:["Sur â‚¬",((r.total_revenue_cents||0)/100).toFixed(2)," de ventes totales"]})]}),e.jsx("div",{className:"bg-blue-100 rounded-lg p-3",children:e.jsx("p",{className:"text-xs text-blue-800",children:"ðŸ’¡ La plateforme conserve 80% des revenus pour la maintenance, l'hÃ©bergement et le dÃ©veloppement. 20% sont reversÃ©s aux contributeurs."})})]}),e.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-pink-100 p-6 rounded-lg shadow border border-purple-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-purple-900",children:"Prochain palier (â‚¬1000)"}),e.jsx(P,{className:"w-6 h-6 text-purple-600"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"w-full bg-purple-200 rounded-full h-4 mb-2",children:e.jsx("div",{className:"bg-purple-600 h-4 rounded-full transition-all duration-500 flex items-center justify-end pr-2",style:{width:`${Math.min((r.total_revenue_cents||0)%1e5/1e5*100,100)}%`},children:(r.total_revenue_cents||0)%1e5/1e5*100>10&&e.jsxs("span",{className:"text-xs font-bold text-white",children:[Math.round((r.total_revenue_cents||0)%1e5/1e5*100),"%"]})})}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-purple-700 font-medium",children:["â‚¬",((r.total_revenue_cents||0)%1e5/100).toFixed(2)]}),e.jsxs("span",{className:"text-purple-600",children:["Restant: â‚¬",((((r.milestone_count||0)+1)*1e5-(r.total_revenue_cents||0))/100).toFixed(2)]})]})]}),e.jsx("p",{className:"text-xs text-purple-600",children:(r.milestone_count||0)===0?"ðŸŽ¯ Atteignez â‚¬1000 pour dÃ©bloquer le premier palier!":`ðŸš€ Continuez pour atteindre le palier ${(r.milestone_count||0)+1}!`})]})]})]}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg shadow border border-blue-200",children:e.jsxs("div",{className:"flex items-start space-x-4",children:[e.jsx(D,{className:"w-8 h-8 text-blue-600 flex-shrink-0 mt-1"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Gestion de la plateforme"}),e.jsxs("p",{className:"text-gray-700",children:["En tant qu'administrateur, vous gÃ©rez ",(((b=s==null?void 0:s.exercises)==null?void 0:b.total)||0)+(((j=s==null?void 0:s.images)==null?void 0:j.total)||0)," contributions. La plateforme gÃ©nÃ¨re â‚¬",(((r==null?void 0:r.total_revenue_cents)||0)/100).toFixed(2)," de revenus dont â‚¬",(((r==null?void 0:r.total_revenue_cents)||0)*.8/100).toFixed(2)," pour la plateforme et â‚¬",(((r==null?void 0:r.total_revenue_cents)||0)*.2/100).toFixed(2)," reversÃ©s aux contributeurs."]})]})]})})]})}export{Ne as default};
